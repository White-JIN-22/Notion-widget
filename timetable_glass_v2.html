<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="robots" content="noindex, nofollow" />
<meta name="referrer" content="no-referrer" />
<title>Weekly Timetable (Glass Compact)</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600&display=swap');

  body {
    background: #0d0d0d;
    font-family: 'Pretendard', sans-serif;
    color: #f3f1eb;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }

  /* ğŸ«§ ë¹„ëˆ—ë°©ìš¸ ëŠë‚Œ Glass ì»¨í…Œì´ë„ˆ */
  .container {
    display: flex;
    gap: 5px;
    background: linear-gradient(145deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 22px;
    padding: 14px;
    backdrop-filter: blur(24px) saturate(180%);
    -webkit-backdrop-filter: blur(24px) saturate(180%);
    box-shadow: 0 4px 25px rgba(0,0,0,0.35);
  }

  /* ğŸ“… ê° ìš”ì¼ ì¹¸ */
  .day {
    width: 60px;
    border-radius: 16px;
    background: rgba(255, 255, 255, 0.05);
    padding: 8px 6px;
    text-align: center;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
    position: relative;
    transition: all 0.3s ease;
  }

  .day-header {
    font-size: 11px;
    font-weight: 600;
    opacity: 0.8;
    margin-bottom: 3px;
  }

  .date {
    font-size: 10px;
    opacity: 0.6;
    margin-bottom: 6px;
  }

  .day.current {
    background: rgba(243, 241, 235, 0.12);
    box-shadow: 0 0 14px rgba(243, 241, 235, 0.25);
  }

  /* ğŸŸ© ì¼ì • ë¸”ë¡ */
  .block {
    border-radius: 10px;
    margin: 2px 0;
    height: 10px;
    opacity: 0.9;
  }

  /* ğŸ¨ ìƒ‰ìƒ íŒ”ë ˆíŠ¸ */
  .work { background: #3d547f; }        /* ë„¤ì´ë¹„ */
  .health { background: #b2c0d2; }      /* ì—°íŒŒë‘ */
  .self { background: #cecbd3; }        /* ë¼ë²¤ë” ê·¸ë ˆì´ */
  .rest { background: #f3f1eb; }        /* ì•„ì´ë³´ë¦¬ */
</style>
</head>
<body>
  <div class="container" id="timetable"></div>

  <script>
    // âœ… iCloud ìº˜ë¦°ë” (í”„ë¡ì‹œ í†µí•´ ë¡œë“œ)
    const icalUrls = [
      "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxInlf0nwQRwqVQaKN3oFgWzqLUfigKhteMNDAjQwkPlHzBe_ELV5RYcePFbCOI5H3TM",
      "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIlkFT1ZEqbRVczq6PrGuVHb0Afa1EhpfGiSULTpK_tYur-eQz2Uqc74JIqfAKkjBP8",
      "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxImfGB8G7hln8RI2A4WFBMN51g9wFHOsIhQgRFNSx9Dz4_f4s6w0S4RBWQw9Fgtt2mU",
      "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIks_Phe4DHFMcJQdGTXVekoe7DfsUtHGLCLydgauhnycV_BUoW1c_GcPu0dMkd_m9I"
    ];
    const colors = ["work", "health", "self", "rest"];
    const container = document.getElementById("timetable");

    /* ğŸ“† ê³µíœ´ì¼ API */
    async function fetchHolidays(year, month) {
      const url = `https://ical-proxy.moonkelly601.workers.dev/?url=${encodeURIComponent(
        `https://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo?solYear=${year}&solMonth=${month.toString().padStart(2,"0")}&_type=json`
      )}`;
      try {
        const res = await fetch(url);
        const text = await res.text();
        const json = JSON.parse(text);
        const items = json?.response?.body?.items?.item || [];
        return items.map(i => i.locdate?.toString());
      } catch (err) {
        console.error("ê³µíœ´ì¼ ë°ì´í„° ì˜¤ë¥˜:", err);
        return [];
      }
    }

    async function fetchIcal(url) {
      const res = await fetch(url);
      return res.text();
    }

    /* ğŸ§­ iCal íŒŒì‹± (ì‹œê°„ëŒ€ í˜¸í™˜ ì¶”ê°€ë¨) */
    function parseICS(ics, index) {
      const events = [];
      const lines = ics.split("\n");
      let event = null;
      for (const line of lines) {
        if (line.startsWith("BEGIN:VEVENT")) event = {};
        else if (line.startsWith("END:VEVENT")) {
          event.priority = index;
          events.push(event);
          event = null;
        } else if (event) {
          if (line.startsWith("DTSTART")) {
            const raw = line.split(":")[1] || "";
            event.start = raw.replace("Z", "");
          }
          if (line.startsWith("DTEND")) {
            const raw = line.split(":")[1] || "";
            event.end = raw.replace("Z", "");
          }
        }
      }
      return events;
    }

    async function loadEvents() {
      const allEvents = [];

      for (let i = 0; i < icalUrls.length; i++) {
        const data = await fetchIcal(icalUrls[i]);
        const events = parseICS(data, i);
        allEvents.push(...events);
      }

      const now = new Date();
      const today = now.getDay();
      const monday = new Date(now);
      monday.setDate(now.getDate() - ((today + 6) % 7));

      const holidays = await fetchHolidays(now.getFullYear(), now.getMonth() + 1);

      for (let i = 0; i < 7; i++) {
        const day = new Date(monday);
        day.setDate(monday.getDate() + i);
        const dateKey = day.toISOString().slice(0,10).replace(/-/g,"");
        const isHoliday = holidays.includes(dateKey);

        const dayDiv = document.createElement("div");
        dayDiv.className = "day";

        const dateStr = day.toISOString().slice(5, 10).replace("-", "/");
        const dayName = ["MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN"][i];
        const colorStyle = isHoliday ? 'style="color:#ff6b6b;font-weight:600;"' : "";

        dayDiv.innerHTML = `
          <div class="date" ${colorStyle}>${dateStr}</div>
          <div class="day-header">${dayName}</div>
        `;

        if (i === (today + 6) % 7) dayDiv.classList.add("current");

        const dayStart = new Date(day);
        dayStart.setHours(0, 0, 0, 0);
        const dayEnd = new Date(day);
        dayEnd.setHours(23, 59, 59, 999);

        const dayEvents = allEvents
          .filter(e => {
            if (!e.start || !e.end) return false;
            const s = new Date(e.start.slice(0,4) + "-" + e.start.slice(4,6) + "-" + e.start.slice(6,8) + "T" + e.start.slice(9,15));
            return s >= dayStart && s <= dayEnd;
          })
          .sort((a, b) => a.priority - b.priority);

        dayEvents.forEach(ev => {
          const color = colors[ev.priority] || "rest";
          const block = document.createElement("div");
          block.className = `block ${color}`;
          dayDiv.appendChild(block);
        });

        container.appendChild(dayDiv);
      }
    }

    loadEvents();
  </script>
</body>
</html>
