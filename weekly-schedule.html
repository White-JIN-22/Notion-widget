<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<meta name="referrer" content="no-referrer">
<title>Weekly Timetable Widget</title>
<style>
  body {
    margin: 0;
    background: #1a1a1a;
    font-family: 'Inter', sans-serif;
    color: #f2f2f2;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  .widget {
    backdrop-filter: blur(15px);
    background: rgba(255,255,255,0.06);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 16px;
    padding: 12px;
    width: 640px;
    box-shadow: 0 4px 25px rgba(0,0,0,0.3);
  }

  .grid {
    display: grid;
    grid-template-columns: 70px repeat(7, 1fr);
    gap: 6px;
  }

  .header {
    text-align: center;
    font-weight: 600;
    font-size: 0.9rem;
  }

  .cell {
    height: 80px;
    border-radius: 8px;
    background: rgba(255,255,255,0.05);
    overflow: hidden;
    position: relative;
  }

  .block {
    position: absolute;
    left: 0; right: 0;
    border-radius: 6px;
    opacity: 0.95;
    transition: transform 0.2s ease;
  }
  .block:hover { transform: scale(1.02); }

  .morning { background: rgba(136,183,227,0.6); }
  .afternoon { background: rgba(32,58,89,0.8); }
  .evening { background: rgba(199,201,217,0.5); }

  .label {
    text-align: right;
    font-weight: 500;
    font-size: 0.8rem;
    color: #ccc;
    padding-right: 4px;
  }

  .holiday { color: #ff5c5c; }
</style>
</head>
<body>
  <div class="widget" id="timetableWidget">Loading...</div>

<script>
(async function() {
  const randomId = Math.random().toString(36).substring(2, 8);
  document.title = `Timetable_${randomId}`;
  
  const icalUrls = [
    "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxInlf0nwQRwqVQaKN3oFgWzqLUfigKhteMNDAjQwkPlHzBe_ELV5RYcePFbCOI5H3TM",
    "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIlkFT1ZEqbRVczq6PrGuVHb0Afa1EhpfGiSULTpK_tYur-eQz2Uqc74JIqfAKkjBP8",
    "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxImfGB8G7hln8RI2A4WFBMN51g9wFHOsIhQgRFNSx9Dz4_f4s6w0S4RBWQw9Fgtt2mU",
    "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIks_Phe4DHFMcJQdGTXVekoe7DfsUtHGLCLydgauhnycV_BUoW1c_GcPu0dMkd_m9I"
  ];

  const colors = ["#203A59", "#88B7E3", "#C7C9D9", "#F5F5EF"];
  const recurringHolidays = ["01-01","03-01","05-05","06-06","08-15","10-03","10-09","12-25"];
  const startOfWeek = new Date();
  const day = startOfWeek.getDay();
  const diff = (day === 0 ? -6 : 1) - day; 
  startOfWeek.setDate(startOfWeek.getDate() + diff);

  const icsData = await Promise.all(icalUrls.map(u => fetch(u).then(r=>r.text()).catch(()=>null)));

  const events = [];
  icsData.forEach((data, idx) => {
    if (!data) return;
    const regex = /DTSTART.*:(\d{8}T\d{6})[\s\S]*?DTEND.*:(\d{8}T\d{6})/g;
    for (const match of data.matchAll(regex)) {
      const start = new Date(match[1].replace(/(\d{4})(\d{2})(\d{2})T/, "$1-$2-$3T"));
      const end = new Date(match[2].replace(/(\d{4})(\d{2})(\d{2})T/, "$1-$2-$3T"));
      events.push({ start, end, color: colors[idx], priority: idx });
    }
  });

  const container = document.getElementById("timetableWidget");
  container.innerHTML = `<div class="grid"></div>`;
  const grid = container.querySelector(".grid");
  const weekdays = ["MON","TUE","WED","THU","FRI","SAT","SUN"];

  // header row
  grid.innerHTML = `<div></div>` + weekdays.map(d => `<div class="header">${d}</div>`).join('');

  // 3 time sections
  const sections = [
    { label: "오전", start: 6, end: 12 },
    { label: "오후", start: 12, end: 18 },
    { label: "저녁", start: 18, end: 24 },
  ];

  for (const s of sections) {
    grid.innerHTML += `<div class="label">${s.label}</div>`;
    for (let i = 0; i < 7; i++) {
      const date = new Date(startOfWeek);
      date.setDate(date.getDate() + i);
      const dateKey = `${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`;
      const cell = document.createElement("div");
      cell.className = "cell";
      if (recurringHolidays.includes(dateKey)) {
        cell.innerHTML = `<div style="position:absolute;top:4px;right:6px;font-size:0.7rem;color:#ff5c5c">${date.getDate()}</div>`;
      } else {
        cell.innerHTML = `<div style="position:absolute;top:4px;right:6px;font-size:0.7rem;">${date.getDate()}</div>`;
      }
      const dayEvents = events
        .filter(e => e.start.toDateString() === date.toDateString() && e.start.getHours() < s.end && e.end.getHours() > s.start)
        .sort((a,b) => a.priority - b.priority || a.start - b.start);
      if (dayEvents.length > 0) {
        const topEvent = dayEvents[0];
        const duration = Math.min((topEvent.end - topEvent.start)/3600000, s.end - s.start);
        const height = (duration / (s.end - s.start)) * 100;
        const offset = ((Math.max(topEvent.start.getHours(), s.start) - s.start) / (s.end - s.start)) * 100;
        const block = document.createElement("div");
        block.className = "block";
        block.style.background = topEvent.color;
        block.style.top = `${offset}%`;
        block.style.height = `${height}%`;
        cell.appendChild(block);
      }
      grid.appendChild(cell);
    }
  }
})();
</script>
</body>
</html>
