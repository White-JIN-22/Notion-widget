<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calendar Widget</title>
<style>
  body {
    background: #1a1a1a;
    color: #f2f2f2;
    font-family: 'Inter', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    justify-content: center;
    margin: 0;
  }
  .calendar-container {
    background: rgba(255,255,255,0.08);
    border-radius: 14px;
    padding: 20px;
    text-align: center;
    width: 320px;
    height: 360px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  .month {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-weight: 600;
    margin-bottom: 10px;
    color: #a9c4ff;
  }
  .month button {
    background: none;
    border: none;
    color: #a9c4ff;
    font-size: 1.2rem;
    cursor: pointer;
  }
  .month span {
    font-size: 1.1rem;
    font-weight: 600;
  }
  .days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 6px;
    height: 280px;
  }
  .day {
    padding: 8px 0;
    border-radius: 8px;
    transition: background 0.2s;
    position: relative;
  }
  .day:hover { background: rgba(255,255,255,0.1); cursor: pointer; }
  .today { color: #5ab0ff; font-weight: 700; }
  .holiday { color: #ff7070; }
  .dots {
    display: flex;
    justify-content: center;
    margin-top: 2px;
  }
  .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin: 0 1px;
  }
  .dot.red { background: #f44336; }
  .dot.orange { background: #ff9800; }
  .dot.blue { background: #2196f3; }
  .dot.green { background: #4caf50; }
  .plus {
    font-size: 0.7rem;
    margin-left: 2px;
    opacity: 0.8;
  }

  .event-list {
    margin-top: 15px;
    background: rgba(255,255,255,0.08);
    border-radius: 10px;
    padding: 12px;
    width: 280px;
    text-align: left;
  }
  .event-list h3 {
    margin: 0 0 6px;
    font-size: 1rem;
    color: #cfd8dc;
  }
  .event {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 0.9rem;
    color: #f2f2f2;
    margin: 3px 0;
  }
  .dot.small { width: 8px; height: 8px; }
</style>
</head>
<body>
  <div class="calendar-container">
    <div class="month">
      <button id="prevMonth">❮</button>
      <span id="monthYear"></span>
      <button id="nextMonth">❯</button>
    </div>
    <div class="days" id="days"></div>
  </div>
  <div class="event-list" id="eventList" style="display:none;"></div>

<script>
const proxy = "https://ical-proxy.moonkelly601.workers.dev/";
const calendars = {
  red: "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxInlf0nwQRwqVQaKN3oFgWzqLUfigKhteMNDAjQwkPlHzBe_ELV5RYcePFbCOI5H3TM",
  orange: "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIlkFT1ZEqbRVczq6PrGuVHb0Afa1EhpfGiSULTpK_tYur-eQz2Uqc74JIqfAKkjBP8",
  blue: "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxImfGB8G7hln8RI2A4WFBMN51g9wFHOsIhQgRFNSx9Dz4_f4s6w0S4RBWQw9Fgtt2mU",
  green: "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIks_Phe4DHFMcJQdGTXVekoe7DfsUtHGLCLydgauhnycV_BUoW1c_GcPu0dMkd_m9I"
};
const recurringHolidays = ["01-01","03-01","05-05","06-06","08-15","10-03","10-09","12-25"];
let currentDate = new Date();
let events = {};

async function fetchCalendar(color, url) {
  const response = await fetch(`${proxy}?url=${encodeURIComponent(url)}`);
  const text = await response.text();
  parseICS(color, text);
  renderCalendar();
}

function parseICS(color, text) {
  const lines = text.split("\n");
  let event = {};
  for (const line of lines) {
    if (line.startsWith("BEGIN:VEVENT")) event = {};
    else if (line.startsWith("DTSTART")) event.start = line.split(":")[1];
    else if (line.startsWith("SUMMARY")) event.title = line.split(":")[1];
    else if (line.startsWith("END:VEVENT")) {
      const dateKey = event.start?.substring(0,8);
      if (!dateKey) continue;
      if (!events[dateKey]) events[dateKey] = [];
      events[dateKey].push({ title: event.title, color });
    }
  }
}

function renderCalendar() {
  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();
  const monthYear = document.getElementById("monthYear");
  const daysContainer = document.getElementById("days");
  const eventList = document.getElementById("eventList");

  const monthNames = ["JANUARY","FEBRUARY","MARCH","APRIL","MAY","JUNE","JULY","AUGUST","SEPTEMBER","OCTOBER","NOVEMBER","DECEMBER"];
  monthYear.textContent = `${month+1}월 :: ${monthNames[month]}`;
  daysContainer.innerHTML = "";

  const firstDay = new Date(year, month, 1).getDay();
  const lastDate = new Date(year, month+1, 0).getDate();
  const today = new Date();
  
  for (let i=0; i<firstDay; i++) daysContainer.appendChild(document.createElement("div"));
  
  for (let d=1; d<=lastDate; d++) {
    const dateEl = document.createElement("div");
    dateEl.className = "day";
    const dateKey = `${year}${String(month+1).padStart(2,"0")}${String(d).padStart(2,"0")}`;
    
    if (today.getFullYear()===year && today.getMonth()===month && today.getDate()===d)
      dateEl.classList.add("today");

    const monthDayKey = `${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    if (recurringHolidays.includes(monthDayKey))
      dateEl.classList.add("holiday");

    dateEl.textContent = d;
    if (events[dateKey]) {
      const dots = document.createElement("div");
      dots.className = "dots";
      const evList = events[dateKey];
      const showCount = Math.min(4, evList.length);
      for (let i=0; i<showCount; i++) {
        const dot = document.createElement("div");
        dot.className = `dot ${evList[i].color}`;
        dots.appendChild(dot);
      }
      if (evList.length > 4) {
        const plus = document.createElement("span");
        plus.className = `plus ${evList[0].color}`;
        plus.textContent = `+${evList.length-4}`;
        dots.appendChild(plus);
      }
      dateEl.appendChild(dots);
      dateEl.addEventListener("click", () => {
        eventList.style.display = "block";
        eventList.innerHTML = `<h3>${month+1}월 ${d}일</h3>`;
        for (const ev of evList) {
          eventList.innerHTML += `<div class="event"><div class="dot small ${ev.color}"></div>${ev.title}</div>`;
        }
      });
    }
    daysContainer.appendChild(dateEl);
  }

  // 빈 칸 채워서 항상 균형 유지 (정사각형 형태)
  const totalCells = firstDay + lastDate;
  const remainder = totalCells % 7;
  if (remainder !== 0) {
    for (let i=0; i<7-remainder; i++) {
      daysContainer.appendChild(document.createElement("div"));
    }
  }
}

document.getElementById("prevMonth").onclick = () => {
  currentDate.setMonth(currentDate.getMonth()-1);
  renderCalendar();
};
document.getElementById("nextMonth").onclick = () => {
  currentDate.setMonth(currentDate.getMonth()+1);
  renderCalendar();
};

(async () => {
  for (const [color, url] of Object.entries(calendars)) {
    await fetchCalendar(color, url);
  }
})();
</script>
</body>
</html>
