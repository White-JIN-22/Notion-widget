<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortress Calendar</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; }
        ::-webkit-scrollbar { display: none; }
        #eventModal { display: none; }
        /* 로딩 스피너 애니메이션 */
        @keyframes spin { to { transform: rotate(360deg); } }
        .spinner { animation: spin 1s linear infinite; }
    </style>
</head>
<body class="bg-gray-50 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-white rounded-3xl p-6 shadow-sm border border-gray-200 relative">
        
        <div id="loadingIndicator" class="absolute top-4 right-14 hidden">
            <i data-lucide="loader-2" class="spinner text-gray-400" width="16"></i>
        </div>

        <div class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-2">
                <button onclick="changeMonth(-1)" class="p-1 hover:bg-gray-100 rounded-full text-gray-600">
                    <i data-lucide="chevron-left"></i>
                </button>
                <span id="currentMonthYear" class="text-xl font-bold text-gray-800 tracking-tight"></span>
                <button onclick="changeMonth(1)" class="p-1 hover:bg-gray-100 rounded-full text-gray-600">
                    <i data-lucide="chevron-right"></i>
                </button>
            </div>
            <button onclick="openModal()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-700 transition-colors">
                <i data-lucide="plus"></i>
            </button>
        </div>

        <div class="grid grid-cols-7 mb-2 text-center">
            <div class="text-sm text-gray-500 font-semibold">일</div>
            <div class="text-sm text-gray-500 font-semibold">월</div>
            <div class="text-sm text-gray-500 font-semibold">화</div>
            <div class="text-sm text-gray-500 font-semibold">수</div>
            <div class="text-sm text-gray-500 font-semibold">목</div>
            <div class="text-sm text-gray-500 font-semibold">금</div>
            <div class="text-sm text-gray-500 font-semibold">토</div>
        </div>

        <div id="calendarGrid" class="grid grid-cols-7 gap-1"></div>
    </div>

    <div id="eventModal" class="fixed inset-0 bg-black/30 items-center justify-center z-50">
        <div class="bg-white w-80 rounded-2xl p-5 shadow-xl relative">
            <button onclick="closeModal()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                <i data-lucide="x" width="18"></i>
            </button>
            
            <h3 class="text-base font-bold text-gray-800 mb-4">새 일정 추가</h3>
            
            <div class="space-y-4">
                <input type="text" id="eventTitle" placeholder="일정 내용" 
                    class="w-full p-2 text-sm border-b border-gray-200 focus:outline-none focus:border-gray-500 placeholder-gray-400 font-medium">

                <input type="date" id="eventDate" class="w-full text-xs p-2 bg-gray-50 rounded-lg text-gray-700 outline-none font-medium">
                
                <div class="flex gap-2 items-center">
                    <input type="time" id="startTime" class="w-1/2 text-xs p-2 bg-gray-50 rounded-lg text-gray-700 outline-none font-medium">
                    <span class="text-gray-400">~</span>
                    <input type="time" id="endTime" class="w-1/2 text-xs p-2 bg-gray-50 rounded-lg text-gray-700 outline-none font-medium">
                </div>

                <div class="grid grid-cols-2 gap-2 pt-2" id="categoryContainer"></div>

                <button onclick="addEvent()" id="addBtn" class="w-full py-3 mt-2 bg-gray-500 hover:bg-gray-600 text-white text-sm font-bold rounded-xl transition-colors">
                    추가하기
                </button>
            </div>
        </div>
    </div>

    <script>
        // ✅ 진솔이의 Worker 주소 적용 완료!
        const WORKER_URL = "https://flat-thunder-3821.moonkelly601.workers.dev/"; 

        let currentDate = new Date();
        let events = [];
        let selectedCategory = 'work';

        const categories = {
            work: { label: '업무', class: 'bg-sky-100 text-sky-600 border-sky-200', icon: 'briefcase' },
            develop: { label: '자기계발', class: 'bg-purple-100 text-purple-600 border-purple-200', icon: 'book-open' },
            health: { label: '건강', class: 'bg-yellow-100 text-yellow-600 border-yellow-200', icon: 'heart-pulse' },
            rest: { label: '휴식', class: 'bg-gray-100 text-gray-600 border-gray-200', icon: 'coffee' }
        };

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            fetchEvents(); // 워커에서 데이터 불러오기
            renderCategoryButtons();
        });

        // 워커에서 일정 불러오기 (GET)
        async function fetchEvents() {
            showLoading(true);
            try {
                const res = await fetch(WORKER_URL);
                const data = await res.json();
                
                // 데이터 매핑 (혹시 모를 오류 방지)
                events = Array.isArray(data) ? data : []; 
                renderCalendar();
            } catch (err) {
                console.error("데이터 로드 실패:", err);
                // 실패 시 조용히 넘어가거나, 콘솔에만 기록 (사용자 경험 보호)
            } finally {
                showLoading(false);
            }
        }

        // 워커로 일정 보내기 (POST)
        async function addEvent() {
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const startTime = document.getElementById('startTime').value;
            const endTime = document.getElementById('endTime').value;
            
            if (!title || !date) return;
            
            const btn = document.getElementById('addBtn');
            btn.innerText = "저장 중...";
            btn.disabled = true;

            const newEvent = {
                title: title,
                date: date,
                startTime: startTime,
                endTime: endTime,
                category: selectedCategory
            };

            try {
                const res = await fetch(WORKER_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(newEvent)
                });

                if (res.ok) {
                    await fetchEvents(); // 저장 후 목록 다시 갱신
                    closeModal();
                } else {
                    alert("저장에 실패했어. Worker 로그를 확인해봐야 할 것 같아.");
                }
            } catch (err) {
                console.error("저장 에러:", err);
                alert("네트워크 오류가 발생했어.");
            } finally {
                btn.innerText = "추가하기";
                btn.disabled = false;
            }
        }

        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const monthTitle = document.getElementById('currentMonthYear');
            
            grid.innerHTML = '';
            
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            monthTitle.innerText = `${year}년 ${month + 1}월`;

            const firstDay = new Date(year, month, 1).getDay();
            const lastDate = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) {
                const emptyCell = document.createElement('div');
                emptyCell.className = 'h-24';
                grid.appendChild(emptyCell);
            }

            for (let i = 1; i <= lastDate; i++) {
                const dayCell = document.createElement('div');
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                
                const isToday = new Date().toDateString() === new Date(year, month, i).toDateString();
                const dateColor = isToday ? 'text-blue-600' : 'text-gray-700';

                dayCell.className = 'h-24 border-t border-gray-100 p-1 flex flex-col gap-1 overflow-hidden hover:bg-gray-50 transition-colors';
                
                let eventsHtml = '';
                const daysEvents = events.filter(e => e.date === dateStr);
                
                daysEvents.forEach(e => {
                    const catKey = categories[e.category] ? e.category : 'work';
                    const cat = categories[catKey];
                    // 스타일 복구: 배경 투명도 조절
                    const bgClass = cat.class.split(' ')[0]; 
                    const textClass = cat.class.split(' ')[1];
                    
                    eventsHtml += `
                        <div class="text-[10px] px-1.5 py-0.5 rounded flex items-center gap-1 truncate ${bgClass} bg-opacity-40 ${textClass} font-medium">
                            ${e.title}
                        </div>
                    `;
                });

                dayCell.innerHTML = `
                    <span class="text-sm font-bold ml-1 ${dateColor}">${i}</span>
                    <div class="flex flex-col gap-1 w-full">
                        ${eventsHtml}
                    </div>
                `;
                grid.appendChild(dayCell);
            }
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        function openModal() {
            const modal = document.getElementById('eventModal');
            modal.style.display = 'flex';
            
            const todayStr = new Date().toISOString().split('T')[0];
            document.getElementById('eventDate').value = todayStr;
            document.getElementById('startTime').value = '09:00';
            document.getElementById('endTime').value = '10:00';
            document.getElementById('eventTitle').value = '';
            
            selectedCategory = 'work';
            renderCategoryButtons();
        }

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        function renderCategoryButtons() {
            const container = document.getElementById('categoryContainer');
            container.innerHTML = '';
            
            Object.entries(categories).forEach(([key, val]) => {
                const isActive = key === selectedCategory;
                const btnClass = isActive 
                    ? `${val.class} border` 
                    : 'bg-white text-gray-400 border border-gray-200 hover:bg-gray-50';
                
                const btn = document.createElement('button');
                btn.className = `flex items-center gap-2 p-2 rounded-lg text-xs transition-all ${btnClass}`;
                btn.onclick = () => { selectedCategory = key; renderCategoryButtons(); };
                btn.innerHTML = `<i data-lucide="${val.icon}" width="16"></i> <span>${val.label}</span>`;
                
                container.appendChild(btn);
            });
            lucide.createIcons();
        }

        function showLoading(show) {
            document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
        }
    </script>
</body>
</html>
