<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="color-scheme" content="dark light">
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeline Block</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=Roboto+Mono:wght@400;500;700&display=swap');

        /* [ë‹¤í¬ëª¨ë“œ ì „ìš©] ë°°ê²½ ì œê±° ë° í…ìŠ¤íŠ¸ ë°œê´‘ */
        html, body, #root {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: transparent !important; /* htmlê³¼ rootê¹Œì§€ íˆ¬ëª…í™” í•„ìˆ˜ */
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: auto; /* ë¶ˆí•„ìš”í•œ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }

        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .widget-container {
            position: relative;
            width: 100%;
            max-width: 160px;
            height: 540px;
            
            /* í•µì‹¬: ë°°ê²½ ì™„ì „ íˆ¬ëª…í™” (ë…¸ì…˜ ë°°ê²½ íˆ¬ê³¼) */
            background: transparent !important; 
            backdrop-filter: none !important;
            
            /* í…Œë‘ë¦¬ë§Œ ì•„ì£¼ ì–‡ê²Œ */
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            box-shadow: none; /* ê·¸ë¦¼ì ì œê±° */
            
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #f1f5f9; /* ê¸°ë³¸ ê¸€ì”¨: ë°ì€ íšŒìƒ‰ */
        }

        /* [ì¶”ê°€] ê¸€ë˜ìŠ¤ëª¨í”¼ì¦˜ ì „ìš© ìŠ¤íƒ€ì¼ (í°ìƒ‰ ë°•ìŠ¤ ì˜¤ë¥˜ ë°©ì§€) */
.glass-header {
    background: rgba(255, 255, 255, 0.15) !important; /* í—¤ë”ëŠ” ì¡°ê¸ˆ ë” ë°ê²Œ */
    backdrop-filter: blur(8px);
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}
.glass-body {
    background: rgba(255, 255, 255, 0.05) !important; /* ë³¸ë¬¸ì€ ì€ì€í•˜ê²Œ */
}

        /* ë‚´ë¶€ ìš”ì†Œ (í‘¸í„°)ë§Œ ì‚´ì§ ë°˜íˆ¬ëª… */
        .footer-blur {
            background: rgba(255, 255, 255, 0.05); /* 5% í°ìƒ‰ */
            backdrop-filter: blur(5px);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* ê·¸ë¦¬ë“œ ì„ : ì•„ì£¼ ì˜…ì€ ì ì„  */
        .grid-row {
            flex: 1;
            display: flex;
            align-items: center;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.08); 
            min-height: 0;
        }
        .time-label {
            width: 20px; text-align: right; padding-right: 4px;
            font-size: 8px; font-family: 'Roboto Mono', monospace; line-height: 1;
            color: rgba(255, 255, 255, 0.3); /* ì‹œê°„ ìˆ«ìëŠ” ì–´ë‘¡ê²Œ */
        }
        
        .blocks-container { flex: 1; display: grid; grid-template-columns: repeat(6, 1fr); gap: 2px; height: 16px; padding-right: 6px; }
        .time-block { border-radius: 4px; transition: all 0.3s ease; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        
        /* ë¸”ë¡ ìƒ‰ìƒ: ë‹¤í¬ëª¨ë“œì—ì„œ ì˜ ë³´ì´ë„ë¡ í˜•ê´‘í†¤ ì¡°ì • */
        .block-sun { background: rgba(192, 132, 252, 0.4); border: 1px solid rgba(192, 132, 252, 0.5); box-shadow: 0 0 8px rgba(192,132,252,0.2); }
        .block-cloud { background: rgba(56, 189, 248, 0.3); border: 1px solid rgba(56, 189, 248, 0.4); box-shadow: 0 0 8px rgba(56,189,248,0.2); }
        .block-rain { background: rgba(148, 163, 184, 0.2); border: 1px solid rgba(148, 163, 184, 0.3); }
        .block-empty { background: rgba(255, 255, 255, 0.02); }
        
        /* í°íŠ¸ ë° ìœ í‹¸ë¦¬í‹° */
        .font-serif { font-family: 'Playfair Display', serif; }
        .font-mono-nums { font-family: 'Roboto Mono', monospace; letter-spacing: -0.5px; }
        .text-sky-custom { color: #38bdf8; text-shadow: 0 0 10px rgba(56,189,248,0.6); } 
        .text-purple-custom { color: #c084fc; text-shadow: 0 0 10px rgba(192,132,252,0.6); }
        .text-white { color: #ffffff; text-shadow: 0 0 5px rgba(255,255,255,0.3); }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sky: { 200: '#bae6fd', 300: '#7dd3fc', 500: '#0ea5e9' },
                        purple: { 200: '#e9d5ff', 300: '#d8b4fe' },
                        slate: { 400: '#94a3b8', 700: '#f1f5f9' }
                    },
                    fontFamily: { sans: ['"Noto Sans KR"', 'sans-serif'], serif: ['"Playfair Display"', 'serif'], mono: ['"Roboto Mono"', 'monospace'] }
                }
            }
        }
    </script>
</head>
<body>

    <div id="root" style="width: 100%; display: flex; justify-content: center;"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const CALENDAR_API = "https://log-cal.moonkelly601.workers.dev/";
        const categoryColors = {
            'ì—…ë¬´': 'bg-[#7dd3fc]',      
            'ìê¸°ê³„ë°œ': 'bg-[#d8b4fe]', 
            'íœ´ì‹': 'bg-[#94a3b8]',     
            'ê±´ê°•': 'bg-[#fef08a]',    
            'default': 'bg-white/60'
        };

        const Icons = {
            // [ì¶”ê°€] ì„  ë‘ê»˜ 3ì¸ í•´ ì•„ì´ì½˜
            Sun: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            Refresh: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#bae6fd" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>,
            Droplets: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>,
            Utensils: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path><path d="M7 2v20"></path><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"></path></svg>,
            Recycle: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>,
            Wind: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"></path></svg>,
            Shirt: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M20.38 3.4a2 2 0 0 0-2-2h-12.76a2 2 0 0 0-2 2l-.22 2.6a2 2 0 0 0 1.99 2.2h13.22a2 2 0 0 0 1.99-2.2l-.22-2.6z"></path><path d="M9 2v4"></path><path d="M15 2v4"></path><path d="M20 10v12H4V10"></path></svg>,
            Moon: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Book: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>,
            Zzz: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M2 4h20"></path><path d="M2 20h20"></path><path d="M6 12h12"></path></svg>,
            Leaf: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.5 2 6 0 5.5-4.5 10-10 10z"></path><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"></path></svg>,
            Zap: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
            Waves: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"></path><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"></path><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"></path></svg>,
            Home: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            Pen: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l5.5 5.5"></path><path d="M11 11l5.5 5.5"></path></svg>,
            Flame: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a7 7 0 0 0 3 3.3z"></path></svg>,
            Cup: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>,
            Pill: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="7" width="18" height="10" rx="5" ry="5"></rect><line x1="12" y1="7" x2="12" y2="17"></line></svg>,
            Pot: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M2 12h20"></path><path d="M20 12v8a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2v-8"></path><path d="M4 12V7a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v5"></path><path d="M12 3v-1"></path></svg>,
            Stretch: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="5" r="1"></circle><path d="M12 20V6"></path><path d="M5 8l7-2 7 2"></path><path d="M8 20l4-9 4 9"></path></svg>,
            Message: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>,
        };

        const App = () => {
            const [blocks, setBlocks] = useState([]);
            const [events, setEvents] = useState([]);
            const [dateStr, setDateStr] = useState('');
            const [totalDuration, setTotalDuration] = useState(0);
            const [wakeUpTime, setWakeUpTime] = useState(null);
            const [bedTime, setBedTime] = useState(null);

            // [ìˆ˜ì •] ìµœì‹  blocks ìƒíƒœë¥¼ ì¶”ì í•˜ê¸° ìœ„í•œ Ref (ê¹œë¹¡ì„ ë°©ì§€ìš©)
            const blocksRef = useRef(blocks);
            useEffect(() => { blocksRef.current = blocks; }, [blocks]);
                        
            // [ì¶”ê°€] ë‚ ì§œ íƒìƒ‰ì„ ìœ„í•œ ìƒíƒœ
            const [viewDate, setViewDate] = useState(new Date());

            // ë‚ ì§œ ìœ í‹¸ë¦¬í‹°
            const isToday = (d) => d.toDateString() === new Date().toDateString();
            
            const changeDate = (diff) => {
                const next = new Date(viewDate);
                next.setDate(next.getDate() + diff);
                setViewDate(next);
            };
            const returnToday = () => setViewDate(new Date());

            // 1. [ë¡œì»¬ ë¡œë“œ] ì˜¤ëŠ˜ ë‚ ì§œì¼ ë•Œë§Œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì‚¬ìš©
            const loadLocalData = () => {
                if (!isToday(viewDate)) return; // ê³¼ê±° ì¡°íšŒ ì¤‘ì—ëŠ” ë¡œì»¬ ë¡œë“œ ì¤‘ë‹¨

                const savedData = JSON.parse(localStorage.getItem('fortressData') || '{}');
                const today = new Date().toDateString();
                
                if (savedData.date === today && savedData.blocks) {
                    setBlocks(savedData.blocks);
                    setWakeUpTime(savedData.wakeUpTime || null);
                    setBedTime(savedData.bedTime || null);
                } else {
                    // ë°ì´í„°ê°€ ì—†ê±°ë‚˜ ë‚ ì§œê°€ ë‹¤ë¥´ë©´ ì´ˆê¸°í™”
                    setBlocks([]);
                    setWakeUpTime(null);
                }
            };

            // [ì¶”ê°€] ìº˜ë¦°ë” ë°ì´í„°ë§Œ ê°€ì ¸ì˜¤ê¸° (ë¸”ë¡ ë°ì´í„°ëŠ” ì•ˆ ê±´ë“œë¦¼ -> ê¹œë¹¡ì„ ì—†ìŒ)
            const fetchCalendar = async () => {
                try {
                    const calRes = await fetch(`${CALENDAR_API}?type=calendar`);
                    if (calRes.ok) {
                        const calData = await calRes.json();
                        if (Array.isArray(calData)) setEvents(calData);
                    }
                } catch (e) { /* ì—ëŸ¬ ë¬´ì‹œ */ }
            };

            // [Effect 1] ì´ˆê¸° ë¡œë“œ ë° ë‚ ì§œ ë³€ê²½ ì‹œ ì¦‰ì‹œ ì‹¤í–‰
            useEffect(() => {
                const month = viewDate.getMonth() + 1;
                const date = viewDate.getDate();
                const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
                const day = days[viewDate.getDay()];
                setDateStr(`${String(month).padStart(2, '0')}/${String(date).padStart(2, '0')} ${day}`);

                if (isToday(viewDate)) loadLocalData();
                fetchCalendar(); // [ë³µêµ¬] ìº˜ë¦°ë” ì¦‰ì‹œ ì¡°íšŒ
            }, [viewDate]);

            // [Effect 2] ì£¼ê¸°ì  ê°±ì‹ 
            useEffect(() => {
                // 1. ë¡œì»¬ ë°ì´í„° (3ì´ˆ)
                const localInterval = setInterval(() => {
                    if (isToday(viewDate)) loadLocalData();
                }, 3000);

                // 2. [ë³µêµ¬] ìº˜ë¦°ë” ë°ì´í„° (60ì´ˆ)
                const calendarInterval = setInterval(() => {
                    fetchCalendar();
                }, 60000);

                return () => {
                    clearInterval(localInterval);
                    clearInterval(calendarInterval);
                };
            }, [viewDate]);

            // [Effect 3] ì´ ì‹œê°„ ê³„ì‚° (blocks ë³€ê²½ ì‹œ)
            useEffect(() => {
                const focusBlocks = blocks.filter(b => !b.type || b.type === 'focus');
                const total = focusBlocks.reduce((acc, curr) => acc + curr.duration, 0);
                setTotalDuration(total);
            }, [blocks]);

            const getTotalColorClass = (min) => {
                if (min <= 90) return "text-white"; 
                if (min <= 330) return "text-sky-custom"; 
                return "text-purple-custom";               
            };

            const formatDuration = (totalMin) => {
                const h = Math.floor(totalMin / 60);
                const m = totalMin % 60;
                const colorClass = getTotalColorClass(totalMin);

                return (
                    <span className={`font-mono-nums ${colorClass} transition-colors duration-500`}>
                        <span className="text-xl font-bold">{h}</span><span className="text-xs mx-0.5 opacity-80 font-bold">H</span>
                        <span className="text-xl font-bold">{String(m).padStart(2, '0')}</span><span className="text-xs ml-0.5 opacity-80 font-bold">M</span>
                    </span>
                );
            };

            const getMessage = (min) => {
                const now = new Date();
                const currentHour = now.getHours();
                const stableIdx = now.getDate() % 3; 

                if (currentHour >= 13 && min === 0) {
                    const msgs = [
                        { main: "ğŸ§Š ì•„ì§ ì‹œì‘ ì „ì´ë„¤ìš”.", sub: "ì§€ê¸ˆ ë°”ë¡œ ì²« ë¸”ë¡ì„ ìŒ“ì•„ë³´ì„¸ìš”." },
                        { main: "â„ï¸ ì‹œì‘ì´ ë°˜ì…ë‹ˆë‹¤.", sub: "ê°€ë³ê²Œ ì±…ìƒì— ì•‰ì•„ë³¼ê¹Œìš”?" },
                        { main: "ğŸ•°ï¸ ì•„ì§ ëŠ¦ì§€ ì•Šì•˜ì–´ìš”.", sub: "ì§€ê¸ˆ ì¶œë°œí•˜ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤." }
                    ];
                    return msgs[stableIdx];
                }

                if (min === 0) return { main: "â„ï¸ ì¤€ë¹„ ë˜ì…¨ë‚˜ìš”?", sub: "ì°¨ê·¼ì°¨ê·¼ ì í™”ë¥¼ ì‹œì‘í•´ ë´…ì‹œë‹¤." };
                
                if (min < 60) {
                    return [{ main: "ğŸŒ± ì˜ë¯¸ ìˆëŠ” ì‹œì‘ì…ë‹ˆë‹¤.", sub: "ê°€ë³ê²Œ ë¦¬ë“¬ì„ íƒ€ë³´ì„¸ìš”." }, { main: "âœ¨ ì²« ë‹¨ì¶”ë¥¼ ê¿°ì—ˆìŠµë‹ˆë‹¤.", sub: "ì˜¤ëŠ˜ì˜ ì‹œìŠ¤í…œì´ ê°€ë™ ì¤‘ì…ë‹ˆë‹¤." }, { main: "ğŸ§Š ì°¨ë¶„í•œ ì¶œë°œì´ë„¤ìš”.", sub: "ì´ëŒ€ë¡œë§Œ ì­‰ ê°€ë©´ ë©ë‹ˆë‹¤." }][stableIdx];
                }
                
                if (min < 180) {
                    return [{ main: "ğŸ§± ê²¬ê³ í•˜ê²Œ ìŒ“ëŠ” ì¤‘ì…ë‹ˆë‹¤.", sub: "í”ë“¤ë¦¬ì§€ ì•ŠëŠ” ì‹œê°„ì´ ë©‹ì ¸ìš”." }, { main: "â˜ï¸ í›Œë¥­í•œ í˜ì´ìŠ¤ì…ë‹ˆë‹¤.", sub: "ë¬´ë˜í•˜ê²Œ ê³„ì† ë‚˜ì•„ê°€ì„¸ìš”." }, { main: "âš–ï¸ ê· í˜• ì¡íŒ ëª°ì…ì…ë‹ˆë‹¤.", sub: "ì˜í•˜ê³  ìˆìŠµë‹ˆë‹¤." }][stableIdx];
                }
                
                if (min < 300) {
                    return [{ main: "ğŸ”¥ ëœ¨ê±°ìš´ ëª°ì…ì˜ ì‹œê°„.", sub: "ì´ë¯¸ ì¶©ë¶„íˆ í›Œë¥­í•œ í•˜ë£¨ì˜ˆìš”." }, { main: "ğŸ’ ì •ë§ ëŒ€ë‹¨í•œ ì§‘ì¤‘ë ¥.", sub: "ì˜¤ëŠ˜ í•˜ë£¨, ë¹›ë‚˜ê³  ìˆìŠµë‹ˆë‹¤." }, { main: "ğŸš€ í•œê³„ë¥¼ ë„“íˆëŠ” ì¤‘.", sub: "ë‹¹ì‹ ì˜ ë…¸ë ¥ì´ ìŒ“ì´ê³  ìˆì–´ìš”." }][stableIdx];
                }

                return [{ main: "ğŸ–ï¸ í•œê³„ë¥¼ ë„˜ì€ ì„±ì·¨ì…ë‹ˆë‹¤.", sub: "ì¶©ë¶„íˆ ì• ì¼ìœ¼ë‹ˆ, íœ´ì‹ì„ ê¶Œì¥í•´ìš”." }, { main: "ğŸŒŒ ê²½ì´ë¡œìš´ ê¸°ë¡ì´ë„¤ìš”.", sub: "ì´ì œ í¸ì•ˆíˆ ì‰¬ì–´ë„ ë©ë‹ˆë‹¤." }, { main: "ğŸŒ™ ì¹˜ì—´í–ˆë˜ í•˜ë£¨ì˜ ë.", sub: "ìŠ¤ìŠ¤ë¡œë¥¼ ì¹­ì°¬í•´ ì£¼ì„¸ìš”." }][stableIdx];
            };

            const renderGrid = () => {
                const hours = Array.from({length: 18}, (_, i) => i + 6); 

                const roundTime = (ts) => {
                    const d = new Date(ts);
                    const m = d.getMinutes();
                    const roundedM = Math.round(m / 10) * 10; 
                    d.setMinutes(roundedM);
                    d.setSeconds(0); 
                    d.setMilliseconds(0);
                    return d.getTime();
                };

                return hours.map(hour => {
                    const slots = Array.from({length: 6}, (_, i) => {
                        const slotStartMin = i * 10;
                        const slotEndMin = (i + 1) * 10;
                        
                        const slotStartTime = new Date(viewDate); 
                        slotStartTime.setHours(hour, slotStartMin, 0, 0);
                        const slotStartTs = slotStartTime.getTime();
                        
                        // [ê¸°ì¡´ ê¸°ìƒ/ì·¨ì¹¨ ë“± íˆ¬ëª…í™” ë¡œì§ ìœ ì§€]
                        let isBeforeWakeUp = false;
                        let isWakeUpSlot = false;
                        let isAfterBedTime = false;
                        if (wakeUpTime) {
                            const [wH, wM] = wakeUpTime.split(':').map(Number);
                            const wakeUpDate = new Date(viewDate); wakeUpDate.setHours(wH, wM, 0, 0);
                            const wakeUpTs = wakeUpDate.getTime();
                            const slotEndTimeTmp = new Date(slotStartTs + 10 * 60 * 1000).getTime();
                            if (slotStartTs < wakeUpTs) isBeforeWakeUp = true;
                            if (bedTime) {
                                const [bH, bM] = bedTime.split(':').map(Number);
                                const bedDate = new Date(viewDate); bedDate.setHours(bH, bM, 0, 0);
                                if (slotStartTs >= bedDate.getTime()) isAfterBedTime = true;
                            }
                            if (wakeUpTs > slotStartTs && wakeUpTs <= slotEndTimeTmp) { isWakeUpSlot = true; isBeforeWakeUp = false; }
                        }

                        const slotEndTime = new Date(viewDate);
                        slotEndTime.setHours(hour, slotEndMin, 0, 0);
                        const slotEndTs = slotEndTime.getTime();
                        
                        // 1. Focus ë¸”ë¡ (ë°°ê²½ìƒ‰ ìˆìŒ)
                        const bgBlock = blocks.find(b => {
                            if (b.type !== 'focus' && b.type) return false; 
                            const roundedStart = roundTime(b.startTime);
                            const roundedEnd = roundTime(b.endTime);
                            const finalEnd = (roundedStart === roundedEnd) ? roundedEnd + (10 * 60 * 1000) : roundedEnd;
                            return slotStartTs >= roundedStart && slotStartTs < finalEnd;
                        });

                        // 2. [ìˆ˜ì •ë¨] Switch/Rest ë¸”ë¡ (10ë¶„ ì´ˆê³¼ êµ¬ê°„í˜•)
                        const rangeIconBlock = blocks.find(b => {
                            if (b.type === 'focus' || !b.type) return false;
                            if (!b.duration || b.duration <= 10) return false;

                            const roundedStart = roundTime(b.startTime);
                            // ì¢…ë£Œ ì‹œê°„ ë³´ì • (ì§€ì†ì‹œê°„ ê¸°ë°˜)
                            const roundedEnd = roundedStart + (b.duration * 60 * 1000); 
                            return slotStartTs >= roundedStart && slotStartTs < roundedEnd;
                        });

                        // 3. ë‹¨ë°œì„± ì•„ì´ì½˜ (10ë¶„ ì´í•˜)
                        const pointIconBlock = blocks.find(b => {
                            if (b.type === 'focus' || !b.type) return false;
                            if (b.duration > 10) return false; 
                            return b.endTime > slotStartTs && b.endTime <= slotEndTs;
                        });

                        const slotCenter = slotStartTs + (5 * 60 * 1000); 
                        const calendarEvent = events.find(ev => ev.startTime <= slotCenter && ev.endTime >= slotCenter);

                        let cellClass = 'block-empty';
                        let content = null;
                        let lineOverlay = null;

                        // íˆ¬ëª…í™” ì²˜ë¦¬
                        if ((isBeforeWakeUp || isAfterBedTime) && !bgBlock && !isWakeUpSlot && !rangeIconBlock) {
                            cellClass = 'opacity-0';
                        }
                        // A. Focus ë¸”ë¡ ë Œë”ë§
                        else if (bgBlock) {
                            if (bgBlock.quality === 'Sun') cellClass = 'block-sun';
                            else if (bgBlock.quality === 'Cloud') cellClass = 'block-cloud';
                            else cellClass = 'block-rain';
                        } 
                        // B. [í•µì‹¬ ìˆ˜ì •] ë²”ìœ„í˜• Switch/Rest ë¸”ë¡ (ì  + ì•„ì´ì½˜)
else if (rangeIconBlock) {
    cellClass = 'block-action-bg'; 
    
    const roundedStart = roundTime(rangeIconBlock.startTime);
    const totalSlots = Math.ceil(rangeIconBlock.duration / 10);
    const currentIndex = Math.floor((slotStartTs - roundedStart) / (10 * 60 * 1000));
    
    const iconIndex = Math.floor((totalSlots - 1) / 2);
    const color = rangeIconBlock.color || 'text-white';

    if (!cellClass.includes('flex')) cellClass += ' relative flex items-center justify-center';

    if (currentIndex === iconIndex) {
        // ì¤‘ì•™: ì•„ì´ì½˜ í‘œì‹œ
        const IconComp = Icons[rangeIconBlock.icon] || (rangeIconBlock.type === 'switch' ? Icons.Zap : Icons.Zzz);
        content = <IconComp className={`w-3.5 h-3.5 ${color} relative z-10 drop-shadow-md`} />;
    } else {
        // [ë””ìì¸ ìˆ˜ì •] ì„  ëŒ€ì‹  ë°˜ì§ì„(âŠ¹) ê¸°í˜¸ ì‚¬ìš©
        // text-[10px]: ì•„ì´ì½˜ë³´ë‹¤ ì‘ê²Œ ì„¤ì •í•˜ì—¬ ìœ„ê³„ ì§ˆì„œ ìœ ì§€
        // opacity-70: ë„ˆë¬´ íë¦¬ë©´ ë¨¼ì§€ ê°™ì•„ ë³´ì´ë¯€ë¡œ ì ë‹¹íˆ ë¹›ë‚˜ê²Œ ì„¤ì •
        // leading-none: ìˆ˜ì§ ì¤‘ì•™ ì •ë ¬ ë³´ì •
        content = (
            <span className={`text-[10px] leading-none ${color} opacity-60 relative z-10 pb-[1px]`}>âŠ¹</span>
        );
    }
}
                        // C. ë‹¨ë°œì„± ì•„ì´ì½˜
                        else if (pointIconBlock) {
                            cellClass = 'block-action-bg';
                            const IconComp = Icons[pointIconBlock.icon] || (pointIconBlock.type === 'switch' ? Icons.Zap : Icons.Zzz);
                            const iconColor = pointIconBlock.color || 'text-white';
                            if (!cellClass.includes('flex')) cellClass += ' relative flex items-center justify-center';
                            content = <IconComp className={`w-4 h-4 ${iconColor} relative z-10 drop-shadow-md`} />;
                        }

                        // ìº˜ë¦°ë” ë¼ì¸
                        if (calendarEvent) {
                            const category = calendarEvent.category || 'default';
                            const colorClass = categoryColors[category] || categoryColors['default'];
                            lineOverlay = (
                                <div className={`absolute w-[80%] h-[2px] rounded-full left-[10%] top-[48%] z-20 ${colorClass}`} title={calendarEvent.title} />
                            );
                            if (!content && !bgBlock && !rangeIconBlock) {
                                cellClass += ' relative'; 
                            }
                        }

                        return (
                            <div key={i} className={`time-block ${cellClass}`}>
                                {lineOverlay}
                                {content}
                            </div>
                        )
                    });
                    return (
                        <div key={hour} className="grid-row">
                            <div className="time-label">{String(hour).padStart(2,'0')}</div>
                            <div className="blocks-container">{slots}</div>
                        </div>
                    );
                });
            };

            const msg = getMessage(totalDuration);

            return (
                <div className="widget-container">
                    {/* 1. í—¤ë” ì˜ì—­ */}
                    <div className="px-4 pt-5 pb-2 flex justify-between items-end glass-header z-10 shrink-0">
                        <div>
                            <div className="text-sky-custom text-[10px] font-bold tracking-widest uppercase mb-0.5 opacity-90 font-mono-nums">{dateStr}</div>
                            <div className="leading-none mt-1">
                                {formatDuration(totalDuration)}
                            </div>
                        </div>
                    </div>
                    {/* 2. ë©”ì¸ ì»¨í…ì¸  ì˜ì—­ */}
                    <div className="flex-1 px-2 pt-2 pb-4 relative glass-body overflow-hidden flex flex-col">
                         {/* ìˆ«ì ë¼ë²¨ (ìˆ˜ì •í•œ ë¶€ë¶„) */}
                         <div className="grid grid-cols-6 gap-[2px] mb-0.5 pl-[20px] pr-[6px] shrink-0">
                            {[10, 20, 30, 40, 50, 60].map(m => (
                                <div key={m} className="text-right text-[6px] text-white/40 font-mono-nums">{m}</div>
                            ))}
                         </div>
                         {/* ê·¸ë¦¬ë“œ */}
                        <div className="grid-container">{renderGrid()}</div>
                    </div>

                    {/* 3. í‘¸í„° ì˜ì—­ */}
                    <div className="footer-blur px-4 pt-3 pb-3 z-10 shrink-0">
                        <div className="text-center flex flex-col justify-center h-auto">
                            <p className="text-xs font-bold text-white leading-tight drop-shadow-md mb-1">{msg.main}</p>
                            <p className="text-[10px] text-sky-200 leading-tight opacity-90">{msg.sub}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
