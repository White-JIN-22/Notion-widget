<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fortress Block Timeline (Calendar Integrated)</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: transparent;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .widget-container {
            position: relative;
            width: 100%;
            max-width: 160px;
            height: 540px;
            background: linear-gradient(180deg, rgba(224, 242, 254, 0.25) 0%, rgba(240, 249, 255, 0.15) 100%);
            backdrop-filter: blur(25px);
            border-radius: 24px;
            border: 1px solid rgba(224, 242, 254, 0.4);
            box-shadow: 0 8px 32px rgba(186, 230, 253, 0.15), inset 0 0 20px rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #334155;
        }

        .font-serif { font-family: 'Playfair Display', serif; font-weight: 700; }
        .font-mono-nums { font-family: 'Roboto Mono', monospace; letter-spacing: -0.5px; }
        
        .grid-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            justify-content: space-between;
        }
        .grid-row {
            flex: 1;
            display: flex;
            align-items: center;
            border-bottom: 1px dashed rgba(255, 255, 255, 0.15);
            min-height: 0;
        }
        .time-label {
            width: 20px;
            text-align: right;
            padding-right: 4px;
            font-size: 8px;
            color: rgba(255, 255, 255, 0.5);
            font-family: 'Roboto Mono', monospace;
            line-height: 1;
        }
        .blocks-container {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 2px;
            height: 16px;
            padding-right: 6px;
        }
        .time-block {
            border-radius: 2px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative; 
            overflow: hidden; 
        }
        
        /* Í∏∞Ï°¥ Î∏îÎ°ù Ïä§ÌÉÄÏùº */
        .block-sun { background: rgba(192, 132, 252, 0.7); border: 1px solid rgba(192, 132, 252, 0.9); }
        .block-cloud { background: rgba(56, 189, 248, 0.6); border: 1px solid rgba(56, 189, 248, 0.8); }
        .block-rain { background: rgba(148, 163, 184, 0.5); border: 1px solid rgba(148, 163, 184, 0.6); }
        .block-empty { background: rgba(255, 255, 255, 0.04); }
        .block-action-bg { background: transparent; border: none; }

        .footer-blur {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.5);
        }

        .text-sky-custom { color: #7dd3fc; text-shadow: 0 0 8px rgba(14, 165, 233, 0.3); } 
        .text-purple-custom { color: #c4b5fd; text-shadow: 0 0 8px rgba(168, 85, 247, 0.3); }
        .text-white { color: #ffffff; }

    </style>
</head>
<body>

    <div id="root" style="width: 100%; display: flex; justify-content: center;"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const CALENDAR_API = "https://log-cal.moonkelly601.workers.dev/";
        const WORKER_URL = "https://log-worker.moonkelly601.workers.dev";

        const categoryColors = {
            'ÏóÖÎ¨¥': 'bg-[#7dd3fc]',      
            'ÏûêÍ∏∞Í≥ÑÎ∞ú': 'bg-[#d8b4fe]', 
            'Ìú¥Ïãù': 'bg-[#94a3b8]',     
            'Í±¥Í∞ï': 'bg-[#fef08a]',    
            'default': 'bg-white/60'
        };

        const Icons = {
            // [Ï∂îÍ∞Ä] ÏÑ† ÎëêÍªò 3Ïù∏ Ìï¥ ÏïÑÏù¥ÏΩò
            Sun: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line></svg>,
            Refresh: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="#bae6fd" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>,
            Droplets: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 2.69l5.66 5.66a8 8 0 1 1-11.31 0z"></path></svg>,
            Utensils: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 2v7c0 1.1.9 2 2 2h4a2 2 0 0 0 2-2V2"></path><path d="M7 2v20"></path><path d="M21 15V2v0a5 5 0 0 0-5 5v6c0 1.1.9 2 2 2h3zm0 0v7"></path></svg>,
            Recycle: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>,
            Wind: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M9.59 4.59A2 2 0 1 1 11 8H2m10.59 11.41A2 2 0 1 0 14 16H2m15.73-8.27A2.5 2.5 0 1 1 19.5 12H2"></path></svg>,
            Shirt: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M20.38 3.4a2 2 0 0 0-2-2h-12.76a2 2 0 0 0-2 2l-.22 2.6a2 2 0 0 0 1.99 2.2h13.22a2 2 0 0 0 1.99-2.2l-.22-2.6z"></path><path d="M9 2v4"></path><path d="M15 2v4"></path><path d="M20 10v12H4V10"></path></svg>,
            Moon: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>,
            Book: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path><path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path></svg>,
            Zzz: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M2 4h20"></path><path d="M2 20h20"></path><path d="M6 12h12"></path></svg>,
            Leaf: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M11 20A7 7 0 0 1 9.8 6.1C15.5 5 17 4.48 19 2c1 2 2 4.5 2 6 0 5.5-4.5 10-10 10z"></path><path d="M2 21c0-3 1.85-5.36 5.08-6C9.5 14.52 12 13 13 12"></path></svg>,
            Zap: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="currentColor" stroke="none"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>,
            Waves: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M2 6c.6.5 1.2 1 2.5 1C7 7 7 5 9.5 5c2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"></path><path d="M2 12c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"></path><path d="M2 18c.6.5 1.2 1 2.5 1 2.5 0 2.5-2 5-2 2.6 0 2.4 2 5 2 2.5 0 2.5-2 5-2 1.3 0 1.9.5 2.5 1"></path></svg>,
            Home: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>,
            Pen: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M12 19l7-7 3 3-7 7-3-3z"></path><path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path><path d="M2 2l5.5 5.5"></path><path d="M11 11l5.5 5.5"></path></svg>,
            Flame: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a7 7 0 0 0 3 3.3z"></path></svg>,
            Cup: ({className}) => <svg className={className} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M18 8h1a4 4 0 0 1 0 8h-1"></path><path d="M2 8h16v9a4 4 0 0 1-4 4H6a4 4 0 0 1-4-4V8z"></path><line x1="6" y1="1" x2="6" y2="4"></line><line x1="10" y1="1" x2="10" y2="4"></line><line x1="14" y1="1" x2="14" y2="4"></line></svg>
        };

        const App = () => {
            const [blocks, setBlocks] = useState([]);
            const [events, setEvents] = useState([]);
            const [dateStr, setDateStr] = useState('');
            const [totalDuration, setTotalDuration] = useState(0);
            const [wakeUpTime, setWakeUpTime] = useState(null); // [Ï∂îÍ∞Ä] Í∏∞ÏÉÅ ÏãúÍ∞Ñ ÏÉÅÌÉú

            // Î°úÏª¨ Îç∞Ïù¥ÌÑ∞ Î°úÎìú
            const loadData = () => {
                const savedData = JSON.parse(localStorage.getItem('fortressData') || '{}');
                const now = new Date();
                const today = now.toDateString();
                
                if (savedData.date === today && savedData.blocks) {
                    setBlocks(savedData.blocks);
                    const focusBlocks = savedData.blocks.filter(b => !b.type || b.type === 'focus');
                    const total = focusBlocks.reduce((acc, curr) => acc + curr.duration, 0);
                    setTotalDuration(total);
                    setWakeUpTime(savedData.wakeUpTime || null); // [Ï∂îÍ∞Ä] Í∏∞ÏÉÅ ÏãúÍ∞Ñ Î∂àÎü¨Ïò§Í∏∞
                } else {
                    setBlocks([]);
                    setTotalDuration(0);
                    setWakeUpTime(null);
                }
                
                const month = now.getMonth() + 1;
                const date = now.getDate();
                const m = String(month).padStart(2, '0');
                const d = String(date).padStart(2, '0');
                const days = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'];
                const day = days[now.getDay()];
                setDateStr(`${m}/${d} ${day}`);
            };

            useEffect(() => {
                loadData();
                const interval = setInterval(loadData, 3000); 
                return () => clearInterval(interval);
            }, []);

            // [ÎèôÍ∏∞Ìôî]
            const syncFromServer = async () => {
                const now = new Date();
                const y = now.getFullYear();
                const m = String(now.getMonth() + 1).padStart(2, '0');
                const d = String(now.getDate()).padStart(2, '0');
                const dateYMD = `${y}-${m}-${d}`;

                // 1. Ï∫òÎ¶∞Îçî
                try {
                    const calRes = await fetch(`${CALENDAR_API}?type=calendar`);
                    if (calRes.ok) {
                        const calData = await calRes.json();
                        if (Array.isArray(calData)) {
                            setEvents(calData);
                        }
                    }
                } catch (e) {
                    console.error("Calendar Sync Error:", e);
                }

                // 2. Ìè¨Ìä∏Î¶¨Ïä§ Í∏∞Î°ù
                if (WORKER_URL && !WORKER_URL.includes("your-worker")) {
                    try {
                        const res = await fetch(`${WORKER_URL}?date=${dateYMD}`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data.blocks && Array.isArray(data.blocks)) {
                                setBlocks(prev => {
                                    const prevStr = JSON.stringify(prev);
                                    const newStr = JSON.stringify(data.blocks);
                                    // Îç∞Ïù¥ÌÑ∞Í∞Ä Îã§Î•¥Í±∞ÎÇò, Í∏∞ÏÉÅÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏Í∞Ä ÌïÑÏöîÌïòÎ©¥ Ï†ÄÏû•
                                    const currentLocal = JSON.parse(localStorage.getItem('fortressData') || '{}');
                                    const savedWakeUp = currentLocal.wakeUpTime;
                                    
                                    // Í∏∞ÏÉÅ ÏãúÍ∞ÑÏù¥ÎÇò Î∏îÎ°ùÏù¥ Îã§Î•¥Î©¥ ÏóÖÎç∞Ïù¥Ìä∏
                                    if (prevStr !== newStr || savedWakeUp !== data.wakeUpTime) {
                                        localStorage.setItem('fortressData', JSON.stringify({
                                            ...currentLocal,
                                            blocks: data.blocks,
                                            wakeUpTime: data.wakeUpTime || savedWakeUp // [Ï∂îÍ∞Ä] Í∏∞ÏÉÅ ÏãúÍ∞Ñ ÏóÖÎç∞Ïù¥Ìä∏
                                        }));
                                        // Î¶¨ÌÑ¥Í∞íÏùÄ blocks ÏÉÅÌÉú Í∞±Ïã†Ïö©
                                        return data.blocks;
                                    }
                                    return prev;
                                });
                                // stateÏóê wakeUpTime Î∞òÏòÅ (loadDataÏóêÏÑú Ï≤òÎ¶¨ÌïòÏßÄÎßå Ï¶âÏãú Î∞òÏòÅÏùÑ ÏúÑÌï¥)
                                if (data.wakeUpTime && data.wakeUpTime !== "-") {
                                    setWakeUpTime(data.wakeUpTime);
                                }
                            }
                        }
                    } catch (e) {
                        console.error("Block Sync Error:", e);
                    }
                }
            };

            useEffect(() => {
                syncFromServer();
                const interval = setInterval(syncFromServer, 60000); 
                return () => clearInterval(interval);
            }, []);

            const getTotalColorClass = (min) => {
                if (min <= 90) return "text-white"; 
                if (min <= 330) return "text-sky-custom"; 
                return "text-purple-custom";               
            };

            const formatDuration = (totalMin) => {
                const h = Math.floor(totalMin / 60);
                const m = totalMin % 60;
                const colorClass = getTotalColorClass(totalMin);

                return (
                    <span className={`font-mono-nums ${colorClass} transition-colors duration-500`}>
                        <span className="text-xl font-bold">{h}</span><span className="text-xs mx-0.5 opacity-80 font-bold">H</span>
                        <span className="text-xl font-bold">{String(m).padStart(2, '0')}</span><span className="text-xs ml-0.5 opacity-80 font-bold">M</span>
                    </span>
                );
            };

            const getMessage = (min) => {
                const now = new Date();
                const currentHour = now.getHours();
                const stableIdx = now.getDate() % 3; 

                if (currentHour >= 13 && min === 0) {
                    const msgs = [
                        { main: "üßä ÏïÑÏßÅ ÏãúÏûë Ï†ÑÏù¥ÎÑ§Ïöî.", sub: "ÏßÄÍ∏à Î∞îÎ°ú Ï≤´ Î∏îÎ°ùÏùÑ ÏåìÏïÑÎ≥¥ÏÑ∏Ïöî." },
                        { main: "‚ùÑÔ∏è ÏãúÏûëÏù¥ Î∞òÏûÖÎãàÎã§.", sub: "Í∞ÄÎ≥çÍ≤å Ï±ÖÏÉÅÏóê ÏïâÏïÑÎ≥ºÍπåÏöî?" },
                        { main: "üï∞Ô∏è ÏïÑÏßÅ Îä¶ÏßÄ ÏïäÏïòÏñ¥Ïöî.", sub: "ÏßÄÍ∏à Ï∂úÎ∞úÌïòÎ©¥ Ï∂©Î∂ÑÌï©ÎãàÎã§." }
                    ];
                    return msgs[stableIdx];
                }

                if (currentHour >= 18 && blocks.length > 0) {
                    const sunCount = blocks.filter(b => b.quality === 'Sun').length;
                    const cloudyCount = blocks.filter(b => b.quality === 'Cloud').length;
                    const rainCount = blocks.filter(b => b.quality === 'Rain').length;

                    if (sunCount >= cloudyCount && sunCount >= rainCount) {
                        return { main: "üåü Ïò§Îäò Î™∞ÏûÖÎèÑ ÏµúÍ≥†Ï°∞!", sub: "Îã®Îã®Ìïú ÏöîÏÉàÍ∞Ä ÏôÑÏÑ±ÎêòÏóàÏäµÎãàÎã§." };
                    }
                    if (cloudyCount >= sunCount && cloudyCount >= rainCount) {
                        return { main: "‚òÅÔ∏è Î¨¥ÎçòÌïòÍ≤å Ïûò Î≤ÑÌÖºÏäµÎãàÎã§.", sub: "Íæ∏Ï§ÄÌï®Ïù¥ Í∞ÄÏû• Í∞ïÎ†•Ìïú Î¨¥Í∏∞ÏûÖÎãàÎã§." };
                    }
                    if (rainCount > sunCount && rainCount > cloudyCount) {
                        return { main: "‚òî ÎπÑÍ∞Ä ÏôÄÎèÑ Í¥úÏ∞ÆÏäµÎãàÎã§.", sub: "ÎÇ¥ÏùºÏùÄ Ï°∞Í∏à Îçî ÎßëÏïÑÏßà Í±∞ÏòàÏöî." };
                    }
                }

                if (min === 0) return { main: "‚ùÑÔ∏è Ï§ÄÎπÑ ÎêòÏÖ®ÎÇòÏöî?", sub: "Ï∞®Í∑ºÏ∞®Í∑º Ï†êÌôîÎ•º ÏãúÏûëÌï¥ Î¥ÖÏãúÎã§." };
                
                if (min < 60) {
                    return [{ main: "üå± ÏùòÎØ∏ ÏûàÎäî ÏãúÏûëÏûÖÎãàÎã§.", sub: "Í∞ÄÎ≥çÍ≤å Î¶¨Îì¨ÏùÑ ÌÉÄÎ≥¥ÏÑ∏Ïöî." }, { main: "‚ú® Ï≤´ Îã®Ï∂îÎ•º Íø∞ÏóàÏäµÎãàÎã§.", sub: "Ïò§ÎäòÏùò ÏãúÏä§ÌÖúÏù¥ Í∞ÄÎèô Ï§ëÏûÖÎãàÎã§." }, { main: "üßä Ï∞®Î∂ÑÌïú Ï∂úÎ∞úÏù¥ÎÑ§Ïöî.", sub: "Ïù¥ÎåÄÎ°úÎßå Ï≠â Í∞ÄÎ©¥ Îê©ÎãàÎã§." }][stableIdx];
                }
                
                if (min < 180) {
                    return [{ main: "üß± Í≤¨Í≥†ÌïòÍ≤å ÏåìÎäî Ï§ëÏûÖÎãàÎã§.", sub: "ÌùîÎì§Î¶¨ÏßÄ ÏïäÎäî ÏãúÍ∞ÑÏù¥ Î©ãÏ†∏Ïöî." }, { main: "‚òÅÔ∏è ÌõåÎ•≠Ìïú ÌéòÏù¥Ïä§ÏûÖÎãàÎã§.", sub: "Î¨¥ÎçòÌïòÍ≤å Í≥ÑÏÜç ÎÇòÏïÑÍ∞ÄÏÑ∏Ïöî." }, { main: "‚öñÔ∏è Í∑†Ìòï Ïû°Ìûå Î™∞ÏûÖÏûÖÎãàÎã§.", sub: "ÏûòÌïòÍ≥† ÏûàÏäµÎãàÎã§." }][stableIdx];
                }
                
                if (min < 300) {
                    return [{ main: "üî• Îú®Í±∞Ïö¥ Î™∞ÏûÖÏùò ÏãúÍ∞Ñ.", sub: "Ïù¥ÎØ∏ Ï∂©Î∂ÑÌûà ÌõåÎ•≠Ìïú ÌïòÎ£®ÏòàÏöî." }, { main: "üíé Ï†ïÎßê ÎåÄÎã®Ìïú ÏßëÏ§ëÎ†•.", sub: "Ïò§Îäò ÌïòÎ£®, ÎπõÎÇòÍ≥† ÏûàÏäµÎãàÎã§." }, { main: "üöÄ ÌïúÍ≥ÑÎ•º ÎÑìÌûàÎäî Ï§ë.", sub: "ÎãπÏã†Ïùò ÎÖ∏Î†•Ïù¥ ÏåìÏù¥Í≥† ÏûàÏñ¥Ïöî." }][stableIdx];
                }

                return [{ main: "üéñÔ∏è ÌïúÍ≥ÑÎ•º ÎÑòÏùÄ ÏÑ±Ï∑®ÏûÖÎãàÎã§.", sub: "Ï∂©Î∂ÑÌûà Ïï†ÏçºÏúºÎãà, Ìú¥ÏãùÏùÑ Í∂åÏû•Ìï¥Ïöî." }, { main: "üåå Í≤ΩÏù¥Î°úÏö¥ Í∏∞Î°ùÏù¥ÎÑ§Ïöî.", sub: "Ïù¥Ï†ú Ìé∏ÏïàÌûà Ïâ¨Ïñ¥ÎèÑ Îê©ÎãàÎã§." }, { main: "üåô ÏπòÏó¥ÌñàÎçò ÌïòÎ£®Ïùò ÎÅù.", sub: "Ïä§Ïä§Î°úÎ•º Ïπ≠Ï∞¨Ìï¥ Ï£ºÏÑ∏Ïöî." }][stableIdx];
            };

            const renderGrid = () => {
                const hours = Array.from({length: 18}, (_, i) => i + 6); 

                // [ÏàòÏ†ï] Îçî ÌôïÏã§Ìïú Î∞òÏò¨Î¶º Ìï®Ïàò (Math.round ÏÇ¨Ïö©)
                // 32Î∂Ñ -> 3.2 -> 3 -> 30Î∂Ñ (ÎÇ¥Î¶º)
                // 35Î∂Ñ -> 3.5 -> 4 -> 40Î∂Ñ (Ïò¨Î¶º)
                // 45Î∂Ñ -> 4.5 -> 5 -> 50Î∂Ñ (Ïò¨Î¶º)
                const roundTime = (ts) => {
                    const d = new Date(ts);
                    const m = d.getMinutes();
                    const roundedM = Math.round(m / 10) * 10; 
                    d.setMinutes(roundedM);
                    d.setSeconds(0); 
                    d.setMilliseconds(0);
                    return d.getTime();
                };

                return hours.map(hour => {
                    const slots = Array.from({length: 6}, (_, i) => {
                        const slotStartMin = i * 10;
                        const slotEndMin = (i + 1) * 10;
                        const slotStartTime = new Date();
                        slotStartTime.setHours(hour, slotStartMin, 0, 0);
                        const slotStartTs = slotStartTime.getTime();
                        
                        let isBeforeWakeUp = false;
                        let isWakeUpSlot = false;

                        if (wakeUpTime) {
                            const [wH, wM] = wakeUpTime.split(':').map(Number);
                            const wakeUpDate = new Date();
                            wakeUpDate.setHours(wH, wM, 0, 0);
                            const wakeUpTs = wakeUpDate.getTime();
                            const slotEndTimeTmp = new Date(slotStartTs + 10 * 60 * 1000).getTime();

                            // 1. Ìà¨Î™ÖÌôî Ï≤¥ÌÅ¨
                            if (slotStartTs < wakeUpTs) {
                                isBeforeWakeUp = true;
                            }

                            // 2. Ìï¥ ÏïÑÏù¥ÏΩò Ï≤¥ÌÅ¨ (Í∏∞ÏÉÅ ÏãúÍ∞ÑÏù¥ ÌòÑÏû¨ Ïä¨Î°Ø Î≤îÏúÑ Ïïà(Ï¥àÍ≥º~Ïù¥Ìïò)Ïóê ÏûàÏùÑ Îïå)
                            // Ïòà: 06:22 Í∏∞ÏÉÅ -> 20Î∂Ñ Ï¥àÍ≥º 30Î∂Ñ Ïù¥Ìïò -> 20~30Î∂Ñ Ïä¨Î°Ø(Îëê Î≤àÏß∏ Ïπ∏)Ïóê ÏïÑÏù¥ÏΩò ÌëúÏãú
                            if (wakeUpTs > slotStartTs && wakeUpTs <= slotEndTimeTmp) {
                                isWakeUpSlot = true;
                                isBeforeWakeUp = false; 
                            }
                        }

                        const slotEndTime = new Date();
                        slotEndTime.setHours(hour, slotEndMin, 0, 0);
                        const slotEndTs = slotEndTime.getTime();
                        
                        // [ÏàòÏ†ï] Î∞∞Í≤Ω Î∏îÎ°ù Î°úÏßÅ: Î∞òÏò¨Î¶ºÎêú ÏãúÍ∞Ñ Ï†ÅÏö©
                        const bgBlock = blocks.find(b => {
                            if (b.type !== 'focus' && b.type) return false;
                            
                            const roundedStart = roundTime(b.startTime);
                            const roundedEnd = roundTime(b.endTime);
                            
                            // *Ï§ëÏöî*: ÎßåÏïΩ Î∞òÏò¨Î¶º Í≤∞Í≥º ÏãúÏûëÍ≥º ÎÅùÏù¥ Í∞ôÎã§Î©¥(Ïòà: ÏßßÏùÄ ÏãúÍ∞Ñ), ÏµúÏÜå Ìïú Ïπ∏ÏùÄ Î≥¥Ïó¨Ï£ºÍ∏∞ ÏúÑÌï¥ ÎÅù ÏãúÍ∞ÑÏùÑ 10Î∂Ñ ÎäòÎ¶º
                            const finalEnd = (roundedStart === roundedEnd) ? roundedEnd + (10 * 60 * 1000) : roundedEnd;

                            // ÌòÑÏû¨ Ïä¨Î°ØÏù¥ [ÏãúÏûë, ÎÅù) Î≤îÏúÑ ÏïàÏóê ÏûàÎäîÏßÄ Ï≤¥ÌÅ¨
                            return slotStartTs >= roundedStart && slotStartTs < finalEnd;
                        });

                        const iconBlock = blocks.find(b => {
                            if (b.type === 'focus' || !b.type) return false;
                            return b.endTime > slotStartTs && b.endTime <= slotEndTs;
                        });

                        const slotCenter = slotStartTs + (5 * 60 * 1000); 
                        const calendarEvent = events.find(ev => ev.startTime <= slotCenter && ev.endTime >= slotCenter);

                        let cellClass = 'block-empty';
                        let content = null;
                        let lineOverlay = null;

                        // ÌÅ¥ÎûòÏä§ Ï†ÅÏö©
                        if (isBeforeWakeUp && !bgBlock && !isWakeUpSlot) {
                            cellClass = 'opacity-0'; 
                        }
                        else if (bgBlock) {
                            if (bgBlock.quality === 'Sun') cellClass = 'block-sun';
                            else if (bgBlock.quality === 'Cloud') cellClass = 'block-cloud';
                            else cellClass = 'block-rain';
                        } 
                        else if (iconBlock) {
                            cellClass = 'block-action-bg';
                        }

                        if (isWakeUpSlot) {
                            if (!cellClass.includes('flex')) cellClass += ' relative flex items-center justify-center';
                            content = <Icons.Sun className="w-4 h-4 text-white relative z-10 drop-shadow-md" />;
                        }
                        else if (iconBlock) {
                            const IconComp = Icons[iconBlock.icon] || (iconBlock.type === 'switch' ? Icons.Zap : Icons.Zzz);
                            const iconColor = bgBlock ? 'text-white' : (iconBlock.color || 'text-white');
                            if (!cellClass.includes('flex')) cellClass += ' relative flex items-center justify-center';
                            content = <IconComp className={`w-4 h-4 ${iconColor} relative z-10 drop-shadow-md`} />;
                        }

                        if (calendarEvent) {
                            const category = calendarEvent.category || 'default';
                            const colorClass = categoryColors[category] || categoryColors['default'];
                            
                            lineOverlay = (
                                <div className={`absolute w-[80%] h-[2px] rounded-full left-[10%] top-[48%] z-20 ${colorClass}`} 
                                     title={calendarEvent.title} 
                                />
                            );
                            
                            if (!content && !bgBlock) {
                                cellClass += ' relative'; 
                            }
                        }

                        return (
                            <div key={i} className={`time-block ${cellClass}`}>
                                {lineOverlay}
                                {content}
                            </div>
                        )
                    });
                    return (
                        <div key={hour} className="grid-row">
                            <div className="time-label">{String(hour).padStart(2,'0')}</div>
                            <div className="blocks-container">{slots}</div>
                        </div>
                    );
                });
            };

            const msg = getMessage(totalDuration);

            return (
                <div className="widget-container">
                    <div className="px-4 pt-5 pb-2 flex justify-between items-end border-b border-white/20 bg-white/15 backdrop-blur-sm z-10 shrink-0">
                        <div>
                            <div className="text-white text-[10px] font-bold tracking-widest uppercase mb-0.5 opacity-90 font-mono-nums">{dateStr}</div>
                            <div className="leading-none mt-1">
                                {formatDuration(totalDuration)}
                            </div>
                        </div>
                    </div>

                    {/* [ÏàòÏ†ï] flex -> gridÎ°ú Î≥ÄÍ≤ΩÌïòÏó¨ ÏïÑÎûò Î∏îÎ°ùÍ≥º Í∞ÑÍ≤©(2px) ÎèôÍ∏∞Ìôî & Ïò§Î•∏Ï™Ω Ï†ïÎ†¨ */}
                     <div className="grid grid-cols-6 gap-[2px] mb-0.5 pl-[20px] pr-[6px] shrink-0">
                        {[10, 20, 30, 40, 50, 60].map(m => (
                            <div key={m} className="text-right text-[6px] text-white/40 font-mono-nums">{m}</div>
                        ))}
                     </div>
                        <div className="grid-container">{renderGrid()}</div>
                    </div>

                    <div className="footer-blur px-4 pt-3 pb-3 z-10 shrink-0">
                        <div className="text-center flex flex-col justify-center h-auto">
                            <p className="text-xs font-bold text-white leading-tight drop-shadow-md mb-1">{msg.main}</p>
                            <p className="text-[10px] text-sky-200 leading-tight opacity-90">{msg.sub}</p>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
