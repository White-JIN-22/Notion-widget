<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="color-scheme" content="dark light">
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weekly Goals</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: transparent;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        ::-webkit-scrollbar { display: none; }
        
        .widget-container {
            position: relative;
            width: 440px;
            height: 320px;
            background: linear-gradient(180deg, rgba(224, 242, 254, 0.25) 0%, rgba(240, 249, 255, 0.15) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(186, 230, 253, 0.15), inset 0 0 20px rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #334155;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.8);
            flex-shrink: 0;
        }

        .glass-footer {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-top: 1px solid rgba(255, 255, 255, 0.8);
            flex-shrink: 0;
        }

        .glass-section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
        }

        .block-bar {
            display: flex;
            gap: 3px;
        }

        .block {
            width: 14px;
            height: 8px;
            border-radius: 2px;
            background: rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }

        .block.filled {
            box-shadow: 0 0 6px currentColor;
        }

        .font-mono { font-family: 'Roboto Mono', monospace; }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        purple: { 300: '#d8b4fe', 100: '#f3e8ff' },
                        sky: { 300: '#7dd3fc', 100: '#e0f2fe', 400: '#38bdf8' },
                        yellow: { 200: '#fef08a', 300: '#fde047', 400: '#facc15' },
                        slate: { 400: '#94a3b8', 600: '#475569' }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans KR"', '-apple-system', 'sans-serif'],
                        mono: ['"Roboto Mono"', 'monospace']
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const LOG_WORKER_URL = "https://log-worker.moonkelly601.workers.dev";
        const FEEDBACK_WORKER_URL = "https://feedback-worker.moonkelly601.workers.dev";

        // 주간 목표
        const TARGETS = {
            exercise: 5,       // 운동 (회)
            lesson: 600,       // 수업준비 (분) - 2시간 × 5일
            english: 2,        // 영어 (회)
            japanese: 3,       // 일어 (회)
            reading: 300,      // 독서 (분)
            record: 5,         // 기록 (회)
            coding: 480        // 코딩 (분) - 8시간
        };

        // 아이콘
        const IconSparkle = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 2l3 7 7 3-7 3-3 7-3-7-7-3 7-3z"></path>
            </svg>
        );

        const IconClipboard = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"></path>
                <rect x="8" y="2" width="8" height="4" rx="1" ry="1"></rect>
            </svg>
        );

        const IconBook = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
        );

        const IconPen = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
            </svg>
        );

        const IconFlame = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a7 7 0 0 0 3 3.3z"></path>
            </svg>
        );

        const IconTrophy = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"></path>
                <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"></path>
                <path d="M4 22h16"></path>
                <path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"></path>
                <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"></path>
                <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"></path>
            </svg>
        );

        const IconMessage = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        );

        // 데이터 집계
        const analyzeBlocks = (blocks) => {
            const stats = { exercise: 0, lesson: 0, english: 0, japanese: 0, reading: 0, record: 0, coding: 0 };

            blocks.forEach(b => {
                const content = ((b.name || "") + " " + (b.memo || "")).toLowerCase();
                const duration = b.duration || 0;

                // 횟수 기반 (최소 시간 충족 시에만 카운트)
                if ((content.includes("산책") || content.includes("운동") || content.includes("러닝")) && duration >= 10) stats.exercise += 1;
                if ((content.includes("영어") || content.includes("보카")) && duration >= 15) stats.english += 1;
                if ((content.includes("일어") || content.includes("일본어") || content.includes("상용한자")) && duration >= 15) stats.japanese += 1;
                if ((content.includes("기록") || content.includes("일기") || content.includes("상담")) && duration >= 10) stats.record += 1;

                // 시간 기반
                if (content.includes("독서") || content.includes("책")) stats.reading += duration;
                if (content.includes("위젯") || content.includes("개발") || content.includes("디버깅") || content.includes("개선")) stats.coding += duration;
                if (content.includes("수업") || content.includes("교안") || content.includes("행정") || content.includes("강의") || content.includes("상상코칭") || content.includes("바인")) stats.lesson += duration;
            });

            return stats;
        };

        const getPercent = (current, target) => Math.min(100, Math.round((current / target) * 100));

        const formatMinutes = (mins) => {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            if (h > 0 && m > 0) return `${h}시간 ${m}분`;
            if (h > 0) return `${h}시간`;
            return `${m}분`;
        };

        const formatTarget = (mins) => {
            const h = Math.floor(mins / 60);
            const m = mins % 60;
            if (m > 0) return `${h}시간 ${m}분`;
            return `${h}시간`;
        };

        // 주간 날짜 (일~토)
        const getWeekDates = () => {
            const now = new Date();
            const day = now.getDay();
            const sunday = new Date(now);
            sunday.setDate(now.getDate() - day);
            sunday.setHours(0, 0, 0, 0);
            
            const dates = [];
            for (let i = 0; i < 7; i++) {
                const d = new Date(sunday);
                d.setDate(sunday.getDate() + i);
                if (d <= now) {
                    const y = d.getFullYear();
                    const m = String(d.getMonth() + 1).padStart(2, '0');
                    const dd = String(d.getDate()).padStart(2, '0');
                    dates.push(`${y}-${m}-${dd}`);
                }
            }
            return dates;
        };

        const getTodayStr = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
        };

        // 블럭 프로그래스 바
        const BlockBar = ({ percent, color, blockCount = 10 }) => {
            const filledCount = Math.round((percent / 100) * blockCount);
            return (
                <div className="block-bar">
                    {[...Array(blockCount)].map((_, i) => (
                        <div 
                            key={i} 
                            className={`block ${i < filledCount ? 'filled' : ''}`}
                            style={{ backgroundColor: i < filledCount ? color : undefined, color }}
                        />
                    ))}
                </div>
            );
        };

        // 폴백 피드백 생성
        const generateFallbackFeedback = (percents) => {
            const avg = Math.round(Object.values(percents).reduce((a, b) => a + b, 0) / 7);
            const items = Object.entries(percents).map(([k, v]) => ({ name: k, p: v }));
            const best = items.reduce((a, b) => a.p > b.p ? a : b);
            const worst = items.reduce((a, b) => a.p < b.p ? a : b);

            const labels = { exercise: '운동', lesson: '수업준비', english: '영어', japanese: '일어', reading: '독서', record: '기록', coding: '코딩' };

            if (avg === 0) return "아직 시작 전이야. 오늘 딱 하나만 해보자.";
            if (worst.p === 0) return `${labels[worst.name]}이 아직 0%야. 오늘 10분만 시도해봐.`;
            if (avg < 40) return `${labels[best.name]} ${best.p}% 진행 중! ${labels[worst.name]}도 조금씩 해보자.`;
            if (avg < 60) return `절반 가까이 왔어. ${labels[best.name]}에서 리드 중이야.`;
            if (avg < 80) return `${avg}% 달성! 주도권 회복 중이야.`;
            return `목표 달성이 눈앞! ${labels[best.name]} ${best.p}% 대단해.`;
        };

        // 메인 컴포넌트
        const WeeklyGoal = () => {
            const [stats, setStats] = useState({ exercise: 0, lesson: 0, english: 0, japanese: 0, reading: 0, record: 0, coding: 0 });
            const [loading, setLoading] = useState(true);
            const [feedback, setFeedback] = useState('');
            const [feedbackLoading, setFeedbackLoading] = useState(false);

            useEffect(() => {
                const fetchWeekData = async () => {
                    try {
                        const dates = getWeekDates();
                        const allBlocks = [];
                        
                        for (const dateStr of dates) {
                            try {
                                const res = await fetch(`${LOG_WORKER_URL}?date=${dateStr}`);
                                if (res.ok) {
                                    const data = await res.json();
                                    if (data.blocks && Array.isArray(data.blocks)) {
                                        allBlocks.push(...data.blocks);
                                    }
                                }
                            } catch (e) {
                                console.error(`Fetch error for ${dateStr}:`, e);
                            }
                        }
                        
                        const analyzed = analyzeBlocks(allBlocks);
                        setStats(analyzed);
                    } catch (e) {
                        console.error('Fetch error:', e);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchWeekData();
            }, []);

            // 피드백 가져오기 (stats 변경 시)
            useEffect(() => {
                if (loading) return;

                const percents = {
                    exercise: getPercent(stats.exercise, TARGETS.exercise),
                    lesson: getPercent(stats.lesson, TARGETS.lesson),
                    english: getPercent(stats.english, TARGETS.english),
                    japanese: getPercent(stats.japanese, TARGETS.japanese),
                    reading: getPercent(stats.reading, TARGETS.reading),
                    record: getPercent(stats.record, TARGETS.record),
                    coding: getPercent(stats.coding, TARGETS.coding)
                };

                const fetchFeedback = async () => {
                    const today = getTodayStr();
                    const cacheKey = `weeklyFeedback_${today}_${JSON.stringify(percents)}`;
                    
                    // 오래된 캐시 정리 (오늘 + 현재 퍼센트 아닌 것들)
                    try {
                        Object.keys(localStorage).forEach(key => {
                            if (key.startsWith('weeklyFeedback_') && key !== cacheKey) {
                                localStorage.removeItem(key);
                            }
                        });
                    } catch (e) {}
                    
                    // localStorage 캐시 확인
                    const cached = localStorage.getItem(cacheKey);
                    if (cached) {
                        setFeedback(cached);
                        return;
                    }

                    setFeedbackLoading(true);
                    try {
                        const res = await fetch(FEEDBACK_WORKER_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ stats: percents, date: today, type: 'weekly' })
                        });

                        if (res.ok) {
                            const data = await res.json();
                            setFeedback(data.feedback);
                            localStorage.setItem(cacheKey, data.feedback);
                            
                            // 오래된 캐시 정리 (3일 이상)
                            Object.keys(localStorage).forEach(key => {
                                if (key.startsWith('weeklyFeedback_') && !key.includes(today)) {
                                    const dateMatch = key.match(/weeklyFeedback_(\d{4}-\d{2}-\d{2})/);
                                    if (dateMatch) {
                                        const keyDate = new Date(dateMatch[1]);
                                        const now = new Date();
                                        if ((now - keyDate) > 3 * 24 * 60 * 60 * 1000) {
                                            localStorage.removeItem(key);
                                        }
                                    }
                                }
                            });
                        } else {
                            setFeedback(generateFallbackFeedback(percents));
                        }
                    } catch (e) {
                        console.error('Feedback fetch error:', e);
                        setFeedback(generateFallbackFeedback(percents));
                    } finally {
                        setFeedbackLoading(false);
                    }
                };

                fetchFeedback();
            }, [loading, stats]);

            const percents = {
                exercise: getPercent(stats.exercise, TARGETS.exercise),
                lesson: getPercent(stats.lesson, TARGETS.lesson),
                english: getPercent(stats.english, TARGETS.english),
                japanese: getPercent(stats.japanese, TARGETS.japanese),
                reading: getPercent(stats.reading, TARGETS.reading),
                record: getPercent(stats.record, TARGETS.record),
                coding: getPercent(stats.coding, TARGETS.coding)
            };

            const avgPercent = Math.round(Object.values(percents).reduce((a, b) => a + b, 0) / 7);

            const colors = { purple: '#d8b4fe', sky: '#7dd3fc', yellow: '#fef08a' };

            const goals = [
                { label: "운동", percent: percents.exercise, color: colors.purple, display: `${stats.exercise}/${TARGETS.exercise}회`, Icon: IconSparkle },
                { label: "수업", percent: percents.lesson, color: colors.purple, display: `${formatMinutes(stats.lesson)} / ${formatTarget(TARGETS.lesson)}`, Icon: IconClipboard },
                { label: "영어", percent: percents.english, color: colors.yellow, display: `${stats.english}/${TARGETS.english}회`, Icon: IconFlame },
                { label: "일어", percent: percents.japanese, color: colors.yellow, display: `${stats.japanese}/${TARGETS.japanese}회`, Icon: IconFlame },
                { label: "독서", percent: percents.reading, color: colors.sky, display: `${formatMinutes(stats.reading)} / ${formatTarget(TARGETS.reading)}`, Icon: IconBook },
                { label: "기록", percent: percents.record, color: colors.sky, display: `${stats.record}/${TARGETS.record}회`, Icon: IconPen },
                { label: "코딩", percent: percents.coding, color: colors.sky, display: `${formatMinutes(stats.coding)} / ${formatTarget(TARGETS.coding)}`, Icon: IconFlame }
            ];

            if (loading) {
                return (
                    <div className="widget-container items-center justify-center">
                        <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        <div className="text-xs text-white/60 mt-2">데이터 수집 중...</div>
                    </div>
                );
            }

            return (
                <div className="widget-container">
                    
                    {/* Header */}
                    <div className="glass-header px-5 py-1.5 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <IconTrophy className="w-4 h-4" color="white" />
                            <h1 className="text-[13px] font-bold text-white tracking-tight">신체와 환경의 주도권 회복</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-mono text-white/70">{avgPercent}%</span>
                            <BlockBar percent={avgPercent} color="white" blockCount={10} />
                        </div>
                    </div>

                    {/* Content */}
                    <div className="flex-1 p-3 flex flex-col gap-2">
                        
                        {/* Goals Grid - 7개 */}
                        <div className="glass-section p-3 flex-1">
                            <div className="grid grid-cols-2 gap-x-5 gap-y-2">
                                {goals.slice(0, 6).map((item, i) => (
                                    <div key={i} className="flex flex-col gap-1">
                                        <div className="flex items-baseline w-[170px]">
                                            <div className="flex items-center gap-1">
                                                <item.Icon className="w-3 h-3" color={item.color} />
                                                <span className="text-[11px] font-medium" style={{ color: item.color }}>{item.label}</span>
                                            </div>
                                            <span className="text-[9px] font-mono text-white/50 ml-auto">{item.display}</span>
                                        </div>
                                        <BlockBar percent={item.percent} color={item.color} blockCount={10} />
                                    </div>
                                ))}
                            </div>
                            {/* 코딩 - 전체 너비 */}
                            {(() => {
                                const coding = goals[6];
                                return (
                                    <div className="mt-2 flex flex-col gap-1">
                                        <div className="flex items-baseline w-[170px]">
                                            <div className="flex items-center gap-1">
                                                <coding.Icon className="w-3 h-3" color={coding.color} />
                                                <span className="text-[11px] font-medium" style={{ color: coding.color }}>{coding.label}</span>
                                            </div>
                                            <span className="text-[9px] font-mono text-white/50 ml-auto">{coding.display}</span>
                                        </div>
                                        <BlockBar percent={coding.percent} color={coding.color} blockCount={10} />
                                    </div>
                                );
                            })()}
                        </div>
                    </div>

                    {/* Footer - 피드백 (2배 높이) */}
                    <div className="glass-footer px-4 py-2 flex items-start gap-2.5" style={{ minHeight: '64px' }}>
                        <IconMessage className="w-4 h-4 shrink-0 mt-0.5" color="rgba(255,255,255,0.7)" />
                        <p className="text-[11px] text-white/80 leading-relaxed">
                            {feedbackLoading ? '피드백 생성 중...' : feedback}
                        </p>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WeeklyGoal />);
    </script>
</body>
</html>
