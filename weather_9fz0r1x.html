<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<meta name="referrer" content="no-referrer">
<title>Weather + Air Quality Widget (Í∏àÏ¥å2Îèô)</title>
<style>
  body {
    margin: 0;
    background: #1a1a1a;
    color: #eaeaea;
    font-family: "Inter", sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }

  .widget {
    background: #242424;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.4);
    padding: 10px 14px 14px;
    width: 420px;
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .weather-bar {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 5px;
    flex-wrap: nowrap;
    margin-bottom: 6px;
  }

  .temp {
    font-size: 1.8rem;
    font-weight: 600;
    color: #ffffff;
  }

  .air {
    font-weight: 600;
    white-space: nowrap;
  }
  .air.good { color: #4fa3ff; }
  .air.normal { color: #7ed957; }
  .air.bad { color: #ff9b4a; }
  .air.verybad { color: #f35a5a; }

  .icon-block {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-size: 0.9rem;
    color: #cfd2d6;
  }
  .icon-block img {
    width: 24px;
    height: 24px;
    margin-bottom: 3px;
  }

  hr {
    width: 100%;
    border: none;
    border-top: 1px solid #ddd;
    margin: 5px 0 9px;
  }

  .week {
    display: flex;
    justify-content: space-between;
    width: 100%;
    gap: 2px;
  }
  .day {
    text-align: center;
    flex: 1;
  }
  .day span {
    display: block;
    font-size: 0.8rem;
  }
  .icon {
    margin: 2px 0;
    width: 20px;
    height: 20px;
    opacity: 0.9;
  }
</style>
</head>
<body>
  <div class="widget">
    <div class="weather-bar">
      <div class="air" id="air">Loading...</div>
      <div class="temp" id="temp">--¬∞C</div>
      <div class="icon-block"><img id="nowIcon" alt=""><span>ÏßÄÍ∏à</span></div>
      <div class="icon-block"><img id="morningIcon" alt=""><span>Ïò§Ï†Ñ</span></div>
      <div class="icon-block"><img id="noonIcon" alt=""><span>ÎÇÆ</span></div>
      <div class="icon-block"><img id="eveningIcon" alt=""><span>Ï†ÄÎÖÅ</span></div>
    </div>
    <hr>
    <div class="week" id="week"></div>
  </div>

<script>
// ‚úÖ Cloudflare Worker Proxy ÏÑ§Ï†ï
const proxy = "https://air.moonkelly601.workers.dev/?url=";

// ‚úÖ Î∞òÎìúÏãú ÎÑ§ Î∞úÍ∏âÎ∞õÏùÄ ÏùºÎ∞ò Ïù∏Ï¶ùÌÇ§Î°ú ÍµêÏ≤¥
const serviceKey = encodeURIComponent("3c85c571c5d7ec71beb5cf7af70fdae04c1f6e281cfac671a4604aedb9f7781a");

// üå´ ÎØ∏ÏÑ∏Î®ºÏßÄ (Í∏àÏ¥å2Îèô Ï∏°Ï†ïÏÜå)
async function getAirQuality() {
  const target = `https://apis.data.go.kr/B552584/RltmKhaiInfoSvc/getRltmKhaiInfo?serviceKey=${serviceKey}&returnType=json&numOfRows=100&pageNo=1`;
  const url = proxy + encodeURIComponent(target);

  try {
    const res = await fetch(url);
    const text = await res.text();
    const data = JSON.parse(text);
    const items = data.response?.body?.items || [];

    const gimchon = items.find(x => x.stationName && x.stationName.includes("Í∏àÏ¥å2Îèô"));
    const airEl = document.getElementById("air");

    if (!gimchon) {
      airEl.textContent = "Í∏àÏ¥å2Îèô Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå";
      airEl.className = "air";
      return;
    }

    const grade = gimchon.khaiGrade;
    let textStatus = "", cls = "";
    switch (grade) {
      case "1": textStatus = "Ï¢ãÏùå"; cls = "good"; break;
      case "2": textStatus = "Î≥¥ÌÜµ"; cls = "normal"; break;
      case "3": textStatus = "ÎÇòÏÅ®"; cls = "bad"; break;
      case "4": textStatus = "Îß§Ïö∞ÎÇòÏÅ®"; cls = "verybad"; break;
      default: textStatus = "Ï†ïÎ≥¥ÏóÜÏùå"; cls = "";
    }

    airEl.textContent = `ÎØ∏ÏÑ∏Î®ºÏßÄ ${textStatus}`;
    airEl.className = `air ${cls}`;
  } catch (e) {
    document.getElementById("air").textContent = "Îç∞Ïù¥ÌÑ∞ Ïò§Î•ò";
  }
}

// ‚òÄÔ∏è ÎÇ†Ïî®
async function getWeather() {
  const icons = {
    0:"https://raw.githubusercontent.com/basmilius/weather-icons/dev/production/fill/svg/clear-day.svg",
    1:"https://raw.githubusercontent.com/basmilius/weather-icons/dev/production/fill/svg/partly-cloudy-day.svg",
    2:"https://raw.githubusercontent.com/basmilius/weather-icons/dev/production/fill/svg/cloudy.svg",
    3:"https://raw.githubusercontent.com/basmilius/weather-icons/dev/production/fill/svg/overcast.svg",
    45:"https://raw.githubusercontent.com/basmilius/weather-icons/dev/production/fill/svg/fog.svg",
    48:"https://raw.githubusercontent.com/basmilius/weather-icons/dev/production/fill/svg/fog.svg",
    51:"https://raw.githubusercontent.com/basmilius/weather-icons/dev/production/fill/svg/drizzle.svg",
    61:"https://raw.githubusercontent.com/basmilius/weather-icons/dev/production/fill/svg/rain.svg",
    71:"https://raw.githubusercontent.com/basmilius/weather-icons/dev/production/fill/svg/snow.svg",
    80:"https://raw.githubusercontent.com/basmilius/weather-icons/dev/production/fill/svg/showers.svg",
    95:"https://raw.githubusercontent.com/basmilius/weather-icons/dev/production/fill/svg/thunderstorms.svg"
  };

  const res = await fetch("https://api.open-meteo.com/v1/forecast?latitude=37.75&longitude=126.78&current_weather=true&hourly=temperature_2m,weathercode&daily=temperature_2m_max,temperature_2m_min,weathercode&timezone=Asia/Seoul");
  const data = await res.json();

  document.getElementById("temp").textContent = `${Math.round(data.current_weather.temperature)}¬∞C`;

  const hourly = data.hourly;
  const nowHour = new Date().getHours();
  const getIcon = (targetHour) => {
    const idx = hourly.time.findIndex(t => t.includes(`T${String(targetHour).padStart(2,"0")}:00`));
    const code = hourly.weathercode[idx];
    return icons[code] || icons[1];
  };
  document.getElementById("nowIcon").src = getIcon(nowHour);
  document.getElementById("morningIcon").src = getIcon(9);
  document.getElementById("noonIcon").src = getIcon(14);
  document.getElementById("eveningIcon").src = getIcon(19);

  const week = document.getElementById("week");
  week.innerHTML = "";
  for (let i = 0; i < 7; i++) {
    const day = new Date(data.daily.time[i]);
    const weekday = day.toLocaleDateString("en-US", { weekday: "short" });
    const icon = icons[data.daily.weathercode[i]] || icons[1];
    const max = Math.round(data.daily.temperature_2m_max[i]);
    const min = Math.round(data.daily.temperature_2m_min[i]);
    week.innerHTML += `
      <div class="day">
        <span>${weekday}</span>
        <img src="${icon}" class="icon">
        <span>${max}/${min}¬∞</span>
      </div>`;
  }
}

// Ïã§Ìñâ
getAirQuality();
getWeather();
</script>
</body>
</html>
