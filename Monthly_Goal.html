<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="color-scheme" content="dark light">
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monthly Goal</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: transparent;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        ::-webkit-scrollbar { display: none; }
        
        .widget-container {
            position: relative;
            width: 180px;
            height: 120px;
            background: linear-gradient(180deg, rgba(224, 242, 254, 0.25) 0%, rgba(240, 249, 255, 0.15) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(186, 230, 253, 0.15), inset 0 0 20px rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #334155;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.8);
            flex-shrink: 0;
        }

        .progress-bar-bg {
            height: 4px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
            overflow: hidden;
            flex: 1;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 2px;
            transition: width 0.5s ease;
        }

        .font-mono { font-family: 'Roboto Mono', monospace; }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        purple: { 300: '#d8b4fe' },
                        sky: { 300: '#7dd3fc' },
                        yellow: { 200: '#fef08a' }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans KR"', '-apple-system', 'sans-serif'],
                        mono: ['"Roboto Mono"', 'monospace']
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const WORKER_URL = "https://log-worker.moonkelly601.workers.dev";

        // 월간 목표
        const TARGETS = {
            exercise: 20,
            reading: 600,
            english: 15,
            japanese: 20,
            record: 15,
            coding: 1200
        };

        // 아이콘
        const IconSparkle = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 2l3 7 7 3-7 3-3 7-3-7-7-3 7-3z"></path>
            </svg>
        );

        const IconBook = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
        );

        const IconPen = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <path d="M12 19l7-7 3 3-7 7-3-3z"></path>
                <path d="M18 13l-1.5-7.5L2 2l3.5 14.5L13 18l5-5z"></path>
            </svg>
        );

        const IconFlame = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round">
                <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a7 7 0 0 0 3 3.3z"></path>
            </svg>
        );

        // 데이터 집계
        const analyzeBlocks = (blocks) => {
            const stats = { exercise: 0, reading: 0, english: 0, japanese: 0, record: 0, coding: 0 };

            blocks.forEach(b => {
                const content = ((b.name || "") + " " + (b.memo || "")).toLowerCase();
                const duration = b.duration || 0;

                if (content.includes("산책") || content.includes("운동") || content.includes("러닝")) stats.exercise += 1;
                if (content.includes("영어") || content.includes("보카")) stats.english += 1;
                if (content.includes("일어") || content.includes("일본어") || content.includes("상용한자")) stats.japanese += 1;
                if (content.includes("기록") || content.includes("일기") || content.includes("상담")) stats.record += 1;
                if (content.includes("독서") || content.includes("책")) stats.reading += duration;
                if (content.includes("위젯") || content.includes("개발") || content.includes("디버깅") || content.includes("개선")) stats.coding += duration;
            });

            return stats;
        };

        const getPercent = (current, target) => Math.min(100, Math.round((current / target) * 100));

        const getMonthStr = () => {
            const now = new Date();
            return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
        };

        // 프로그래스 바
        const ProgressBar = ({ percent, color }) => (
            <div className="progress-bar-bg">
                <div 
                    className="progress-bar-fill"
                    style={{ 
                        width: `${percent}%`, 
                        backgroundColor: color,
                        boxShadow: `0 0 6px ${color}40`
                    }}
                />
            </div>
        );

        // 메인
        const MonthlyGoal = () => {
            const [stats, setStats] = useState({ exercise: 0, reading: 0, english: 0, japanese: 0, record: 0, coding: 0 });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchData = async () => {
                    try {
                        const res = await fetch(`${WORKER_URL}?month=${getMonthStr()}`);
                        if (res.ok) {
                            const result = await res.json();
                            if (result.data) {
                                const allBlocks = [];
                                Object.values(result.data).forEach(d => {
                                    if (d.blocks && Array.isArray(d.blocks)) allBlocks.push(...d.blocks);
                                });
                                setStats(analyzeBlocks(allBlocks));
                            }
                        }
                    } catch (e) {
                        console.error('Fetch error:', e);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchData();
            }, []);

            const percents = {
                exercise: getPercent(stats.exercise, TARGETS.exercise),
                reading: getPercent(stats.reading, TARGETS.reading),
                english: getPercent(stats.english, TARGETS.english),
                japanese: getPercent(stats.japanese, TARGETS.japanese),
                record: getPercent(stats.record, TARGETS.record),
                coding: getPercent(stats.coding, TARGETS.coding)
            };

            const avgPercent = Math.round(Object.values(percents).reduce((a, b) => a + b, 0) / 6);

            const colors = { purple: '#d8b4fe', sky: '#7dd3fc', yellow: '#fef08a' };

            const goals = [
                { label: "운동", percent: percents.exercise, color: colors.purple, Icon: IconSparkle },
                { label: "코딩", percent: percents.coding, color: colors.sky, Icon: IconFlame },
                { label: "영어", percent: percents.english, color: colors.yellow, Icon: IconFlame },
                { label: "일어", percent: percents.japanese, color: colors.yellow, Icon: IconFlame },
                { label: "독서", percent: percents.reading, color: colors.sky, Icon: IconBook },
                { label: "기록", percent: percents.record, color: colors.sky, Icon: IconPen }
            ];

            if (loading) {
                return (
                    <div className="widget-container items-center justify-center">
                        <div className="w-4 h-4 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                    </div>
                );
            }

            return (
                <div className="widget-container">
                    {/* Header */}
                    <div className="glass-header px-3 py-1.5 flex items-center gap-2">
                        <span className="text-[11px] font-bold text-white">Monthly</span>
                        <div className="flex items-center gap-1.5 flex-1">
                            <ProgressBar percent={avgPercent} color="white" />
                            <span className="text-[10px] font-mono text-white/70">{avgPercent}%</span>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="flex-1 p-2 grid grid-cols-2 gap-x-3 gap-y-1.5">
                        {goals.map((item, i) => (
                            <div key={i} className="flex items-center gap-1.5">
                                <item.Icon className="w-3 h-3 shrink-0" color={item.color} />
                                <span className="text-[10px] font-medium shrink-0" style={{ color: item.color }}>{item.label}</span>
                                <ProgressBar percent={item.percent} color={item.color} />
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MonthlyGoal />);
    </script>
</body>
</html>
