<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="color-scheme" content="dark light">
    <meta charset="UTF-8">
    <meta name="robots" content="noindex, nofollow">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bookshelf</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: transparent;
            margin: 0;
            padding: 12px;
        }

        .widget-container {
            width: 460px;
            background: linear-gradient(135deg, rgba(224, 242, 254, 0.25) 0%, rgba(186, 230, 253, 0.15) 100%);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 32px rgba(186, 230, 253, 0.2), inset 0 0 20px rgba(255, 255, 255, 0.1);
            overflow: hidden;
        }

        .header {
            padding: 6px 14px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
        }

        .shelf-row {
            display: flex;
            align-items: flex-end;
            padding: 16px 12px 6px 12px;
            min-height: 120px;
            gap: 3px;
            flex-wrap: nowrap;
            position: relative;
        }

        .shelf-row::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(to bottom, rgba(125, 211, 252, 0.4), rgba(125, 211, 252, 0.2));
            border-radius: 0 0 2px 2px;
        }

        .book {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px 3px 2px 2px;
            cursor: pointer;
            transition: all 0.25s ease;
            position: relative;
            flex-shrink: 0;
            box-shadow: 
                1px 0 3px rgba(0, 0, 0, 0.15),
                inset -1px 0 2px rgba(255, 255, 255, 0.2),
                inset 1px 0 1px rgba(0, 0, 0, 0.05);
        }

        .book:hover {
            transform: translateY(-6px);
            box-shadow: 
                2px 4px 8px rgba(0, 0, 0, 0.2),
                inset -1px 0 2px rgba(255, 255, 255, 0.25);
            z-index: 10;
        }

        .book-spine {
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-size: 9px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.4);
            padding: 6px 1px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            max-height: calc(100% - 12px);
            letter-spacing: 0.5px;
            word-spacing: 4px;
        }

        .tooltip {
            position: absolute;
            bottom: calc(100% + 10px);
            background: rgba(15, 23, 42, 0.95);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 11px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
            z-index: 100;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .tooltip-center {
            left: 50%;
            transform: translateX(-50%);
        }

        .tooltip-left {
            left: 0;
            transform: translateX(0);
        }

        .tooltip-right {
            right: 0;
            left: auto;
            transform: translateX(0);
        }

        .book:hover .tooltip {
            opacity: 1;
        }

        .tooltip::after {
            content: '';
            position: absolute;
            top: 100%;
            border: 6px solid transparent;
            border-top-color: rgba(15, 23, 42, 0.95);
        }

        .tooltip-center::after {
            left: 50%;
            transform: translateX(-50%);
        }

        .tooltip-left::after {
            left: 12px;
        }

        .tooltip-right::after {
            right: 12px;
            left: auto;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            color: rgba(255, 255, 255, 0.6);
            font-size: 12px;
        }

        .empty-shelf {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100px;
            color: rgba(255, 255, 255, 0.5);
            font-size: 11px;
        }
    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const WORKER_URL = "https://bookshelf-worker.moonkelly601.workers.dev";
        const SHELF_MAX_WIDTH = 436;
        const CURRENT_YEAR = new Date().getFullYear();

        // 분류 우선순위
        const CATEGORY_PRIORITY = ['문학', '에세이', '인문', '사회', '과학', '철학', '교육', '뇌과학', '사회생활', '심리학', '자기계발'];

        // 아이콘
        const IconBook = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color || "currentColor"} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
            </svg>
        );

        const App = () => {
            const [books, setBooks] = useState([]);
            const [loading, setLoading] = useState(true);
            const [year, setYear] = useState(CURRENT_YEAR);

            useEffect(() => {
                const fetchBooks = async () => {
                    try {
                        const res = await fetch(`${WORKER_URL}?year=${CURRENT_YEAR}&t=${Date.now()}`);
                        if (res.ok) {
                            const data = await res.json();
                            setBooks(data.books || []);
                            setYear(data.year || CURRENT_YEAR);
                        }
                    } catch (e) {
                        console.error('책 데이터 로드 실패:', e);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchBooks();
            }, []);

            // 페이지 수 → 두께 (px)
            const getBookWidth = (pages) => {
                if (pages >= 300) return 28;
                if (pages >= 200) return 22;
                return 16; // 1~199p
            };

            // 페이지 수 → 높이 (px)
            const getBookHeight = (pages) => {
                if (pages >= 300) return 96;
                if (pages >= 200) return 90;
                return 84;
            };

            // 분류에 따른 색상 결정
            const getBookColor = (categories) => {
                // 우선순위에 따라 첫 번째 매칭되는 분류 찾기
                for (const cat of CATEGORY_PRIORITY) {
                    if (categories.includes(cat)) {
                        // 문학/에세이: 검정에 가까운 회색
                        if (cat === '문학' || cat === '에세이') {
                            return 'rgba(51, 65, 85, 0.9)'; // slate-700
                        }
                        // 인문/사회/과학: 연한 회색
                        if (cat === '인문' || cat === '사회' || cat === '과학') {
                            return 'rgba(148, 163, 184, 0.85)'; // slate-400
                        }
                        // 철학/교육/뇌과학/사회생활: 스카이블루
                        if (cat === '철학' || cat === '교육' || cat === '뇌과학' || cat === '사회생활') {
                            return 'rgba(125, 211, 252, 0.8)'; // sky-300
                        }
                        // 심리학/자기계발: 연보라
                        if (cat === '심리학' || cat === '자기계발') {
                            return 'rgba(216, 180, 254, 0.85)'; // purple-300
                        }
                    }
                }
                // 기본값: 연한 스카이블루
                return 'rgba(186, 230, 253, 0.75)'; // sky-200
            };

            // 책들을 선반별로 분배
            const distributeToShelves = (books) => {
                if (!books.length) return [];
                
                const shelves = [];
                let currentShelf = [];
                let currentWidth = 0;

                books.forEach((book) => {
                    const width = getBookWidth(book.totalPages);
                    const gap = currentShelf.length > 0 ? 3 : 0;
                    
                    if (currentWidth + width + gap > SHELF_MAX_WIDTH && currentShelf.length > 0) {
                        shelves.push(currentShelf);
                        currentShelf = [];
                        currentWidth = 0;
                    }
                    
                    currentShelf.push(book);
                    currentWidth += width + (currentShelf.length > 1 ? 3 : 0);
                });

                if (currentShelf.length > 0) {
                    shelves.push(currentShelf);
                }

                return shelves;
            };

            // 툴팁 위치 결정 (앞쪽 3개는 왼쪽, 뒤쪽 3개는 오른쪽)
            const getTooltipClass = (bookIdx, shelfLength) => {
                if (bookIdx <= 2) return 'tooltip tooltip-left';
                if (bookIdx >= shelfLength - 3) return 'tooltip tooltip-right';
                return 'tooltip tooltip-center';
            };

            // 제목 자르기 (단어 단위)
            const truncateTitle = (title, pages) => {
                const height = getBookHeight(pages);
                const maxChars = Math.floor((height - 20) / 10);
                
                if (title.length <= maxChars) return title;
                
                const words = title.split(' ');
                let result = '';
                for (const word of words) {
                    if ((result + ' ' + word).trim().length > maxChars - 1) break;
                    result = (result + ' ' + word).trim();
                }
                
                if (!result && words[0]) {
                    result = words[0].slice(0, maxChars - 1);
                }
                
                return result + '⋯';
            };

            const shelves = distributeToShelves(books);

            return (
                <div className="widget-container">
                    {/* 헤더 */}
                    <div className="header">
                        <div className="flex items-center gap-2">
                            <IconBook className="w-4 h-4" color="#7dd3fc" />
                            <span className="text-[13px] font-bold text-white">Bookshelf</span>
                            <span className="text-[12px] font-medium text-white/60">{year}</span>
                        </div>
                        {books.length > 0 && (
                            <span className="text-[11px] font-medium text-sky-300 bg-sky-400/20 px-2 py-0.5 rounded-full">
                                {books.length}권
                            </span>
                        )}
                    </div>

                    {/* 책장 */}
                    {loading ? (
                        <div className="loading">불러오는 중...</div>
                    ) : books.length === 0 ? (
                        <div className="empty-shelf">올해 완독한 책이 없어요</div>
                    ) : (
                        shelves.map((shelf, shelfIdx) => (
                            <div key={shelfIdx} className="shelf-row">
                                {shelf.map((book, bookIdx) => (
                                    <div
                                        key={book.id || bookIdx}
                                        className="book"
                                        style={{
                                            width: `${getBookWidth(book.totalPages)}px`,
                                            height: `${getBookHeight(book.totalPages)}px`,
                                            backgroundColor: getBookColor(book.categories || []),
                                        }}
                                    >
                                        <span className="book-spine">{truncateTitle(book.title, book.totalPages)}</span>
                                        <div className={getTooltipClass(bookIdx, shelf.length)}>
                                            <div className="font-semibold mb-1">{book.title}</div>
                                            {book.author && (
                                                <div className="text-white/70 text-[10px]">{book.author}</div>
                                            )}
                                            {book.publisher && (
                                                <div className="text-white/50 text-[10px]">{book.publisher}</div>
                                            )}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ))
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
