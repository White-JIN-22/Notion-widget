<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="color-scheme" content="dark light">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goal Dashboard</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Roboto+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: transparent;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        ::-webkit-scrollbar { display: none; }
        
        .widget-container {
            position: relative;
            width: 440px;
            height: 310px;
            background: linear-gradient(180deg, rgba(224, 242, 254, 0.25) 0%, rgba(240, 249, 255, 0.15) 100%);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px rgba(186, 230, 253, 0.15), inset 0 0 20px rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #334155;
        }

        .glass-header {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.8);
            flex-shrink: 0;
        }

        .glass-section {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
        }

        .progress-bar-bg {
            height: 6px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .font-mono { font-family: 'Roboto Mono', monospace; }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        purple: { 300: '#d8b4fe', 100: '#f3e8ff' },
                        sky: { 300: '#7dd3fc', 100: '#e0f2fe', 400: '#38bdf8' },
                        yellow: { 200: '#fef08a', 400: '#facc15' },
                        slate: { 400: '#94a3b8', 600: '#475569' }
                    },
                    fontFamily: {
                        sans: ['"Noto Sans KR"', '-apple-system', 'sans-serif'],
                        mono: ['"Roboto Mono"', 'monospace']
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const WORKER_URL = "https://log-worker.moonkelly601.workers.dev";

        // ========================================
        // 목표 설정
        // ========================================
        const TARGETS = {
            exercise: 20,
            reading: 600,
            english: 15,
            japanese: 20,
            record: 15,
            coding: 1200
        };

        const GOALS = {
            keywords: ["신체와 환경의 주도권 회복"],
            monthly_text: "체중 -4kg, 독서 2권, 어학(영~D15/일~103p), 일기 15회, 대시보드 완성",
            weekly_text: "주간 체중 관리, 독서, 어학 분량 소화, 시스템 구축 집중"
        };

        // ========================================
        // 데이터 집계 로직
        // ========================================
        const analyzeBlocks = (blocks) => {
            const stats = {
                exercise: 0, reading: 0, english: 0, 
                japanese: 0, record: 0, coding: 0
            };

            blocks.forEach(b => {
                const name = (b.name || "").trim();
                const memo = (b.memo || "").trim();
                const content = (name + " " + memo).toLowerCase();
                const duration = b.duration || 0;

                if (content.includes("산책") || content.includes("운동") || content.includes("러닝")) {
                    stats.exercise += 1;
                }
                if (content.includes("영어") || content.includes("보카")) {
                    stats.english += 1;
                }
                if (content.includes("일어") || content.includes("일본어") || content.includes("상용한자")) {
                    stats.japanese += 1;
                }
                if (content.includes("기록") || content.includes("일기") || content.includes("상담")) {
                    stats.record += 1;
                }
                if (content.includes("독서") || content.includes("책")) {
                    stats.reading += duration;
                }
                if (content.includes("위젯") || content.includes("개발") || 
                    content.includes("디버깅") || content.includes("개선")) {
                    stats.coding += duration;
                }
            });

            return stats;
        };

        const getPercent = (current, target) => Math.min(100, Math.round((current / target) * 100));

        // ========================================
        // 규칙 기반 피드백 생성
        // ========================================
        const generateFeedback = (stats, percents) => {
            const avgPercent = Math.round(
                (percents.exercise + percents.reading + percents.english + 
                 percents.japanese + percents.record + percents.coding) / 6
            );

            const items = [
                { name: '운동', p: percents.exercise },
                { name: '독서', p: percents.reading },
                { name: '영어', p: percents.english },
                { name: '일어', p: percents.japanese },
                { name: '기록', p: percents.record },
                { name: '코딩', p: percents.coding }
            ];
            const best = items.reduce((a, b) => a.p > b.p ? a : b);
            const worst = items.reduce((a, b) => a.p < b.p ? a : b);

            if (avgPercent === 0) {
                const starters = [
                    "아직 시작 전이야. 의지 문제가 아니라 시스템 문제야. 오늘은 딱 5분만 책상에 앉아보자.",
                    "0%는 게으름이 아니야. 환경 세팅부터 해보자. 공기청정기 켜고, 물 한 잔 마시고.",
                ];
                return starters[Math.floor(Math.random() * starters.length)];
            }

            if (worst.p === 0 && avgPercent > 0) {
                return `${worst.name}이 아직 0%네. 괜찮아, 작은 환경 변화부터 시작해보자. 오늘 딱 10분만 투자해봐.`;
            }
            
            if (avgPercent < 40) {
                return `${best.name}(${best.p}%)이 잘 진행되고 있어. 이 리듬 유지하면서 ${worst.name}도 조금씩 신경 써보자.`;
            }
            
            if (avgPercent < 60) {
                return `절반 가까이 왔어. ${best.name}에서 주도권을 잡고 있네. 꾸준함이 결국 이겨.`;
            }
            
            if (avgPercent < 80) {
                return `평균 ${avgPercent}% 달성 중. 신체와 환경의 통제권을 확실히 되찾고 있어. 이대로 가자.`;
            }
            
            return `목표 달성이 눈앞이야! ${best.name} ${best.p}% 대단해. 4평 공간 안에서도 네가 주도권을 쥐고 있다는 증거야.`;
        };

        // ========================================
        // 날짜 유틸
        // ========================================
        const getMonthStr = () => {
            const now = new Date();
            const y = now.getFullYear();
            const m = String(now.getMonth() + 1).padStart(2, '0');
            return `${y}-${m}`;
        };

        // ========================================
        // 아이콘
        // ========================================
        const IconTarget = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <circle cx="12" cy="12" r="6"></circle>
                <circle cx="12" cy="12" r="2"></circle>
            </svg>
        );

        const IconMessage = ({ className, color }) => (
            <svg className={className} viewBox="0 0 24 24" fill="none" stroke={color} strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
        );

        // ========================================
        // 프로그래스 바 컴포넌트
        // ========================================
        const ProgressBar = ({ percent, color }) => (
            <div className="progress-bar-bg">
                <div 
                    className="progress-bar-fill"
                    style={{ 
                        width: `${percent}%`, 
                        backgroundColor: color,
                        boxShadow: `0 0 8px ${color}40`
                    }}
                />
            </div>
        );

        // ========================================
        // 메인 컴포넌트
        // ========================================
        const GoalWidget = () => {
            const [stats, setStats] = useState({
                exercise: 0, reading: 0, english: 0, 
                japanese: 0, record: 0, coding: 0
            });
            const [loading, setLoading] = useState(true);

            useEffect(() => {
                const fetchMonthData = async () => {
                    try {
                        const monthStr = getMonthStr();
                        const res = await fetch(`${WORKER_URL}?month=${monthStr}`);
                        
                        if (res.ok) {
                            const result = await res.json();
                            if (result.data) {
                                const allBlocks = [];
                                Object.values(result.data).forEach(dayData => {
                                    if (dayData.blocks && Array.isArray(dayData.blocks)) {
                                        allBlocks.push(...dayData.blocks);
                                    }
                                });
                                const analyzed = analyzeBlocks(allBlocks);
                                setStats(analyzed);
                            }
                        } else {
                            console.error('Fetch failed:', res.status);
                        }
                    } catch (e) {
                        console.error('Fetch error:', e);
                    } finally {
                        setLoading(false);
                    }
                };

                fetchMonthData();
            }, []);

            const percents = {
                exercise: getPercent(stats.exercise, TARGETS.exercise),
                reading: getPercent(stats.reading, TARGETS.reading),
                english: getPercent(stats.english, TARGETS.english),
                japanese: getPercent(stats.japanese, TARGETS.japanese),
                record: getPercent(stats.record, TARGETS.record),
                coding: getPercent(stats.coding, TARGETS.coding)
            };

            const feedback = generateFeedback(stats, percents);

            const avgPercent = Math.round(
                (percents.exercise + percents.reading + percents.english + 
                 percents.japanese + percents.record + percents.coding) / 6
            );

            const goals = [
                { label: "운동", percent: percents.exercise, color: "#d8b4fe", value: stats.exercise, target: TARGETS.exercise, unit: "회" },
                { label: "독서", percent: percents.reading, color: "#7dd3fc", value: stats.reading, target: TARGETS.reading, unit: "분" },
                { label: "영어", percent: percents.english, color: "#d8b4fe", value: stats.english, target: TARGETS.english, unit: "회" },
                { label: "일어", percent: percents.japanese, color: "#7dd3fc", value: stats.japanese, target: TARGETS.japanese, unit: "회" },
                { label: "기록", percent: percents.record, color: "#d8b4fe", value: stats.record, target: TARGETS.record, unit: "회" },
                { label: "코딩", percent: percents.coding, color: "#7dd3fc", value: stats.coding, target: TARGETS.coding, unit: "분" }
            ];

            if (loading) {
                return (
                    <div className="widget-container items-center justify-center">
                        <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div>
                        <div className="text-xs text-white/60 mt-2">데이터 수집 중...</div>
                    </div>
                );
            }

            return (
                <div className="widget-container">
                    
                    {/* Header */}
                    <div className="glass-header px-5 py-3 flex justify-between items-center">
                        <div className="flex items-center gap-2">
                            <IconTarget className="w-4 h-4" color="#7dd3fc" />
                            <h1 className="text-sm font-bold text-white tracking-tight">Monthly Goals</h1>
                        </div>
                        <div className="flex items-center gap-2">
                            <span className="text-xs font-mono text-white/70">{avgPercent}%</span>
                            <div className="w-16 h-1.5 bg-white/20 rounded-full overflow-hidden">
                                <div 
                                    className="h-full bg-sky-300 rounded-full transition-all"
                                    style={{ width: `${avgPercent}%`, boxShadow: '0 0 8px rgba(125,211,252,0.5)' }}
                                />
                            </div>
                        </div>
                    </div>

                    {/* Content */}
                    <div className="flex-1 p-4 flex flex-col gap-3">
                        
                        {/* Keyword Banner */}
                        <div className="glass-section px-4 py-2 flex items-center justify-center" style={{ backgroundColor: 'rgba(216, 180, 254, 0.15)' }}>
                            <span className="text-xs font-bold text-purple-300 tracking-wide">
                                ✦ {GOALS.keywords[0]} ✦
                            </span>
                        </div>

                        {/* Goals Grid */}
                        <div className="glass-section p-3 flex-1">
                            <div className="grid grid-cols-2 gap-x-6 gap-y-2.5 h-full">
                                {goals.map((item, i) => (
                                    <div key={i} className="flex flex-col gap-1">
                                        <div className="flex justify-between items-baseline">
                                            <span className="text-[11px] font-medium text-white/80">{item.label}</span>
                                            <span className="text-[10px] font-mono text-white/50">
                                                {item.value}/{item.target}{item.unit}
                                            </span>
                                        </div>
                                        <ProgressBar percent={item.percent} color={item.color} />
                                    </div>
                                ))}
                            </div>
                        </div>

                        {/* Feedback */}
                        <div className="glass-section px-3 py-2.5 flex items-start gap-2.5" style={{ backgroundColor: 'rgba(125, 211, 252, 0.1)' }}>
                            <IconMessage className="w-4 h-4 shrink-0 mt-0.5" color="#7dd3fc" />
                            <p className="text-[11px] text-white/80 leading-relaxed">
                                {feedback}
                            </p>
                        </div>

                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GoalWidget />);
    </script>
</body>
</html>
