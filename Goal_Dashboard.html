<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="color-scheme" content="dark light">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Goal Dashboard</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background-color: transparent;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        
        .widget-container {
            width: 440px;
            height: 310px;
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(25px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 10px 40px rgba(216, 180, 254, 0.1);
            display: flex;
            flex-direction: column; 
            padding: 16px 20px;
            gap: 10px;
            overflow: hidden;
            color: #334155;
        }
        
        .section-title {
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.6);
            border-radius: 14px;
            padding: 10px 6px;
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
        }
        
        .grid-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 18px;
        }
        
        .item-label {
            font-size: 10px;
            font-weight: 500;
            color: #64748b;
            white-space: nowrap;
            margin-right: 8px;
        }

        .block-container {
            display: flex;
            gap: 2px;
        }

        .block {
            width: 8px;
            height: 8px;
            border-radius: 2px;
            background-color: rgba(203, 213, 225, 0.4);
            transition: all 0.5s ease;
        }
    </style>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        purple: { 300: '#d8b4fe', 100: '#f3e8ff' },
                        sky: { 300: '#7dd3fc', 100: '#e0f2fe', 400: '#38bdf8', 500: '#0ea5e9' },
                        yellow: { 200: '#fef08a', 400: '#facc15' },
                        slate: { 400: '#94a3b8', 600: '#475569' }
                    }
                }
            }
        }
    </script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // ‚òÖ log-worker Ï£ºÏÜå
        const WORKER_URL = "https://log-worker.moonkelly601.workers.dev";

        // ========================================
        // [ÏõåÏª§ÏóêÏÑú Ïù¥Ïãù] Î™©Ìëú ÏÑ§Ï†ï
        // ========================================
        const TARGETS = {
            exercise: 20,    // Ïö¥Îèô (Ìöå)
            reading: 600,    // ÎèÖÏÑú (Î∂Ñ)
            english: 15,     // ÏòÅÏñ¥ (Ìöå)
            japanese: 20,    // ÏùºÏñ¥ (Ìöå)
            record: 15,      // ÏùºÍ∏∞/Í∏∞Î°ù (Ìöå)
            coding: 1200     // Í∞úÎ∞ú/ÏΩîÎî© (Î∂Ñ)
        };

        const GOALS = {
            keywords: ["Ïã†Ï≤¥ÏôÄ ÌôòÍ≤ΩÏùò Ï£ºÎèÑÍ∂å ÌöåÎ≥µ"],
            monthly_text: "Ï≤¥Ï§ë -4kg, ÎèÖÏÑú 2Í∂å, Ïñ¥Ìïô(ÏòÅ~D15/Ïùº~103p), ÏùºÍ∏∞ 15Ìöå, ÎåÄÏãúÎ≥¥Îìú ÏôÑÏÑ±",
            weekly_text: "Ï£ºÍ∞Ñ Ï≤¥Ï§ë Í¥ÄÎ¶¨, ÎèÖÏÑú, Ïñ¥Ìïô Î∂ÑÎüâ ÏÜåÌôî, ÏãúÏä§ÌÖú Íµ¨Ï∂ï ÏßëÏ§ë"
        };

        // ========================================
        // [ÏõåÏª§ÏóêÏÑú Ïù¥Ïãù] Îç∞Ïù¥ÌÑ∞ ÏßëÍ≥Ñ Î°úÏßÅ
        // ========================================
        const analyzeBlocks = (blocks) => {
            const stats = {
                exercise: 0, reading: 0, english: 0, 
                japanese: 0, record: 0, coding: 0
            };

            blocks.forEach(b => {
                const name = (b.name || "").trim();
                const memo = (b.memo || "").trim();
                const content = (name + " " + memo).toLowerCase();
                const duration = b.duration || 0;

                // ÌöüÏàò Í∏∞Î∞ò (1ÌöåÏî© Ïπ¥Ïö¥Ìä∏)
                if (content.includes("ÏÇ∞Ï±Ö") || content.includes("Ïö¥Îèô") || content.includes("Îü¨Îãù")) {
                    stats.exercise += 1;
                }
                if (content.includes("ÏòÅÏñ¥") || content.includes("Î≥¥Ïπ¥")) {
                    stats.english += 1;
                }
                if (content.includes("ÏùºÏñ¥") || content.includes("ÏùºÎ≥∏Ïñ¥") || content.includes("ÏÉÅÏö©ÌïúÏûê")) {
                    stats.japanese += 1;
                }
                if (content.includes("Í∏∞Î°ù") || content.includes("ÏùºÍ∏∞") || content.includes("ÏÉÅÎã¥")) {
                    stats.record += 1;
                }

                // ÏãúÍ∞Ñ Í∏∞Î∞ò (Î∂Ñ ÎàÑÏ†Å)
                if (content.includes("ÎèÖÏÑú") || content.includes("Ï±Ö")) {
                    stats.reading += duration;
                }
                if (content.includes("ÏúÑÏ†Ø") || content.includes("Í∞úÎ∞ú") || 
                    content.includes("ÎîîÎ≤ÑÍπÖ") || content.includes("Í∞úÏÑ†")) {
                    stats.coding += duration;
                }
            });

            return stats;
        };

        // Îã¨ÏÑ±Î•† Í≥ÑÏÇ∞
        const getPercent = (current, target) => Math.min(100, Math.round((current / target) * 100));

        // ========================================
        // [Gemini ÎåÄÏ≤¥] Í∑úÏπô Í∏∞Î∞ò ÌîºÎìúÎ∞± ÏÉùÏÑ±
        // ========================================
        const generateFeedback = (stats, percents) => {
            const avgPercent = Math.round(
                (percents.exercise + percents.reading + percents.english + 
                 percents.japanese + percents.record + percents.coding) / 6
            );

            // Í∞ÄÏû• ÏûòÌïòÍ≥† ÏûàÎäî Ìï≠Î™© Ï∞æÍ∏∞
            const items = [
                { name: 'Ïö¥Îèô', p: percents.exercise },
                { name: 'ÎèÖÏÑú', p: percents.reading },
                { name: 'ÏòÅÏñ¥', p: percents.english },
                { name: 'ÏùºÏñ¥', p: percents.japanese },
                { name: 'Í∏∞Î°ù', p: percents.record },
                { name: 'ÏΩîÎî©', p: percents.coding }
            ];
            const best = items.reduce((a, b) => a.p > b.p ? a : b);
            const worst = items.reduce((a, b) => a.p < b.p ? a : b);

            // ÏÉÅÌÉúÎ≥Ñ ÌîºÎìúÎ∞±
            if (avgPercent === 0) {
                const starters = [
                    "ÏïÑÏßÅ ÏãúÏûë Ï†ÑÏù¥Ïïº. ÏùòÏßÄ Î¨∏Ï†úÍ∞Ä ÏïÑÎãàÎùº ÏãúÏä§ÌÖú Î¨∏Ï†úÏïº. Ïò§ÎäòÏùÄ Îî± 5Î∂ÑÎßå Ï±ÖÏÉÅÏóê ÏïâÏïÑÎ≥¥Ïûê. üå±",
                    "0%Îäî Í≤åÏúºÎ¶ÑÏù¥ ÏïÑÎãàÏïº. ÌôòÍ≤Ω ÏÑ∏ÌåÖÎ∂ÄÌÑ∞ Ìï¥Î≥¥Ïûê. Í≥µÍ∏∞Ï≤≠Ï†ïÍ∏∞ ÏºúÍ≥†, Î¨º Ìïú Ïûî ÎßàÏãúÍ≥†. ‚òÅÔ∏è",
                    "ÏãúÏûëÏù¥ Ïñ¥Î†§Ïö¥ Í±∞ÏßÄ, Î™ªÌïòÎäî Í≤å ÏïÑÎãàÏïº. ÏïÑÏ£º ÏûëÏùÄ Í≤ÉÎ∂ÄÌÑ∞. Ï±Ö Ìïú Í∂å Ìé¥ÎëêÎäî Í≤ÉÎßåÏúºÎ°úÎèÑ OK. üçÉ"
                ];
                return starters[new Date().getDate() % 3];
            }
            
            if (avgPercent < 20) {
                return `${worst.name}Ïù¥ ÏïÑÏßÅ 0%ÎÑ§. Í¥úÏ∞ÆÏïÑ, ÏûëÏùÄ ÌôòÍ≤Ω Î≥ÄÌôîÎ∂ÄÌÑ∞ ÏãúÏûëÌï¥Î≥¥Ïûê. Ïò§Îäò Îî± 10Î∂ÑÎßå Ìà¨ÏûêÌï¥Î¥ê. üåø`;
            }
            
            if (avgPercent < 40) {
                return `${best.name}(${best.p}%)Ïù¥ Ïûò ÏßÑÌñâÎêòÍ≥† ÏûàÏñ¥. Ïù¥ Î¶¨Îì¨ Ïú†ÏßÄÌïòÎ©¥ÏÑú ${worst.name}ÎèÑ Ï°∞Í∏àÏî© Ïã†Í≤Ω Ïç®Î≥¥Ïûê. üí™`;
            }
            
            if (avgPercent < 60) {
                return `Ï†àÎ∞ò Í∞ÄÍπåÏù¥ ÏôîÏñ¥. ${best.name}ÏóêÏÑú Ï£ºÎèÑÍ∂åÏùÑ Ïû°Í≥† ÏûàÎÑ§. Íæ∏Ï§ÄÌï®Ïù¥ Í≤∞Íµ≠ Ïù¥Í≤®. üî•`;
            }
            
            if (avgPercent < 80) {
                return `ÌèâÍ∑† ${avgPercent}% Îã¨ÏÑ± Ï§ë. Ïã†Ï≤¥ÏôÄ ÌôòÍ≤ΩÏùò ÌÜµÏ†úÍ∂åÏùÑ ÌôïÏã§Ìûà ÎêòÏ∞æÍ≥† ÏûàÏñ¥. Ïù¥ÎåÄÎ°ú Í∞ÄÏûê. ‚ú®`;
            }
            
            return `Î™©Ìëú Îã¨ÏÑ±Ïù¥ ÎààÏïûÏù¥Ïïº! ${best.name} ${best.p}% ÎåÄÎã®Ìï¥. 4Ìèâ Í≥µÍ∞Ñ ÏïàÏóêÏÑúÎèÑ ÎÑ§Í∞Ä Ï£ºÎèÑÍ∂åÏùÑ Ï•êÍ≥† ÏûàÎã§Îäî Ï¶ùÍ±∞Ïïº. üéñÔ∏è`;
        };

        // ========================================
        // ÎÇ†Ïßú Ïú†Ìã∏
        // ========================================
        const formatDateYMD = (date) => {
            const y = date.getFullYear();
            const m = String(date.getMonth() + 1).padStart(2, '0');
            const d = String(date.getDate()).padStart(2, '0');
            return `${y}-${m}-${d}`;
        };

        const getMonthDates = () => {
            const now = new Date();
            const dates = [];
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
            
            for (let d = new Date(startOfMonth); d <= now; d.setDate(d.getDate() + 1)) {
                dates.push(formatDateYMD(new Date(d)));
            }
            return dates;
        };

        // ========================================
        // Ïª¥Ìè¨ÎÑåÌä∏
        // ========================================
        const BlockBar = ({ percent, activeColor }) => {
            const filledCount = Math.round(percent / 20);
            
            return (
                <div className="block-container">
                    {[...Array(5)].map((_, i) => (
                        <div 
                            key={i} 
                            className={`block ${i < filledCount ? activeColor : ''}`}
                        ></div>
                    ))}
                </div>
            );
        };

        const GoalWidget = () => {
            const [stats, setStats] = useState({
                exercise: 0, reading: 0, english: 0, 
                japanese: 0, record: 0, coding: 0
            });
            const [loading, setLoading] = useState(true);
            const [progress, setProgress] = useState(0); // Î°úÎî© ÏßÑÌñâÎ•†

            useEffect(() => {
                const fetchAllData = async () => {
                    const dates = getMonthDates();
                    const allBlocks = [];
                    
                    // Î∞∞Ïπò Ï≤òÎ¶¨ (5Í∞úÏî©)
                    const batchSize = 5;
                    for (let i = 0; i < dates.length; i += batchSize) {
                        const batch = dates.slice(i, i + batchSize);
                        
                        await Promise.all(batch.map(async (dateKey) => {
                            try {
                                const res = await fetch(`${WORKER_URL}?date=${dateKey}`);
                                if (res.ok) {
                                    const data = await res.json();
                                    if (data.blocks && Array.isArray(data.blocks)) {
                                        allBlocks.push(...data.blocks);
                                    }
                                }
                            } catch (err) {
                                console.warn(`Failed: ${dateKey}`, err);
                            }
                        }));
                        
                        // ÏßÑÌñâÎ•† ÏóÖÎç∞Ïù¥Ìä∏
                        setProgress(Math.round(((i + batchSize) / dates.length) * 100));
                    }

                    // ÏßëÍ≥Ñ
                    const analyzed = analyzeBlocks(allBlocks);
                    setStats(analyzed);
                    setLoading(false);
                };

                fetchAllData();
            }, []);

            // Îã¨ÏÑ±Î•† Í≥ÑÏÇ∞
            const percents = {
                exercise: getPercent(stats.exercise, TARGETS.exercise),
                reading: getPercent(stats.reading, TARGETS.reading),
                english: getPercent(stats.english, TARGETS.english),
                japanese: getPercent(stats.japanese, TARGETS.japanese),
                record: getPercent(stats.record, TARGETS.record),
                coding: getPercent(stats.coding, TARGETS.coding)
            };

            // ÌîºÎìúÎ∞± ÏÉùÏÑ±
            const feedback = generateFeedback(stats, percents);

            // ÏõîÍ∞Ñ/Ï£ºÍ∞Ñ Îç∞Ïù¥ÌÑ∞ Íµ¨ÏÑ±
            const monthly = [
                { label: "ÎèÖÏÑú", percent: percents.reading },
                { label: "ÏòÅÏñ¥", percent: percents.english },
                { label: "ÏùºÏñ¥", percent: percents.japanese },
                { label: "ÏΩîÎî©", percent: percents.coding },
                { label: "Ïö¥Îèô", percent: percents.exercise },
                { label: "Í∏∞Î°ù", percent: percents.record }
            ];

            const weekly = [
                { label: "ÎèÖÏÑú", percent: percents.reading },
                { label: "ÏòÅÏñ¥", percent: percents.english },
                { label: "ÏùºÏñ¥", percent: percents.japanese },
                { label: "ÏΩîÎî©", percent: percents.coding },
                { label: "Ïö¥Îèô", percent: percents.exercise },
                { label: "Í∏∞Î°ù", percent: percents.record }
            ];

            if (loading) {
                return (
                    <div className="widget-container items-center justify-center">
                        <div className="text-xs text-slate-400">Îç∞Ïù¥ÌÑ∞ ÏàòÏßë Ï§ë... {progress}%</div>
                    </div>
                );
            }

            return (
                <div className="widget-container">
                    
                    {/* 1. Keyword Block */}
                    <div className="flex gap-2 shrink-0">
                        {GOALS.keywords.map((k, i) => (
                            <div key={i} className="flex-1 bg-purple-100/60 border border-purple-300/40 rounded-lg py-1.5 px-2 text-center shadow-sm">
                                <span className="text-[11px] font-bold text-slate-600 block">{k}</span>
                            </div>
                        ))}
                    </div>

                    {/* 2. Monthly Goal (Blue Theme) */}
                    <div className="glass-card bg-sky-50/30 border-sky-200/40">
                        <div className="section-title text-sky-500">
                            Monthly Objective
                        </div>
                        <div className="grid grid-cols-3 gap-x-2 gap-y-1">
                            {monthly.map((item, i) => (
                                <div key={i} className="grid-item">
                                    <span className="item-label">{item.label}</span>
                                    <BlockBar percent={item.percent} activeColor="bg-sky-400 shadow-[0_0_4px_rgba(56,189,248,0.4)]" />
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 3. Weekly Focus (Yellow Theme) */}
                    <div className="glass-card bg-yellow-50/30 border-yellow-200/50">
                        <div className="section-title text-yellow-500" style={{ color:'#d97706' }}>
                            Weekly Focus
                        </div>
                        <div className="grid grid-cols-3 gap-x-2 gap-y-1">
                            {weekly.map((item, i) => (
                                <div key={i} className="grid-item">
                                    <span className="item-label">{item.label}</span>
                                    <BlockBar percent={item.percent} activeColor="bg-yellow-400 shadow-[0_0_4px_rgba(250,204,21,0.4)]" />
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* 4. Feedback (Í∑úÏπô Í∏∞Î∞ò) */}
                    <div className="bg-white/40 rounded-xl p-2.5 border border-white/60 flex gap-2.5 items-center shadow-sm shrink-0">
                        <div className="text-purple-400 shrink-0">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
                        </div>
                        <p className="text-[11px] text-slate-600 leading-snug font-medium line-clamp-2">
                            {feedback}
                        </p>
                    </div>

                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<GoalWidget />);
    </script>
</body>
</html>
