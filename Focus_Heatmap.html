<!DOCTYPE html>
<html lang="ko">
<head>
    <meta name="color-scheme" content="dark light">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Focus Heatmap</title>
    
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&family=Playfair+Display:wght@400;600;700&family=Roboto+Mono:wght@400;500;700&display=swap');

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: transparent;
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        .widget-container {
            position: relative;
            width: 250px; 
            height: 280px; /* 높이를 컴팩트하게 조정 (캘린더만 딱 보이게) */
            background: linear-gradient(180deg, rgba(224, 242, 254, 0.2) 0%, rgba(240, 249, 255, 0.1) 100%);
            backdrop-filter: blur(20px);
            border-radius: 28px;
            border: 1px solid rgba(224, 242, 254, 0.3);
            box-shadow: 0 0 40px rgba(186, 230, 253, 0.1), inset 0 0 20px rgba(224, 242, 254, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            color: #e0f2fe;
        }

        .font-serif { font-family: 'Playfair Display', serif; font-weight: 700; }
        .font-mono { font-family: 'Roboto Mono', monospace; }
        
        /* 캘린더 그리드 스타일 */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px; /* 간격을 살짝 넓혀 히트맵 박스 느낌 강조 */
            text-align: center;
            padding: 0 14px;
        }
        
        .day-cell {
            height: 28px; /* 정사각형에 가깝게 */
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            font-size: 0.75rem;
            font-family: 'Roboto Mono', monospace;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        /* 히트맵 컬러 클래스 */
        .heat-0 { background: rgba(255, 255, 255, 0.03); color: #64748b; } /* 60분 미만 */
        
        .heat-1 { /* 60 ~ 180분 (연한 스카이) */
            background: rgba(125, 211, 252, 0.3); 
            color: #e0f2fe; 
            border: 1px solid rgba(125, 211, 252, 0.1);
        }
        
        .heat-2 { /* 180 ~ 300분 (진한 스카이) */
            background: rgba(14, 165, 233, 0.6); 
            color: #ffffff; 
            box-shadow: 0 0 8px rgba(14, 165, 233, 0.3);
            border: 1px solid rgba(125, 211, 252, 0.3);
        }
        
        .heat-3 { /* 300분 초과 (연보라) */
            background: rgba(192, 132, 252, 0.7); 
            color: #ffffff; 
            box-shadow: 0 0 12px rgba(192, 132, 252, 0.4);
            font-weight: 700;
            border: 1px solid rgba(216, 180, 254, 0.4);
        }

        /* 오늘 날짜 하이라이트 (테두리 강조) */
        .day-today {
            border: 1.5px solid #ffffff !important;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
            z-index: 10;
        }

        .nav-btn { width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; border-radius: 6px; color: rgba(255, 255, 255, 0.6); transition: all 0.2s; }
        .nav-btn:hover { color: white; background: rgba(255,255,255,0.1); }
        
        .tooltip {
            position: absolute;
            bottom: -25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(15, 23, 42, 0.9);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            white-space: nowrap;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 20;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .day-cell:hover .tooltip { opacity: 1; }

    </style>
</head>
<body>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const Icons = {
            ChevronLeft: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M15 18l-6-6 6-6"/></svg>,
            ChevronRight: () => <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="M9 18l6-6-6-6"/></svg>,
            RotateCcw: () => <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round"><polyline points="1 4 1 10 7 10"></polyline><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"></path></svg>,
            Flame: () => <svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" stroke="none"><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.6-3.3a7 7 0 0 0 3 3.3z"></path></svg>,
        };

        const App = () => {
            const [currentDate, setCurrentDate] = useState(new Date()); 
            const [focusData, setFocusData] = useState({}); // {'YYYY-MM-DD': minutes}
            const [monthTotal, setMonthTotal] = useState(0);

            // 로컬 스토리지에서 기록(History + Today) 불러오기
            const loadData = () => {
                try {
                    const history = JSON.parse(localStorage.getItem('fortressHistory') || '[]');
                    const todayData = JSON.parse(localStorage.getItem('fortressData') || '{}');
                    
                    const map = {};

                    // 1. 과거 기록 처리
                    history.forEach(day => {
                        if (!day.date) return;
                        const dateObj = new Date(day.date);
                        const key = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
                        
                        // Focus 블록의 duration 합산
                        const minutes = (day.blocks || [])
                            .filter(b => b.type === 'focus' || !b.type)
                            .reduce((acc, cur) => acc + (cur.duration || 0), 0);
                        
                        map[key] = minutes;
                    });

                    // 2. 오늘 기록 처리 (실시간 반영)
                    if (todayData.date) {
                        const dateObj = new Date(todayData.date);
                        const key = `${dateObj.getFullYear()}-${String(dateObj.getMonth() + 1).padStart(2, '0')}-${String(dateObj.getDate()).padStart(2, '0')}`;
                        
                        const todayMinutes = (todayData.blocks || [])
                            .filter(b => b.type === 'focus' || !b.type)
                            .reduce((acc, cur) => acc + (cur.duration || 0), 0);
                        
                        map[key] = todayMinutes; // 오늘 데이터가 있으면 덮어쓰기
                    }

                    setFocusData(map);

                } catch (e) { console.error("Data Load Error", e); }
            };

            useEffect(() => {
                loadData();
                // 다른 탭/창에서 데이터 변경 시 자동 갱신
                window.addEventListener('storage', loadData);
                // 1분마다 갱신 (현재 진행중인 시간 반영을 위해)
                const interval = setInterval(loadData, 60000);
                return () => {
                    window.removeEventListener('storage', loadData);
                    clearInterval(interval);
                };
            }, []);

            // 월별 총합 계산
            useEffect(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth() + 1;
                const prefix = `${year}-${String(month).padStart(2,'0')}`;
                
                let sum = 0;
                Object.keys(focusData).forEach(key => {
                    if (key.startsWith(prefix)) sum += focusData[key];
                });
                setMonthTotal(sum);
            }, [currentDate, focusData]);

            // 날짜 이동
            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            const goToday = () => setCurrentDate(new Date());

            const year = currentDate.getFullYear();
            const monthNames = ["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
            const monthStr = monthNames[currentDate.getMonth()];

            // 캘린더 생성 로직
            const firstDayOfMonth = new Date(year, currentDate.getMonth(), 1);
            const daysInMonth = new Date(year, currentDate.getMonth() + 1, 0).getDate();
            const startDay = firstDayOfMonth.getDay(); 

            // 히트맵 클래스 결정 로직
            const getHeatClass = (minutes) => {
                if (!minutes || minutes < 60) return 'heat-0';
                if (minutes <= 180) return 'heat-1'; // 60 ~ 180: Light Blue
                if (minutes <= 300) return 'heat-2'; // 180 ~ 300: Deep Blue
                return 'heat-3'; // 300+: Purple
            };

            const formatTime = (min) => {
                const h = Math.floor(min / 60);
                const m = min % 60;
                return h > 0 ? `${h}h ${m}m` : `${m}m`;
            };

            return (
                <div className="widget-container">
                    {/* Header */}
                    <div className="px-5 pt-5 pb-3 flex justify-between items-end border-b border-white/10 bg-white/5 backdrop-blur-sm z-10">
                        <div>
                            <div className="text-sky-300 text-[10px] font-bold tracking-widest uppercase mb-0.5 flex items-center gap-1">
                                <Icons.Flame />
                                <span>TOTAL: {Math.floor(monthTotal / 60)}h {monthTotal % 60}m</span>
                            </div>
                            <h1 className="text-xl title-text font-serif tracking-tight text-white font-bold">{monthStr}</h1>
                        </div>
                        <div className="flex gap-1 items-center pb-0.5">
                            <button onClick={goToday} className="nav-btn mr-1" title="Go Today"><Icons.RotateCcw /></button>
                            <button onClick={prevMonth} className="nav-btn"><Icons.ChevronLeft /></button>
                            <button onClick={nextMonth} className="nav-btn"><Icons.ChevronRight /></button>
                        </div>
                    </div>

                    {/* Calendar Grid */}
                    <div className="flex-1 pt-4 pb-4 flex flex-col justify-center">
                        <div className="calendar-grid mb-1">
                            {['S','M','T','W','T','F','S'].map((d, i) => (
                                <div key={i} className={`text-[9px] font-bold ${i === 0 ? 'text-rose-300' : (i === 6 ? 'text-blue-300' : 'text-slate-500')}`}>{d}</div>
                            ))}
                        </div>
                        <div className="calendar-grid">
                            {Array.from({length: 42}).map((_, i) => {
                                const dayNumber = i - startDay + 1;
                                const isValidDay = dayNumber > 0 && dayNumber <= daysInMonth;
                                
                                if (!isValidDay) return <div key={i} className="day-cell opacity-0 pointer-events-none"></div>;

                                const dateKey = `${year}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(dayNumber).padStart(2, '0')}`;
                                const minutes = focusData[dateKey] || 0;
                                const heatClass = getHeatClass(minutes);
                                
                                // 오늘 날짜 확인
                                const today = new Date();
                                const isToday = today.getFullYear() === year && today.getMonth() === currentDate.getMonth() && today.getDate() === dayNumber;

                                return (
                                    <div key={i} className={`day-cell ${heatClass} ${isToday ? 'day-today' : ''}`}>
                                        {/* 날짜 숫자 */}
                                        <span className={isToday ? "font-bold" : ""}>{dayNumber}</span>
                                        
                                        {/* 툴팁 (마우스 오버 시 시간 표시) */}
                                        {minutes > 0 && (
                                            <div className="tooltip">
                                                {formatTime(minutes)}
                                            </div>
                                        )}
                                    </div>
                                )
                            })}
                        </div>
                    </div>

                    {/* Legend (범례) */}
                    <div className="px-5 pb-4 flex items-center justify-center gap-3">
                        <div className="flex items-center gap-1.5">
                            <div className="w-2.5 h-2.5 rounded-sm heat-1"></div>
                            <span className="text-[9px] text-slate-400">1h+</span>
                        </div>
                        <div className="flex items-center gap-1.5">
                            <div className="w-2.5 h-2.5 rounded-sm heat-2"></div>
                            <span className="text-[9px] text-slate-400">3h+</span>
                        </div>
                        <div className="flex items-center gap-1.5">
                            <div className="w-2.5 h-2.5 rounded-sm heat-3"></div>
                            <span className="text-[9px] text-slate-400">5h+</span>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
