<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="robots" content="noindex, nofollow">
    <title>Fortress Satellite</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&family=Roboto+Mono:wght@500&display=swap');
        
        body {
    /* PC와 동일한 투명한 푸른 그라데이션 */
    background: linear-gradient(180deg, rgba(224, 242, 254, 0.5) 0%, rgba(240, 249, 255, 0.3) 100%);
    color: #334155; /* 글자색을 진한 남색(Slate-700)으로 변경하여 가독성 확보 */
    font-family: 'Noto Sans KR', sans-serif;
    -webkit-tap-highlight-color: transparent;
    min-height: 100vh;
}

        .glass-panel {
    background: rgba(255, 255, 255, 0.4); /* 밝고 투명한 흰색 */
    backdrop-filter: blur(12px);
    border: 1px solid rgba(255, 255, 255, 0.6); /* 테두리를 은은한 흰색으로 */
    border-radius: 20px; /* PC 버전처럼 조금 더 둥글게 */
    box-shadow: 0 4px 20px rgba(186, 230, 253, 0.15); /* 부드러운 그림자 추가 */
}

        /* 터치 반응형 버튼 */
        .action-btn {
            position: relative;
            overflow: hidden;
            transition: all 0.1s;
        }
        .action-btn:active {
            transform: scale(0.96);
            background: rgba(255, 255, 255, 0.1);
        }

        .loading-spinner {
            animation: spin 1s linear infinite;
        }
        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    </style>
</head>
<body class="flex flex-col min-h-screen p-4 safe-area">

    <div id="status-bar" class="text-center text-xs font-bold text-slate-500 mb-6 font-mono tracking-tight py-2">
        READY TO TRANSMIT
    </div>

    <div class="glass-panel p-4 mb-4">
        <h2 class="text-xs font-bold text-sky-400 mb-3 uppercase tracking-wider flex items-center gap-2">
            <i data-lucide="zap" class="w-3 h-3"></i> Quick Focus
        </h2>
        <div class="grid grid-cols-3 gap-2">
            <button onclick="sendData('focus', 30, '집중 30분')" class="action-btn bg-sky-900/30 border border-sky-700/30 rounded-xl py-3 flex flex-col items-center justify-center">
                <span class="text-lg font-bold text-sky-200">30</span>
                <span class="text-[10px] text-sky-400">MIN</span>
            </button>
            <button onclick="sendData('focus', 50, '집중 50분')" class="action-btn bg-sky-900/30 border border-sky-700/30 rounded-xl py-3 flex flex-col items-center justify-center">
                <span class="text-lg font-bold text-sky-200">50</span>
                <span class="text-[10px] text-sky-400">MIN</span>
            </button>
            <button onclick="sendData('focus', 90, '집중 90분')" class="action-btn bg-sky-900/30 border border-sky-700/30 rounded-xl py-3 flex flex-col items-center justify-center">
                <span class="text-lg font-bold text-sky-200">90</span>
                <span class="text-[10px] text-sky-400">MIN</span>
            </button>
        </div>
    </div>

    <div class="glass-panel p-4 flex-1">
        <h2 class="text-xs font-bold text-purple-400 mb-3 uppercase tracking-wider flex items-center gap-2">
            <i data-lucide="activity" class="w-3 h-3"></i> Activities
        </h2>
        <div class="grid grid-cols-2 gap-2">
            <button onclick="sendData('manual-switch', 60, '운동', 'Flame', 'text-purple-300', 20)" class="action-btn bg-purple-900/20 border border-purple-700/20 rounded-xl py-4 flex items-center justify-center gap-2">
                <i data-lucide="flame" class="w-4 h-4 text-purple-300"></i>
                <span class="text-sm font-bold text-slate-200">운동</span>
            </button>
            
            <button onclick="sendData('manual-switch', 30, '독서', 'Book', 'text-purple-300', 20)" class="action-btn bg-purple-900/20 border border-purple-700/20 rounded-xl py-4 flex items-center justify-center gap-2">
                <i data-lucide="book" class="w-4 h-4 text-purple-300"></i>
                <span class="text-sm font-bold text-slate-200">독서</span>
            </button>

            <button onclick="sendData('manual-rest', 30, '식사', 'Utensils', 'text-purple-300', 10)" class="action-btn bg-slate-800/50 border border-slate-700/50 rounded-xl py-4 flex items-center justify-center gap-2">
                <i data-lucide="utensils" class="w-4 h-4 text-slate-400"></i>
                <span class="text-sm font-bold text-slate-200">식사</span>
            </button>

            <button onclick="sendData('manual-rest', 20, '휴식', 'Coffee', 'text-purple-300', 15)" class="action-btn bg-slate-800/50 border border-slate-700/50 rounded-xl py-4 flex items-center justify-center gap-2">
                <i data-lucide="coffee" class="w-4 h-4 text-slate-400"></i>
                <span class="text-sm font-bold text-slate-200">휴식</span>
            </button>
            
            <button onclick="openCustom()" class="col-span-2 action-btn bg-slate-800/30 border border-slate-700/30 border-dashed rounded-xl py-3 flex items-center justify-center gap-2 text-slate-500">
                <i data-lucide="plus" class="w-4 h-4"></i>
                <span class="text-xs font-bold">직접 입력</span>
            </button>
        </div>
    </div>

    <script>
        // ★ 여기에 본인의 워커 URL을 입력하세요
        const WORKER_URL = "https://log-worker.moonkelly601.workers.dev";
        
        lucide.createIcons();

        const statusEl = document.getElementById('status-bar');

        const updateStatus = (msg, type = 'normal') => {
            statusEl.innerText = msg;
            if (type === 'error') statusEl.className = "text-center text-xs font-bold text-red-400 mb-6 font-mono py-2";
            else if (type === 'success') statusEl.className = "text-center text-xs font-bold text-sky-400 mb-6 font-mono py-2";
            else statusEl.className = "text-center text-xs font-bold text-slate-500 mb-6 font-mono py-2";
        };

        const formatLocalYMD = (d) => {
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        };

        // 핵심 로직: 불러오기 -> 추가하기 -> 저장하기 (Transaction)
        async function sendData(type, duration, name, icon, color, recovery) {
            if (!WORKER_URL) { alert("워커 URL을 설정해주세요."); return; }
            
            updateStatus("CONNECTING TO ORBIT...", "normal");
            
            try {
                const now = new Date();
                const dateYMD = formatLocalYMD(now);

                // 1. 최신 데이터 가져오기 (GET)
                const getRes = await fetch(`${WORKER_URL}?date=${dateYMD}`);
                if (!getRes.ok) throw new Error("서버 연결 실패");
                
                const serverData = await getRes.json();
                let blocks = serverData.blocks || [];

                // 2. 새 블록 생성
                const newBlock = {
                    id: Date.now(),
                    startTime: now.getTime() - (duration * 60 * 1000), // 현재 끝난 것으로 간주
                    endTime: now.getTime(),
                    duration: duration,
                    quality: 'Cloud', // 모바일은 기본값 설정
                    type: type.includes('switch') ? 'switch' : (type.includes('rest') ? 'rest' : 'focus'),
                    name: name || '모바일 기록',
                    icon: icon || (type === 'focus' ? 'Zap' : 'Circle'),
                    color: color || 'text-sky-300',
                    recovery: recovery || 0
                };

                // 3. 리스트에 추가 (Append)
                blocks.push(newBlock);
                
                // 4. 데이터 전송 (POST)
                const payload = {
                    ...serverData,
                    date: dateYMD, // 오늘 날짜 강제
                    blocks: blocks,
                    // 모바일에서는 에너지 계산을 하지 않고 기존 값을 유지하거나 서버 로직에 맡김
                    // 여기서는 안전하게 기존 값을 다시 보냄
                    lifeEnergy: serverData.lifeEnergy || 50,
                    energy: serverData.energy || 50
                };

                const postRes = await fetch(WORKER_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                if (!postRes.ok) throw new Error("전송 실패");

                updateStatus("TRANSMISSION COMPLETE", "success");
                setTimeout(() => updateStatus("READY TO TRANSMIT"), 2000);

            } catch (e) {
                console.error(e);
                updateStatus("ERROR: " + e.message, "error");
            }
        }

        function openCustom() {
            const name = prompt("활동 이름:");
            if (!name) return;
            const dur = prompt("소요 시간(분):", "30");
            if (!dur) return;
            
            sendData('manual-switch', parseInt(dur), name, 'Star', 'text-slate-300', 0);
        }
    </script>
</body>
</html>
