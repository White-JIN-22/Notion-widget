<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="robots" content="noindex, nofollow" />
    <meta name="referrer" content="no-referrer" />
    <title>Weekly Timetable (Glass v13)</title>
    <style>
      body {
        background-color: #0f0f0f;
        color: #f3f1eb;
        font-family: "Pretendard", sans-serif;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
      }

      .container {
        display: flex;
        gap: 6px;
        background: rgba(255, 255, 255, 0.04);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
        padding: 10px 14px;
        align-items: flex-start;
        transform: scale(0.85);
      }

      .time-column {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        justify-content: flex-start;
        margin-right: 8px;
        padding-top: 28px;
        height: 150px;
      }

      .time {
        font-size: 10px;
        color: #aaa;
        opacity: 0.8;
        margin-top: 13px;
      }

      .day {
        position: relative;
        width: 50px;
        height: 150px;
        border-radius: 14px;
        background: rgba(255, 255, 255, 0.07);
        display: flex;
        flex-direction: column;
        align-items: center;
        padding-top: 4px;
      }

      .day.today {
        background: rgba(255, 255, 255, 0.15);
        box-shadow: 0 0 10px rgba(255, 255, 255, 0.25);
      }

      .date {
        font-size: 10px;
        opacity: 0.9;
      }

      .weekday {
        font-size: 11px;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .block {
        position: absolute;
        left: 15%;
        width: 70%;
        border-radius: 6px;
        opacity: 0.85;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="time-column" id="timeLabels"></div>
      <div id="timetable" style="display: flex; gap: 4px"></div>
    </div>

    <script>
      const proxy = "https://ical-proxy.moonkelly601.workers.dev/";
      const calendars = {
        red: "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxInlf0nwQRwqVQaKN3oFgWzqLUfigKhteMNDAjQwkPlHzBe_ELV5RYcePFbCOI5H3TM",
        blue: "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxImfGB8G7hln8RI2A4WFBMN51g9wFHOsIhQgRFNSx9Dz4_f4s6w0S4RBWQw9Fgtt2mU"
      };
      const colors = ["#3d547f", "#b2c0d2", "#cecbd3", "#f3f1eb"];

      // 시간 라벨 (3시간 단위)
      const timeLabels = document.getElementById("timeLabels");
      for (let h = 6; h <= 24; h += 3) {
        const t = document.createElement("div");
        t.className = "time";
        t.textContent = String(h).padStart(2, "0");
        timeLabels.appendChild(t);
      }

      let allEvents = [];

      async function fetchCalendar(color, url) {
        const response = await fetch(`${proxy}?url=${encodeURIComponent(url)}`);
        const text = await response.text();
        parseICS(color, text);
      }

      function parseICS(color, text) {
        const lines = text.split("\n");
        let event = {};
        for (const line of lines) {
          if (line.startsWith("BEGIN:VEVENT")) event = {};
          else if (line.startsWith("DTSTART")) event.start = line.split(":")[1];
          else if (line.startsWith("DTEND")) event.end = line.split(":")[1];
          else if (line.startsWith("SUMMARY")) event.title = line.split(":")[1];
          else if (line.startsWith("END:VEVENT")) {
            if (event.start && event.end) {
              allEvents.push({ ...event, color });
            }
          }
        }
      }

      async function loadEvents() {
        for (const [color, url] of Object.entries(calendars)) {
          await fetchCalendar(color, url);
        }

        renderTimetable();
      }

      function renderTimetable() {
        const timetable = document.getElementById("timetable");
        timetable.innerHTML = "";

        const now = new Date();
        const localNow = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));

        const weekStart = new Date(localNow);
        weekStart.setDate(localNow.getDate() - ((localNow.getDay() + 6) % 7));
        const weekEnd = new Date(weekStart);
        weekEnd.setDate(weekStart.getDate() + 7);

        for (let i = 0; i < 7; i++) {
          const dayDate = new Date(weekStart);
          dayDate.setDate(weekStart.getDate() + i);

          const dayDiv = document.createElement("div");
          dayDiv.className = "day";
          if (dayDate.toDateString() === localNow.toDateString()) dayDiv.classList.add("today");

          const dateDiv = document.createElement("div");
          dateDiv.className = "date";
          dateDiv.textContent = `${String(dayDate.getMonth() + 1).padStart(2, "0")}/${String(dayDate.getDate()).padStart(2, "0")}`;

          const weekdayDiv = document.createElement("div");
          weekdayDiv.className = "weekday";
          weekdayDiv.textContent = ["MON","TUE","WED","THU","FRI","SAT","SUN"][i];

          dayDiv.append(dateDiv, weekdayDiv);

          // 일정 표시
          const sameDay = allEvents.filter(ev => {
            const y = ev.start.slice(0, 4);
            const m = ev.start.slice(4, 6);
            const d = ev.start.slice(6, 8);
            const date = new Date(`${y}-${m}-${d}T00:00:00+09:00`);
            return date.toDateString() === dayDate.toDateString();
          });

          sameDay.forEach((ev, idx) => {
            const startHour = parseInt(ev.start.slice(9, 11)) + 9;
            const endHour = parseInt(ev.end.slice(9, 11)) + 9;
            const duration = Math.max(1, endHour - startHour);

            const block = document.createElement("div");
            block.className = "block";
            block.style.background = colors[idx % colors.length];
            block.style.top = `${(startHour - 6) * 4 + 36}px`;
            block.style.height = `${duration * 4}px`;
            dayDiv.appendChild(block);
          });

          timetable.appendChild(dayDiv);
        }
      }

      loadEvents();
    </script>
  </body>
</html>
