<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Timetable (Glass v40)</title>
<style>
  body {
    margin: 0;
    background: linear-gradient(180deg, #0b0b0d 0%, #141418 100%);
    color: #f2f2f2;
    font-family: 'Pretendard', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }

  .this-week {
    margin-top: 6px;
    background: rgba(255,255,255,0.08);
    border: none;
    border-radius: 10px;
    color: #eee;
    padding: 4px 10px;
    font-size: 0.7rem;
    cursor: pointer;
    backdrop-filter: blur(10px);
    transition: background 0.2s ease;
  }
  .this-week:hover { background: rgba(255,255,255,0.15); }

  .top-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 6px;
    gap: 6px;
  }

  .nav-btn {
    background: rgba(255,255,255,0.08);
    border: none;
    border-radius: 8px;
    color: #ccc;
    padding: 3px 8px;
    cursor: pointer;
    backdrop-filter: blur(10px);
    font-size: 0.7rem;
  }

  .week-label {
    background: rgba(255,255,255,0.07);
    border-radius: 10px;
    padding: 4px 10px;
    font-weight: 500;
    color: #e4e4e4;
    backdrop-filter: blur(6px);
    font-size: 0.75rem;
  }

  .timetable {
    position: relative;
    width: 45vw;
    max-width: 450px;
    height: 40vh;
    margin-top: 6px;
    background: rgba(255,255,255,0.03);
    border-radius: 18px;
    overflow: hidden;
    box-shadow: inset 0 0 10px rgba(255,255,255,0.04);
  }

  .day-header {
    position: absolute;
    top: 0;
    width: calc(100% / 7);
    text-align: center;
    font-weight: 600;
    font-size: 0.7rem;
    padding: 4px 0;
    background: rgba(255,255,255,0.07);
    border-radius: 8px;
    backdrop-filter: blur(6px);
    box-shadow: 0 1px 3px rgba(0,0,0,0.25);
    white-space: pre-line;
  }

  .hour-line {
    position: absolute;
    left: 0;
    width: 100%;
    border-top: 1px solid rgba(255,255,255,0.08);
  }
  .major-line {
    border-top: 2px solid rgba(255,255,255,0.25);
  }

  .hour-label {
    position: absolute;
    left: 2px;
    font-size: 0.65rem;
    color: #aaa;
    font-weight: 500;
  }

  .event-block {
    position: absolute;
    border-radius: 8px;
    backdrop-filter: blur(6px);
    opacity: 0.9;
    transition: transform 0.15s ease;
  }
  .event-block:hover { transform: scale(1.05); }

  .tooltip {
    position: absolute;
    background: rgba(0,0,0,0.85);
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 0.6rem;
    pointer-events: none;
    color: #fff;
    transform: translate(-50%, -110%);
    display: none;
    white-space: nowrap;
  }
</style>
</head>
<body>

<button class="this-week" id="thisWeek">THIS WEEK</button>
<div class="top-controls">
  <button class="nav-btn" id="prevWeek">←</button>
  <div class="week-label" id="weekLabel">2025 : 49 / 52W</div>
  <button class="nav-btn" id="nextWeek">→</button>
</div>

<div class="timetable" id="timetable"></div>

<script>
const timetable = document.getElementById("timetable");
const headerHeight = 35;
let currentMonday = getMonday(new Date());
const icalUrls = [
  "webcal://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxInlf0nwQRwqVQaKN3oFgWzqLUfigKhteMNDAjQwkPlHzBe_ELV5RYcePFbCOI5H3TM",
  "webcal://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIlkFT1ZEqbRVczq6PrGuVHb0Afa1EhpfGiSULTpK_tYur-eQz2Uqc74JIqfAKkjBP8",
  "webcal://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxImfGB8G7hln8RI2A4WFBMN51g9wFHOsIhQgRFNSx9Dz4_f4s6w0S4RBWQw9Fgtt2mU",
  "webcal://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIks_Phe4DHFMcJQdGTXVekoe7DfsUtHGLCLydgauhnycV_BUoW1c_GcPu0dMkd_m9I"
];
let allEvents = [];

function getMonday(d){d=new Date(d);const day=d.getDay();const diff=d.getDate()-day+(day===0?-6:1);return new Date(d.setDate(diff));}
function getWeekNumber(d){const oneJan=new Date(d.getFullYear(),0,1);return Math.ceil((((d-oneJan)/86400000)+oneJan.getDay()+1)/7);}
const recurringHolidays=["01-01","03-01","05-05","06-06","08-15","10-03","10-09","12-25"];

function renderWeek(monday){
  timetable.innerHTML="";
  const weekLabel=document.getElementById("weekLabel");
  const weekNum=getWeekNumber(monday);
  weekLabel.textContent=`${monday.getFullYear()} : ${weekNum} / 52W`;

  const days=["MON","TUE","WED","THU","FRI","SAT","SUN"];
  for(let i=0;i<7;i++){
    const head=document.createElement("div");
    head.className="day-header";
    const date=new Date(monday);
    date.setDate(monday.getDate()+i);
    head.style.left=`${(i*100/7)}%`;
    head.style.width=`calc(100%/7 - 4px)`;
    head.style.margin="2px";
    head.textContent=`${String(date.getMonth()+1).padStart(2,"0")}/${String(date.getDate()).padStart(2,"0")}\n${days[i]}`;
    const monthDayKey=`${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`;
    if(recurringHolidays.includes(monthDayKey)){
      head.style.color="rgba(255,150,120,0.9)";
      head.style.textShadow="0 0 6px rgba(255,150,120,0.3)";
    }else if(i===6)head.style.color="#fff";
    timetable.appendChild(head);
  }

  // 시간 라인
  for(let h=6;h<=24;h++){
    const line=document.createElement("div");
    line.className="hour-line"+((h%6===0)?" major-line":"");
    line.style.top=`calc(${headerHeight}px + ${((h-6)/18)*100}%)`;
    timetable.appendChild(line);
    if(h%6===0){
      const label=document.createElement("div");
      label.className="hour-label";
      label.style.top=`calc(${headerHeight-10}px + ${((h-6)/18)*100}%)`;
      label.textContent=h;
      timetable.appendChild(label);
    }
  }

  const weekStart=new Date(monday);
  const weekEnd=new Date(monday);
  weekEnd.setDate(weekEnd.getDate()+6);
  weekEnd.setHours(23,59,59,999);
  const weekEvents=allEvents.filter(ev=>ev.start>=weekStart&&ev.start<=weekEnd);
  weekEvents.forEach(ev=>{
    const block=document.createElement("div");
    block.className="event-block";
    block.style.background=ev.color;
    const dayIndex=(ev.start.getDay()+6)%7;
    block.style.left=`calc(${dayIndex*(100/7)}% + 2px)`;
    block.style.width=`calc(100%/7 - 4px)`;
    block.style.top=`calc(${headerHeight}px + ${((ev.start.getHours()-6)/18)*100}%)`;
    block.style.height=`${((ev.end-ev.start)/3600000/18)*100}%`;
    const tooltip=document.createElement("div");
    tooltip.className="tooltip";
    tooltip.textContent=`${ev.start.getHours()}:00 ~ ${ev.end.getHours()}:00 ${ev.title}`;
    block.appendChild(tooltip);
    block.addEventListener("mouseenter",()=>tooltip.style.display="block");
    block.addEventListener("mouseleave",()=>tooltip.style.display="none");
    timetable.appendChild(block);
  });
}

async function loadICS(){
  for(const url of icalUrls){
    const res=await fetch("https://ical-proxy.moonkelly601.workers.dev/?url="+encodeURIComponent(url));
    const text=await res.text();
    parseICS(text,url);
  }
  renderWeek(currentMonday);
}

function parseICS(data,url){
  const colorMap={
    "Inlf0nwQRwqVQaKN3oFgWzqLUfigKhteMNDAjQwkPlHzBe_ELV5RYcePFbCOI5H3TM":"#3d547f",
    "IlkFT1ZEqbRVczq6PrGuVHb0Afa1EhpfGiSULTpK_tYur-eQz2Uqc74JIqfAKkjBP8":"#b2c0d2",
    "ImfGB8G7hln8RI2A4WFBMN51g9wFHOsIhQgRFNSx9Dz4_f4s6w0S4RBWQw9Fgtt2mU":"#cecbd3",
    "Iks_Phe4DHFMcJQdGTXVekoe7DfsUtHGLCLydgauhnycV_BUoW1c_GcPu0dMkd_m9I":"#f3f1eb"
  };
  const colorKey=url.split("Ilx")[1]?.slice(0,30)||"";
  const color=colorMap[colorKey]||"#888";
  const lines=data.split(/\r?\n/);
  let event=null;
  for(const line of lines){
    if(line.startsWith("BEGIN:VEVENT"))event={};
    else if(line.startsWith("END:VEVENT")){
      if(event.start&&event.end&&event.title){
        event.color=color;
        allEvents.push(event);
      }
      event=null;
    }else if(event){
      if(line.startsWith("DTSTART"))event.start=parseDate(line.split(":")[1]);
      else if(line.startsWith("DTEND"))event.end=parseDate(line.split(":")[1]);
      else if(line.startsWith("SUMMARY"))event.title=line.replace("SUMMARY:","").trim();
    }
  }
}

function parseDate(str){
  const y=parseInt(str.slice(0,4));
  const m=parseInt(str.slice(4,6))-1;
  const d=parseInt(str.slice(6,8));
  const h=parseInt(str.slice(9,11)||"0");
  const min=parseInt(str.slice(11,13)||"0");
  const local=new Date(Date.UTC(y,m,d,h,min));
  return new Date(local.getTime()+32400000);
}

document.getElementById("prevWeek").onclick=()=>{currentMonday.setDate(currentMonday.getDate()-7);renderWeek(currentMonday);}
document.getElementById("nextWeek").onclick=()=>{currentMonday.setDate(currentMonday.getDate()+7);renderWeek(currentMonday);}
document.getElementById("thisWeek").onclick=()=>{currentMonday=getMonday(new Date());renderWeek(currentMonday);}
loadICS();
</script>
</body>
</html>
