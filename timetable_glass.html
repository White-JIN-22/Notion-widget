<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="robots" content="noindex, nofollow" />
<meta name="referrer" content="no-referrer" />
<title>Weekly Timetable (v24)</title>

<style>
  body {
    background-color: #0e0e10;
    font-family: "Pretendard", sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
    color: #f5f5f5;
  }
  .timetable {
    display: flex;
    flex-direction: column;
    gap: 8px;
    background: rgba(255,255,255,0.06);
    backdrop-filter: blur(20px);
    border-radius: 18px;
    box-shadow: 0 4px 18px rgba(0,0,0,0.4);
    padding: 18px 22px;
    width: 340px;
  }
  .header {
    text-align: center;
    font-weight: 600;
    font-size: 1.05rem;
    color: #c9d8ff;
  }
  #calendarEvents {
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-size: 0.9rem;
  }
  .event-item {
    background: rgba(255,255,255,0.1);
    border-radius: 10px;
    padding: 6px 10px;
    position: relative;
    transition: all 0.2s ease;
    cursor: pointer;
    backdrop-filter: blur(25px);
  }
  .event-item:hover {
    background: rgba(180,200,255,0.2);
    transform: translateY(-2px);
  }
  .tooltip {
    position: absolute;
    background: rgba(0,0,0,0.85);
    color: #fff;
    font-size: 0.8rem;
    padding: 6px 10px;
    border-radius: 8px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.2s ease;
    z-index: 10;
  }
</style>
</head>
<body>
  <div class="timetable">
    <div class="header">오늘 · 내일 일정</div>
    <div id="calendarEvents"></div>
  </div>
  <div id="tooltip" class="tooltip"></div>

<script>
const proxy = "https://ical-proxy.moonkelly601.workers.dev/";

const icalUrls = [
  "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxInlf0nwQRwqVQaKN3oFgWzqLUfigKhteMNDAjQwkPlHzBe_ELV5RYcePFbCOI5H3TM", // 업무
  "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxImfGB8G7hln8RI2A4WFBMN51g9wFHOsIhQgRFNSx9Dz4_f4s6w0S4RBWQw9Fgtt2mU", // 자기계발
  "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIlkFT1ZEqbRVczq6PrGuVHb0Afa1EhpfGiSULTpK_tYur-eQz2Uqc74JIqfAKkjBP8", // 건강
  "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIks_Phe4DHFMcJQdGTXVekoe7DfsUtHGLCLydgauhnycV_BUoW1c_GcPu0dMkd_m9I"  // 휴식
];

function parseICSTime(icsTime) {
  const y = icsTime.slice(0, 4);
  const m = icsTime.slice(4, 6);
  const d = icsTime.slice(6, 8);
  const h = icsTime.slice(9, 11) || "00";
  const min = icsTime.slice(11, 13) || "00";
  return new Date(`${y}-${m}-${d}T${h}:${min}:00+09:00`);
}

async function loadICS(urls) {
  const events = [];
  const now = new Date();
  const tomorrow = new Date();
  tomorrow.setDate(now.getDate() + 1);

  for (const url of urls) {
    const res = await fetch(`${proxy}?url=${encodeURIComponent(url)}`);
    const text = await res.text();

    const vevents = text.split("BEGIN:VEVENT").slice(1);
    for (const v of vevents) {
      if (v.includes("VTODO")) continue; // 미리알림 제외

      const summary = (v.match(/SUMMARY:(.+)/) || [])[1]?.trim() || "";
      const dtStart = (v.match(/DTSTART(?:;TZID=[^:]+)?:([0-9TZ]+)/) || [])[1];
      const dtEnd = (v.match(/DTEND(?:;TZID=[^:]+)?:([0-9TZ]+)/) || [])[1];
      const recurrenceId = (v.match(/RECURRENCE-ID[^:]*:([0-9TZ]+)/) || [])[1];
      if (!summary || (!dtStart && !recurrenceId)) continue;

      const start = dtStart ? parseICSTime(dtStart) : parseICSTime(recurrenceId);
      const end = dtEnd ? parseICSTime(dtEnd) : new Date(start.getTime() + 3600000);

      if (end >= now && start <= tomorrow) {
        events.push({ summary, start, end });
      }
    }
  }

  renderEvents(events);
}

function renderEvents(events) {
  const container = document.getElementById("calendarEvents");
  const tooltip = document.getElementById("tooltip");
  container.innerHTML = "";

  events.sort((a, b) => a.start - b.start);
  for (const ev of events) {
    const div = document.createElement("div");
    div.className = "event-item";
    div.textContent = `${String(ev.start.getHours()).padStart(2,"0")}:${String(ev.start.getMinutes()).padStart(2,"0")} ${ev.summary}`;
    
    div.addEventListener("mouseenter", e => {
      tooltip.style.opacity = 1;
      tooltip.innerHTML = `${ev.summary}<br>${ev.start.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})} - ${ev.end.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}`;
      tooltip.style.left = e.pageX + 10 + "px";
      tooltip.style.top = e.pageY - 20 + "px";
    });
    div.addEventListener("mousemove", e => {
      tooltip.style.left = e.pageX + 10 + "px";
      tooltip.style.top = e.pageY - 20 + "px";
    });
    div.addEventListener("mouseleave", () => tooltip.style.opacity = 0);

    container.appendChild(div);
  }
}

loadICS(icalUrls);
</script>
</body>
</html>
