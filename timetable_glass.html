const timetable<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Timetable (Glass v51 Stable)</title>
<style>
  body {
    background: linear-gradient(180deg, #0b0b0d 0%, #141418 100%);
    color: #fff;
    font-family: "Inter", "Pretendard", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }

  .this-week {
    margin-top: 8px;
    background: rgba(255,255,255,0.08);
    border: none;
    border-radius: 10px;
    color: #eee;
    padding: 4px 10px;
    font-size: 0.7rem;
    cursor: pointer;
    backdrop-filter: blur(10px);
  }

  .top-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    margin-top: 6px;
    gap: 6px;
  }

  .nav-btn {
    background: rgba(255,255,255,0.08);
    border: none;
    border-radius: 8px;
    color: #ccc;
    padding: 3px 8px;
    cursor: pointer;
    backdrop-filter: blur(10px);
    font-size: 0.7rem;
  }

  .week-label {
    background: rgba(255,255,255,0.07);
    border-radius: 10px;
    padding: 4px 10px;
    font-weight: 500;
    color: #e4e4e4;
    backdrop-filter: blur(6px);
    font-size: 0.75rem;
    margin-top: 4px;
  }

  .timetable {
    display: grid;
    grid-template-columns: 35px repeat(7, 1fr);
    grid-template-rows: 35px repeat(19, 1fr);
    width: 45vw;
    max-width: 450px;
    height: 53vh;
    margin-top: 8px;
    border-radius: 18px;
    background: rgba(255,255,255,0.03);
    backdrop-filter: blur(18px);
    box-shadow: inset 0 0 10px rgba(255,255,255,0.05);
    position: relative;
    overflow: hidden;
  }

  .day-header {
    text-align: center;
    font-size: 10px;
    font-weight: 600;
    line-height: 1.3;
    white-space: pre-line;
    border-right: 1px solid rgba(255,255,255,0.08);
    background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.03) 100%);
    border-radius: 6px;
    padding-top: 4px;
    color: rgba(255,255,255,0.6);
  }

  .day-header.today {
    background: rgba(255,255,255,0.3);
    color: #fff;
    font-weight: 700;
    box-shadow: 0 0 10px rgba(255,255,255,0.4);
  }

  .time-label {
    text-align: center;
    font-size: 9px;
    color: rgba(255,255,255,0.6);
  }

  .time-label.bold {
    font-weight: 700;
    color: rgba(255,255,255,0.9);
  }

  .grid-line {
    grid-column: 2 / span 7;
    border-top: 1px solid rgba(255,255,255,0.05);
  }

  .grid-line.bold {
    border-top: 1px solid rgba(255,255,255,0.15);
  }

  .event {
    position: absolute;
    border-radius: 6px;
    overflow: hidden;
    backdrop-filter: blur(8px);
    transition: all 0.2s ease;
    box-shadow: 0 3px 6px rgba(0,0,0,0.4);
    cursor: pointer;
  }

  .tooltip {
    position: absolute;
    background: rgba(0,0,0,0.85);
    color: #fff;
    font-size: 10px;
    padding: 5px 8px;
    border-radius: 6px;
    white-space: pre-line;
    line-height: 1.4;
    pointer-events: none;
    z-index: 10;
    opacity: 0;
    transform: scale(0.95);
    transition: all 0.15s ease;
  }

  .tooltip.active {
    opacity: 1;
    transform: scale(1);
  }

  .dot {
    display: inline-block;
    width: 6px;
    height: 6px;
    border-radius: 50%;
    margin-right: 4px;
  }
</style>
</head>
<body>
<button class="this-week" id="thisWeek">THIS WEEK</button>
<div class="top-controls">
  <button class="nav-btn" id="prevWeek">←</button>
  <div class="week-label" id="weekLabel">2025 : 49 / 52W</div>
  <button class="nav-btn" id="nextWeek">→</button>
</div>

<div class="timetable" id="timetable"></div>

<script>
const timetable = document.getElementById("timetable");
const days = ["MON","TUE","WED","THU","FRI","SAT","SUN"];
let currentMonday = getMonday(new Date());
const recurringHolidays = ["01-01","03-01","05-05","06-06","08-15","10-03","10-09","12-25"];

const icalUrls = [
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxInlf0nwQRwqVQaKN3oFgWzqLUfigKhteMNDAjQwkPlHzBe_ELV5RYcePFbCOI5H3TM",
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIlkFT1ZEqbRVczq6PrGuVHb0Afa1EhpfGiSULTpK_tYur-eQz2Uqc74JIqfAKkjBP8",
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxImfGB8G7hln8RI2A4WFBMN51g9wFHOsIhQgRFNSx9Dz4_f4s6w0S4RBWQw9Fgtt2mU",
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIks_Phe4DHFMcJQdGTXVekoe7DfsUtHGLCLydgauhnycV_BUoW1c_GcPu0dMkd_m9I"
];

const icalColorMap = {
  0: "rgba(160,210,255,1)", // 자기계발
  1: "rgba(200,180,255,1)", // 건강
  2: "rgba(61,84,127,1)",   // 업무
  3: "rgba(255,255,245,1)"  // 휴식
};

function getMonday(d){d=new Date(d);const day=d.getDay();const diff=d.getDate()-day+(day===0?-6:1);return new Date(d.setDate(diff));}
function getWeekNumber(d){const oneJan=new Date(d.getFullYear(),0,1);return Math.ceil((((d-oneJan)/86400000)+oneJan.getDay()+1)/7);}

function renderWeek(monday){
  timetable.innerHTML="";
  const weekLabel=document.getElementById("weekLabel");
  const weekNum=getWeekNumber(monday);
  weekLabel.textContent=`${monday.getFullYear()} : ${weekNum} / 52W`;

  const today=new Date();
  days.forEach((d,i)=>{
    const head=document.createElement("div");
    head.className="day-header";
    const date=new Date(monday);
    date.setDate(monday.getDate()+i);
    const dateStr=`${String(date.getMonth()+1).padStart(2,"0")}/${String(date.getDate()).padStart(2,"0")}`;
    const monthDayKey=`${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`;
    if(recurringHolidays.includes(monthDayKey))head.style.color="rgba(255,150,120,0.9)";
    if(date.toDateString()===today.toDateString())head.classList.add("today");
    if(date.toDateString()!==today.toDateString())head.style.opacity="0.6";
    head.textContent=`${dateStr}\n${d}`;
    timetable.appendChild(head);
  });

  const mainHours=[6,12,18,24];
  for(let h=6;h<=24;h++){
    const label=document.createElement("div");
    const line=document.createElement("div");
    if(mainHours.includes(h)){
      label.className="time-label bold";
      label.textContent=String(h).padStart(2,"0");
      line.className="grid-line bold";
    } else {
      label.className="time-label";
      label.textContent="";
      line.className="grid-line";
    }
    timetable.appendChild(label);
    timetable.appendChild(line);
  }

  loadICS(icalUrls,monday,today);
}

async function loadICS(urls,monday,today){
  const sunday=new Date(monday);
  sunday.setDate(monday.getDate()+6);
  sunday.setHours(23,59,59,999);
  for(const [idx,url] of urls.entries()){
    try{
      const res=await fetch(url);
      const text=await res.text();
      parseICS(text,monday,sunday,today,icalColorMap[idx]);
    }catch(err){console.error("ICS fetch error",err);}
  }
}

function parseICS(ics,monday,sunday,today,color){
  const rowHeight=timetable.offsetHeight/(24-6-0.001); // 미세 오차 방지
  const columnWidth=(timetable.offsetWidth-35)/7;
  const events=ics.split("BEGIN:VEVENT").slice(1).map(e=>"BEGIN:VEVENT"+e);

  events.forEach(ev=>{
    if(ev.includes("VTODO")||ev.includes("VEVENT;VALUE=DATE"))return;
    if(ev.includes("미리 알림")||ev.includes("이동시간"))return;

    const summary=(ev.match(/SUMMARY:(.+)/)||[])[1]?.trim()||"";
    const start=(ev.match(/DTSTART[^:]*:(.+)/)||[])[1];
    const end=(ev.match(/DTEND[^:]*:(.+)/)||[])[1];
    const rrule=(ev.match(/RRULE:(.+)/)||[])[1];
    if(!start||!end)return;

    const s=parseDate(start);
    const e=parseDate(end);
    if(!s||!e)return;

    // 반복 일정이면 해당 주차에 해당하는 날짜로 복제
    if(rrule && rrule.includes("FREQ=WEEKLY")){
      for(let i=0;i<52;i++){
        const recur=new Date(s);
        recur.setDate(s.getDate()+7*i);
        if(recur>=monday && recur<=sunday){
          drawEvent(recur,new Date(recur.getTime()+(e-s)),today,color,summary,columnWidth,rowHeight);
        }
      }
    } else {
      if(s < monday || s > sunday)return;
      drawEvent(s,e,today,color,summary,columnWidth,rowHeight);
    }
  });

  document.addEventListener("click",()=>document.querySelectorAll(".tooltip.active").forEach(t=>t.remove()));
}

function drawEvent(s,e,today,color,summary,columnWidth,rowHeight){
  const dayIndex=(s.getDay()+6)%7;
  const startHour=s.getHours()+s.getMinutes()/60;
  const endHour=e.getHours()+e.getMinutes()/60 || 24;
  const top=Math.round((startHour-6)*rowHeight);
  const height=Math.round((endHour-startHour)*rowHeight);
  const left=Math.round(35+(dayIndex*columnWidth));
  const width=Math.round(columnWidth-6);
  const opacity=(s.toDateString()===today.toDateString())?1.0:0.5;

  const block=document.createElement("div");
  block.className="event";
  block.style.backgroundColor=color;
  block.style.opacity=opacity;
  block.style.top=`${top}px`;
  block.style.left=`${left}px`;
  block.style.height=`${height}px`;
  block.style.width=`${width}px`;

  block.addEventListener("click",(e)=>{
    e.stopPropagation();
    document.querySelectorAll(".tooltip.active").forEach(t=>t.remove());
    const tooltip=document.createElement("div");
    tooltip.className="tooltip active";
    tooltip.innerHTML=`<span class='dot' style='background:${color}'></span>${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}\n${summary}`;
    timetable.appendChild(tooltip);

    const rect=block.getBoundingClientRect();
    const parentRect=timetable.getBoundingClientRect();
    let tooltipX=(dayIndex===6)
      ? rect.left-parentRect.left-tooltip.offsetWidth-8
      : rect.right-parentRect.left+8;
    let tooltipY=rect.top-parentRect.top+rect.height/2-tooltip.offsetHeight/2;

    if(tooltipY+tooltip.offsetHeight>timetable.offsetHeight-4)
      tooltipY=timetable.offsetHeight-tooltip.offsetHeight-4;
    if(tooltipY<0) tooltipY=0;

    tooltip.style.left=`${tooltipX}px`;
    tooltip.style.top=`${tooltipY}px`;
  });

  timetable.appendChild(block);
}

function parseDate(str){
  if(!str)return null;
  if(str.includes("T")){
    const[date,time]=str.split("T");
    const year=date.slice(0,4),month=date.slice(4,6)-1,day=date.slice(6,8);
    const hour=parseInt(time.slice(0,2)),min=parseInt(time.slice(2,4));
    return new Date(year,month,day,hour,min);
  }
  return null;
}

document.getElementById("prevWeek").onclick=()=>{currentMonday.setDate(currentMonday.getDate()-7);renderWeek(currentMonday);}
document.getElementById("nextWeek").onclick=()=>{currentMonday.setDate(currentMonday.getDate()+7);renderWeek(currentMonday);}
document.getElementById("thisWeek").onclick=()=>{currentMonday=getMonday(new Date());renderWeek(currentMonday);}
renderWeek(currentMonday);
</script>
</body>
</html>
