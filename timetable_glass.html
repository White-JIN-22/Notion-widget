<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Timetable (Glass v21)</title>
<style>
  body {
    background-color: #0f0f0f;
    color: #f3f1eb;
    font-family: "Pretendard", sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    margin: 0;
  }
  .container {
    display: flex;
    gap: 6px;
    background: rgba(255,255,255,0.04);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    padding: 10px 14px;
    transform: scale(0.9);
  }
  .time-column {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    padding-top: 28px;
    height: 720px;
  }
  .time {
    font-size: 10px;
    color: #aaa;
    opacity: 0.8;
    height: 40px;
  }
  .day {
    position: relative;
    width: 46px;
    height: 720px;
    border-radius: 14px;
    background: rgba(255,255,255,0.07);
    display: flex;
    flex-direction: column;
    align-items: center;
    padding-top: 4px;
  }
  .day.today {
    background: rgba(255,255,255,0.15);
    box-shadow: 0 0 10px rgba(255,255,255,0.25);
  }
  .date { font-size: 10px; opacity: 0.9; }
  .weekday { font-size: 11px; font-weight: 600; margin-bottom: 4px; }
  .block {
    position: absolute;
    left: 15%;
    width: 70%;
    border-radius: 6px;
    opacity: 0.85;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .block:hover { transform: scale(1.1); opacity: 1; }
  .tooltip {
    position: absolute;
    background: rgba(0,0,0,0.8);
    color: #fff;
    font-size: 10px;
    padding: 4px 6px;
    border-radius: 6px;
    white-space: nowrap;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s;
    z-index: 10;
  }
</style>
</head>
<body>
  <div class="container">
    <div class="time-column" id="timeLabels"></div>
    <div id="timetable" style="display:flex;gap:4px"></div>
  </div>
  <div id="tooltip" class="tooltip"></div>

<script>
const proxy = "https://ical-proxy.moonkelly601.workers.dev/";
const calendars = {
  red: "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxInlf0nwQRwqVQaKN3oFgWzqLUfigKhteMNDAjQwkPlHzBe_ELV5RYcePFbCOI5H3TM",
  blue: "https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxImfGB8G7hln8RI2A4WFBMN51g9wFHOsIhQgRFNSx9Dz4_f4s6w0S4RBWQw9Fgtt2mU"
};
const colors = ["#3d547f", "#b2c0d2", "#cecbd3", "#f2b179", "#a4e38f", "#f07c82"];

const timeLabels = document.getElementById("timeLabels");
for (let h = 6; h <= 24; h++) {
  const t = document.createElement("div");
  t.className = "time";
  t.textContent = String(h).padStart(2, "0");
  timeLabels.appendChild(t);
}

let allEvents = [];

async function fetchCalendar(color, url) {
  const res = await fetch(`${proxy}?url=${encodeURIComponent(url)}`);
  const text = await res.text();
  parseICS(color, text);
}

function parseICS(color, text) {
  const lines = text.replace(/\r\n|\r/g, "\n").split("\n").map(l => l.trim());
  let ev = {};
  for (const line of lines) {
    if (line.startsWith("BEGIN:VEVENT")) ev = {};
    else if (line.startsWith("DTSTART")) {
      if (line.includes("VALUE=DATE")) ev.allday = true;
      else {
        const m = line.match(/(?:DTSTART(?:;TZID=[^:]+)?:(\d{8}T\d{6}))/);
        if (m) ev.start = m[1];
      }
    } else if (line.startsWith("DTEND")) {
      const m = line.match(/(?:DTEND(?:;TZID=[^:]+)?:(\d{8}T\d{6}))/);
      if (m) ev.end = m[1];
    } else if (line.startsWith("SUMMARY")) ev.title = line.split(":").slice(1).join(":");
    else if (line.startsWith("TRAVELTIME") || line.startsWith("TRIGGER")) ev.ignore = true;
    else if (line.startsWith("END:VEVENT")) {
      if (!ev.start || ev.allday || ev.ignore) continue;

      const s = new Date(`${ev.start.slice(0,4)}-${ev.start.slice(4,6)}-${ev.start.slice(6,8)}T${ev.start.slice(9,11)}:${ev.start.slice(11,13)}:00+09:00`);
      let e;
      if (ev.end) {
        e = new Date(`${ev.end.slice(0,4)}-${ev.end.slice(4,6)}-${ev.end.slice(6,8)}T${ev.end.slice(9,11)}:${ev.end.slice(11,13)}:00+09:00`);
      } else {
        e = new Date(s.getTime() + 60 * 60 * 1000);
      }

      // 00:00 넘어가면 24시 처리
      if (e.getDate() !== s.getDate()) e = new Date(`${s.getFullYear()}-${s.getMonth()+1}-${s.getDate()}T24:00:00+09:00`);

      allEvents.push({ start: s, end: e, title: ev.title, color });
    }
  }
}

async function loadEvents() {
  allEvents = [];
  for (const [c, u] of Object.entries(calendars)) await fetchCalendar(c, u);
  renderTimetable();
}

function renderTimetable() {
  const timetable = document.getElementById("timetable");
  timetable.innerHTML = "";
  const tooltip = document.getElementById("tooltip");

  const now = new Date();
  const localNow = new Date(now.toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
  const weekStart = new Date(localNow);
  weekStart.setDate(localNow.getDate() - ((localNow.getDay() + 6) % 7));

  for (let i = 0; i < 7; i++) {
    const dayDate = new Date(weekStart);
    dayDate.setDate(weekStart.getDate() + i);

    const dayDiv = document.createElement("div");
    dayDiv.className = "day";
    if (dayDate.toDateString() === localNow.toDateString())
      dayDiv.classList.add("today");

    const dateDiv = document.createElement("div");
    dateDiv.className = "date";
    dateDiv.textContent = `${String(dayDate.getMonth() + 1).padStart(2, "0")}/${String(dayDate.getDate()).padStart(2, "0")}`;
    const weekdayDiv = document.createElement("div");
    weekdayDiv.className = "weekday";
    weekdayDiv.textContent = ["MON","TUE","WED","THU","FRI","SAT","SUN"][i];
    dayDiv.append(dateDiv, weekdayDiv);

    const events = allEvents.filter(ev =>
      ev.start.getFullYear() === dayDate.getFullYear() &&
      ev.start.getMonth() === dayDate.getMonth() &&
      (ev.start.getDate() === dayDate.getDate() || ev.end.getDate() === dayDate.getDate())
    );

    events.forEach((ev, idx) => {
      const startHour = ev.start.getHours() + ev.start.getMinutes() / 60;
      const endHour = ev.end.getHours() + ev.end.getMinutes() / 60;
      const duration = Math.max(0.5, endHour - startHour);

      const block = document.createElement("div");
      block.className = "block";
      block.style.background = colors[idx % colors.length];
      block.style.top = `${(startHour - 6) * 40 + 35}px`;
      block.style.height = `${duration * 40}px`;

      block.addEventListener("mouseenter", e => {
        tooltip.style.opacity = 1;
        tooltip.innerHTML = `${String(ev.start.getHours()).padStart(2,"0")}:${String(ev.start.getMinutes()).padStart(2,"0")} ~ ${String(ev.end.getHours()).padStart(2,"0")}:${String(ev.end.getMinutes()).padStart(2,"0")}<br>${ev.title}`;
        tooltip.style.left = e.pageX + 10 + "px";
        tooltip.style.top = e.pageY - 20 + "px";
      });
      block.addEventListener("mousemove", e => {
        tooltip.style.left = e.pageX + 10 + "px";
        tooltip.style.top = e.pageY - 20 + "px";
      });
      block.addEventListener("mouseleave", () => (tooltip.style.opacity = 0));

      dayDiv.appendChild(block);
    });

    timetable.appendChild(dayDiv);
  }
}

loadEvents();
</script>
</body>
</html>
