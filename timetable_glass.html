<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Timetable (Glass v58)</title>
<style>
  body {
    background: linear-gradient(180deg, #0b0b0d 0%, #141418 100%);
    color: #fff;
    font-family: "Inter", "Pretendard", sans-serif;
    display: flex; flex-direction: column; align-items: center;
    height: 100vh; overflow: hidden;
  }
  .this-week, .nav-btn {
    background: rgba(255,255,255,0.08);
    border: none; border-radius: 8px;
    color: #eee; cursor: pointer;
    backdrop-filter: blur(10px); font-size: 0.75rem;
  }
  .this-week { margin-top:10px; padding:4px 10px; } /* 상단 약간 여백 */
  .nav-btn { padding:3px 8px; }
  .top-controls {
    display:flex; align-items:center; justify-content:center;
    margin-top:6px; gap:6px;
  }
  .week-label {
    background: rgba(255,255,255,0.07);
    border-radius:10px; padding:4px 10px;
    color:#e4e4e4; font-size:0.75rem;
  }
  .timetable {
    position:relative;
    width:45vw; max-width:450px; height:55vh;
    margin-top:10px; border-radius:18px;
    background:rgba(255,255,255,0.03); backdrop-filter:blur(18px);
    overflow:hidden;
  }
  .day-header {
    position:absolute; text-align:center; font-size:10px;
    font-weight:600; line-height:1.3;
    white-space:pre-line; border-radius:6px;
    width:calc((100% - 35px)/7); height:34px;
    color:rgba(255,255,255,0.6);
    top:3px; /* 상단 여백 약간 추가 */
    padding-top:2px; /* 글자 중앙 정렬 */
  }
  .day-header.today {
    background:rgba(255,255,255,0.3);
    color:#fff; font-weight:700;
    height:32px; padding-top:3px; /* 중심 정렬 */
  }
  .time-label {
    position:absolute; left:0; width:35px;
    text-align:center; font-size:9px; color:rgba(255,255,255,0.6);
  }
  .grid-line {
    position:absolute; left:35px; width:calc(100% - 35px);
    border-top:1px solid rgba(255,255,255,0.05);
  }
  .grid-line.bold { border-top:1.5px solid rgba(255,255,255,0.35); }
  .event {
    position:absolute; border-radius:6px;
    box-shadow:0 3px 6px rgba(0,0,0,0.4);
    backdrop-filter:blur(8px); cursor:pointer;
    transition:all 0.2s ease;
  }
  .tooltip {
    position:absolute; background:rgba(0,0,0,0.85);
    color:#fff; font-size:10px; padding:5px 8px;
    border-radius:6px; white-space:pre-line; line-height:1.4;
    z-index:10; opacity:0; transform:scale(0.95);
    transition:all 0.15s ease;
  }
  .tooltip.active { opacity:1; transform:scale(1); }
  .dot { display:inline-block; width:6px; height:6px; border-radius:50%; margin-right:4px; }
</style>
</head>
<body>
<button class="this-week" id="thisWeek">THIS WEEK</button>
<div class="top-controls">
  <button class="nav-btn" id="prevWeek">←</button>
  <div class="week-label" id="weekLabel"></div>
  <button class="nav-btn" id="nextWeek">→</button>
</div>
<div class="timetable" id="timetable"></div>

<script>
const timetable=document.getElementById("timetable");
const days=["MON","TUE","WED","THU","FRI","SAT","SUN"];
let currentMonday=getMonday(new Date());
const headerHeight=40;
const recurringHolidays=["01-01","03-01","05-05","06-06","08-15","10-03","10-09","12-25"];
const icalUrls=[
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxInlf0nwQRwqVQaKN3oFgWzqLUfigKhteMNDAjQwkPlHzBe_ELV5RYcePFbCOI5H3TM",
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIlkFT1ZEqbRVczq6PrGuVHb0Afa1EhpfGiSULTpK_tYur-eQz2Uqc74JIqfAKkjBP8",
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxImfGB8G7hln8RI2A4WFBMN51g9wFHOsIhQgRFNSx9Dz4_f4s6w0S4RBWQw9Fgtt2mU",
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIks_Phe4DHFMcJQdGTXVekoe7DfsUtHGLCLydgauhnycV_BUoW1c_GcPu0dMkd_m9I"
];
const icalColorMap={0:"rgba(160,210,255,1)",1:"rgba(200,180,255,1)",2:"rgba(61,84,127,1)",3:"rgba(255,255,245,1)"};

function getMonday(d){d=new Date(d);const day=d.getDay();const diff=d.getDate()-day+(day===0?-6:1);return new Date(d.setDate(diff));}
function getWeekNumber(d){const oneJan=new Date(d.getFullYear(),0,1);return Math.ceil((((d-oneJan)/86400000)+oneJan.getDay()+1)/7);}

function renderWeek(monday){
  timetable.innerHTML="";
  const weekLabel=document.getElementById("weekLabel");
  const weekNum=getWeekNumber(monday);
  weekLabel.textContent=`${monday.getFullYear()} : ${weekNum} / 52W`;

  const today=new Date();
  const colWidth=(timetable.offsetWidth-35)/7;
  days.forEach((d,i)=>{
    const date=new Date(monday);
    date.setDate(monday.getDate()+i);
    const header=document.createElement("div");
    header.className="day-header";
    header.style.left=`${35 + i*colWidth}px`;
    const mdKey=`${String(date.getMonth()+1).padStart(2,"0")}-${String(date.getDate()).padStart(2,"0")}`;
    if(recurringHolidays.includes(mdKey)) header.style.color="rgba(255,150,120,0.9)";
    header.textContent=`${String(date.getMonth()+1).padStart(2,"0")}/${String(date.getDate()).padStart(2,"0")}\n${d}`;
    if(date.toDateString()===today.toDateString()) header.classList.add("today");
    timetable.appendChild(header);
  });

  const mainHours=[6,12,18,24];
  const rowHeight=(timetable.offsetHeight-headerHeight)/(24-6);
  for(let h=6;h<=24;h++){
    const y=headerHeight+(h-6)*rowHeight;
    const label=document.createElement("div");
    label.className="time-label";
    label.textContent=mainHours.includes(h)?String(h).padStart(2,"0"):"";
    if(h===24) label.style.top=`${y-8}px`; else label.style.top=`${y-5}px`;
    const line=document.createElement("div");
    line.className=mainHours.includes(h)?"grid-line bold":"grid-line";
    line.style.top=`${y}px`;
    timetable.append(label,line);
  }

  loadICS(icalUrls,monday,today,rowHeight,colWidth);
}

async function loadICS(urls,monday,today,rowHeight,colWidth){
  const sunday=new Date(monday);
  sunday.setDate(monday.getDate()+6);
  sunday.setHours(23,59,59,999);
  for(const [idx,url] of urls.entries()){
    try{
      const res=await fetch(url);
      const text=await res.text();
      parseICS(text,monday,sunday,today,icalColorMap[idx],rowHeight,colWidth);
    }catch(err){console.error("ICS fetch error",err);}
  }
}

function parseICS(ics,monday,sunday,today,color,rowHeight,colWidth){
  const events=ics.split("BEGIN:VEVENT").slice(1).map(e=>"BEGIN:VEVENT"+e);
  events.forEach(ev=>{
    if(ev.includes("VTODO")||ev.includes("VEVENT;VALUE=DATE"))return;
    if(ev.includes("미리 알림")||ev.includes("이동시간"))return;
    const summary=(ev.match(/SUMMARY:(.+)/)||[])[1]?.trim()||"";
    const start=(ev.match(/DTSTART[^:]*:(.+)/)||[])[1];
    const end=(ev.match(/DTEND[^:]*:(.+)/)||[])[1];
    const rrule=(ev.match(/RRULE:(.+)/)||[])[1];
    if(!start||!end)return;
    const baseStart=parseDate(start), baseEnd=parseDate(end);
    if(!baseStart||!baseEnd)return;

    const instances=[];
    if(rrule && rrule.includes("FREQ=WEEKLY")){
      const untilMatch=rrule.match(/UNTIL=([0-9T]+)/);
      const untilDate=untilMatch?parseDate(untilMatch[1]):null;
      for(let i=-52;i<=52;i++){
        const recurStart=new Date(baseStart.getTime()+i*7*86400000);
        const recurEnd=new Date(baseEnd.getTime()+i*7*86400000);
        if(untilDate && recurStart>untilDate) break; // ✅ UNTIL 이후 중단
        if(recurStart>=monday && recurStart<=sunday){
          instances.push({s:recurStart,e:recurEnd});
        }
      }
    } else {
      if(baseStart>=monday && baseStart<=sunday) instances.push({s:baseStart,e:baseEnd});
    }

    instances.forEach(({s,e})=>{
      const dayIndex=(s.getDay()+6)%7;
      const startHour=s.getHours()+s.getMinutes()/60;
      const endHour=e.getHours()+e.getMinutes()/60||24;
      const top=headerHeight+(startHour-6)*rowHeight;
      const height=(endHour-startHour)*rowHeight;
      const left=35+(dayIndex*colWidth);
      const width=colWidth-6;
      const opacity=(s.toDateString()===today.toDateString())?1:0.5;

      const block=document.createElement("div");
      block.className="event";
      block.style.backgroundColor=color;
      block.style.opacity=opacity;
      block.style.top=`${top}px`;
      block.style.left=`${left}px`;
      block.style.height=`${height}px`;
      block.style.width=`${width}px`;

      block.addEventListener("click",e=>{
        e.stopPropagation();
        document.querySelectorAll(".tooltip.active").forEach(t=>t.remove());
        const tooltip=document.createElement("div");
        tooltip.className="tooltip active";
        tooltip.innerHTML=`<span class='dot' style='background:${color}'></span>${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")}\n${summary}`;
        timetable.appendChild(tooltip);
        const rect=block.getBoundingClientRect(),parent=timetable.getBoundingClientRect();
        const forceLeft=(dayIndex>=5); // ✅ 토·일 왼쪽 표시
        let x=forceLeft?rect.left-parent.left-tooltip.offsetWidth-8:rect.right-parent.left+8;
        let y=rect.top-parent.top+rect.height/2-tooltip.offsetHeight/2;
        if(y+tooltip.offsetHeight>timetable.offsetHeight-4)y=timetable.offsetHeight-tooltip.offsetHeight-4;
        if(y<0)y=0;
        tooltip.style.left=`${x}px`;tooltip.style.top=`${y}px`;
      });
      timetable.appendChild(block);
    });
  });
  document.addEventListener("click",()=>document.querySelectorAll(".tooltip.active").forEach(t=>t.remove()));
}

function parseDate(str){
  if(!str)return null;
  if(str.includes("T")){
    const [date,time]=str.split("T");
    const year=date.slice(0,4),month=date.slice(4,6)-1,day=date.slice(6,8);
    const hour=parseInt(time.slice(0,2))||0,min=parseInt(time.slice(2,4))||0;
    return new Date(year,month,day,hour,min);
  }
  return null;
}

document.getElementById("prevWeek").onclick=()=>{currentMonday.setDate(currentMonday.getDate()-7);renderWeek(currentMonday);}
document.getElementById("nextWeek").onclick=()=>{currentMonday.setDate(currentMonday.getDate()+7);renderWeek(currentMonday);}
document.getElementById("thisWeek").onclick=()=>{currentMonday=getMonday(new Date());renderWeek(currentMonday);}
renderWeek(currentMonday);
</script>
</body>
</html>
