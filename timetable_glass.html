<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Timetable (Glass v31)</title>
<style>
  body {
    background: #0d0d0d;
    color: #fff;
    font-family: "Inter", "Pretendard", sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }

  /* 상단 주차 이동 바 */
  .week-nav {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 30px;
    margin: 10px 0 15px;
    color: rgba(255,255,255,0.7);
    font-size: 14px;
    user-select: none;
  }
  .week-nav button {
    background: none;
    border: none;
    color: rgba(255,255,255,0.6);
    font-size: 18px;
    cursor: pointer;
    transition: color 0.2s;
  }
  .week-nav button:hover {
    color: rgba(255,255,255,0.9);
  }

  .timetable {
    display: grid;
    grid-template-columns: 45px repeat(7, 1fr);
    grid-template-rows: 65px repeat(18, 1fr);
    width: 85vw;
    height: 80vh;
    border-radius: 25px;
    background: rgba(30, 30, 30, 0.4);
    backdrop-filter: blur(25px);
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
    position: relative;
    overflow: hidden;
  }

  .day-header {
    text-align: center;
    font-size: 12px;
    font-weight: 600;
    line-height: 1.2;
    padding-top: 10px;
    border-right: 1px solid rgba(255,255,255,0.08);
    white-space: pre-line;
    background: linear-gradient(180deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
    border-radius: 8px;
  }

  .day-header.today {
    background: linear-gradient(180deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.1) 100%);
    box-shadow: inset 0 0 8px rgba(255,255,255,0.25);
  }

  .time-label {
    text-align: right;
    padding-right: 6px;
    font-size: 11px;
    color: rgba(255, 255, 255, 0.6);
  }

  .time-label.bold {
    font-size: 13px;
    font-weight: 700;
    color: rgba(255, 255, 255, 0.9);
  }

  .grid-line {
    grid-column: 2 / span 7;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }
  .grid-line.bold {
    border-top: 1.5px solid rgba(255, 255, 255, 0.15);
  }
  .grid-line.strong {
    border-top: 2.5px solid rgba(255,255,255,0.25);
  }

  .event {
    position: absolute;
    left: calc(45px + (var(--day-index) * (100% / 8)));
    width: calc((100% - 45px) / 8 - 7px);
    border-radius: 10px;
    background: var(--event-color, rgba(120, 160, 255, 0.4));
    backdrop-filter: blur(10px);
    transition: all 0.2s ease;
    box-shadow: 0 3px 6px rgba(0,0,0,0.4);
  }
  .event:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.6);
  }

  .tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 6px;
    white-space: nowrap;
    transform: translate(-50%, -110%);
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
  }
  .event:hover .tooltip {
    opacity: 1;
  }
</style>
</head>
<body>
  <div class="week-nav">
    <button id="prevWeek">←</button>
    <span id="weekRange"></span>
    <button id="nextWeek">→</button>
  </div>

  <div class="timetable" id="timetable"></div>

<script>
const timetable = document.getElementById("timetable");
const weekRange = document.getElementById("weekRange");
let baseDate = new Date();

const days = ["MON","TUE","WED","THU","FRI","SAT","SUN"];
const categoryColors = {
  "업무": "rgba(61, 84, 127, 0.85)",     // 네이비 (#3d547f)
  "건강": "rgba(178, 192, 210, 0.85)",   // 연파랑 (#b2c0d2)
  "자기계발": "rgba(206, 203, 211, 0.85)", // 라벤더그레이 (#cecbd3)
  "휴식": "rgba(243, 241, 235, 0.85)"    // 아이보리 (#f3f1eb)
};
const icalUrls = [
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxInlf0nwQRwqVQaKN3oFgWzqLUfigKhteMNDAjQwkPlHzBe_ELV5RYcePFbCOI5H3TM",
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIlkFT1ZEqbRVczq6PrGuVHb0Afa1EhpfGiSULTpK_tYur-eQz2Uqc74JIqfAKkjBP8",
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxImfGB8G7hln8RI2A4WFBMN51g9wFHOsIhQgRFNSx9Dz4_f4s6w0S4RBWQw9Fgtt2mU",
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p151-caldav.icloud.com/published/2/MjAxNzA0NzQzNTEyMDE3MBESdZX6cJss130QKAIlxIks_Phe4DHFMcJQdGTXVekoe7DfsUtHGLCLydgauhnycV_BUoW1c_GcPu0dMkd_m9I"
];

document.getElementById("prevWeek").onclick = () => changeWeek(-7);
document.getElementById("nextWeek").onclick = () => changeWeek(7);

function changeWeek(diff) {
  baseDate.setDate(baseDate.getDate() + diff);
  renderWeek();
}

function renderWeek() {
  timetable.innerHTML = "";
  const todayIndex = (baseDate.getDay() + 6) % 7;
  const monday = new Date(baseDate);
  monday.setDate(baseDate.getDate() - todayIndex);
  monday.setHours(0,0,0,0);
  const sunday = new Date(monday);
  sunday.setDate(monday.getDate() + 6);
  sunday.setHours(23,59,59,999);

  const rangeText = `${monday.toLocaleString('en-US',{month:'short'})} ${monday.getDate()} - ${sunday.getDate()}`;
  weekRange.textContent = rangeText;

  timetable.appendChild(document.createElement("div"));
  days.forEach((d,i)=>{
    const head=document.createElement("div");
    head.className="day-header"+(i===todayIndex?" today":"");
    const date=new Date(monday);
    date.setDate(monday.getDate()+i);
    const dateStr=`${String(date.getMonth()+1).padStart(2,"0")}/${String(date.getDate()).padStart(2,"0")}\n${d}`;
    head.textContent=dateStr;
    timetable.appendChild(head);
  });

  for(let h=6;h<=24;h++){
    const label=document.createElement("div");
    label.className="time-label"+((h===6||h===9||h===12||h===24)?" bold":"");
    label.textContent=(h===6||h===9||h===12||h===24)?String(h).padStart(2,"0"):"";
    timetable.appendChild(label);
    const line=document.createElement("div");
    line.className="grid-line"+((h===6||h===9||h===12||h===24)?" strong":"");
    timetable.appendChild(line);
  }

  loadICS(icalUrls, monday, sunday);
}

async function loadICS(urls, monday, sunday){
  for(const url of urls){
    try{
      const res=await fetch(url);
      const text=await res.text();
      parseICS(text,monday,sunday);
    }catch(err){console.error("ICS fetch error",err);}
  }
}

function parseICS(ics,monday,sunday){
  const events=ics.split("BEGIN:VEVENT").slice(1).map(e=>"BEGIN:VEVENT"+e);
  events.forEach(ev=>{
    if(ev.includes("VTODO")||ev.includes("VEVENT;VALUE=DATE"))return;
    if(ev.includes("미리 알림")||ev.includes("이동시간"))return;
    const summary=(ev.match(/SUMMARY:(.+)/)||[])[1]?.trim()||"";
    const start=(ev.match(/DTSTART[^:]*:(.+)/)||[])[1];
    const end=(ev.match(/DTEND[^:]*:(.+)/)||[])[1];
    if(!start||!end)return;
    const s=parseDate(start),e=parseDate(end);
    if(!s||!e)return;
    if(s<sunday&&s>=monday){
      const dayIndex=(s.getDay()+6)%7;
      let startHour=s.getHours()+s.getMinutes()/60;
      let endHour=e.getHours()+e.getMinutes()/60;
      if(endHour===0&&e.getDate()>s.getDate())endHour=24;
      if(endHour>24)endHour=24;

      const top=((startHour-6)/18)*100;
      const height=((endHour-startHour)/18)*100;
      const color=Object.entries(categoryColors).find(([k])=>summary.includes(k))?.[1]||"rgba(200,200,255,0.4)";
      const block=document.createElement("div");
      block.className="event";
      block.style.setProperty("--day-index",dayIndex);
      block.style.top=`${top}%`;
      block.style.height=`${height}%`;
      block.style.setProperty("--event-color",color);
      const tooltip=document.createElement("div");
      tooltip.className="tooltip";
      tooltip.textContent=`${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")} ~ ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}  ${summary}`;
      block.appendChild(tooltip);
      timetable.appendChild(block);
    }
  });
}

function parseDate(str){
  if(!str)return null;
  if(str.includes("T")){
    const [date,time]=str.split("T");
    const year=date.slice(0,4),month=date.slice(4,6)-1,day=date.slice(6,8);
    const hour=parseInt(time.slice(0,2)),min=parseInt(time.slice(2,4));
    return new Date(year,month,day,hour,min);
  }
  return null;
}

renderWeek();
</script>
</body>
</html>
