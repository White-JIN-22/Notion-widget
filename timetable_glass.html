<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="robots" content="noindex, nofollow">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Weekly Timetable (Glass v26)</title>
<style>
  body {
    background: #0d0d0d;
    color: #fff;
    font-family: "Inter", "Pretendard", sans-serif;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
    overflow: hidden;
  }

  .timetable {
    display: grid;
    grid-template-columns: 40px repeat(7, 1fr);
    grid-template-rows: 50px repeat(19, 1fr);
    width: 85vw;
    height: 85vh;
    border-radius: 25px;
    background: rgba(30, 30, 30, 0.4);
    backdrop-filter: blur(25px);
    box-shadow: 0 0 40px rgba(0, 0, 0, 0.6);
    overflow: hidden;
    position: relative;
  }

  .day-header {
    text-align: center;
    font-size: 13px;
    font-weight: 600;
    line-height: 50px;
    border-right: 1px solid rgba(255, 255, 255, 0.08);
    background: linear-gradient(180deg, rgba(255,255,255,0.12) 0%, rgba(255,255,255,0.04) 100%);
  }

  .day-header.today {
    background: linear-gradient(180deg, rgba(255,255,255,0.22) 0%, rgba(255,255,255,0.08) 100%);
    color: #fff;
    box-shadow: 0 0 10px rgba(255,255,255,0.25) inset;
  }

  .time-label {
    text-align: right;
    padding-right: 6px;
    font-size: 11px;
    color: rgba(255, 255, 255, 0.6);
  }

  .time-label.bold {
    font-weight: 700;
    color: rgba(255, 255, 255, 0.9);
  }

  .grid-line {
    grid-column: 2 / span 7;
    border-top: 1px solid rgba(255, 255, 255, 0.05);
  }

  .grid-line.bold {
    border-top: 1px solid rgba(255, 255, 255, 0.15);
  }

  .event {
    position: absolute;
    left: calc(40px + (var(--day-index) * (100% / 8)));
    width: calc((100% - 40px) / 8 - 6px);
    border-radius: 8px;
    background: var(--event-color, rgba(120, 160, 255, 0.4));
    backdrop-filter: blur(10px);
    transition: all 0.2s ease;
    box-shadow: 0 3px 6px rgba(0,0,0,0.4);
  }

  .event:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 12px rgba(0,0,0,0.6);
  }

  .tooltip {
    position: absolute;
    background: rgba(0, 0, 0, 0.85);
    color: #fff;
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 6px;
    white-space: nowrap;
    transform: translate(-50%, -110%);
    opacity: 0;
    transition: opacity 0.2s;
    pointer-events: none;
  }

  .event:hover .tooltip {
    opacity: 1;
  }
</style>
</head>
<body>
  <div class="timetable" id="timetable"></div>

<script>
const timetable = document.getElementById("timetable");
const days = ["MON","TUE","WED","THU","FRI","SAT","SUN"];
const now = new Date();
const todayIndex = (now.getDay() + 6) % 7;

// -------------------- UI BUILD --------------------
timetable.appendChild(document.createElement("div"));
days.forEach((d, i) => {
  const head = document.createElement("div");
  head.className = "day-header" + (i === todayIndex ? " today" : "");
  const date = new Date();
  date.setDate(now.getDate() - todayIndex + i);
  const dateStr = `${String(date.getMonth()+1).padStart(2,"0")}/${String(date.getDate()).padStart(2,"0")}`;
  head.textContent = `${dateStr} ${d}`;
  timetable.appendChild(head);
});

for (let h = 6; h <= 24; h++) {
  const label = document.createElement("div");
  label.className = "time-label" + ((h===6||h===12||h===18||h===24) ? " bold" : "");
  label.textContent = String(h).padStart(2,"0");
  timetable.appendChild(label);

  const line = document.createElement("div");
  line.className = "grid-line" + ((h===6||h===12||h===18||h===24) ? " bold" : "");
  timetable.appendChild(line);
}

// -------------------- ics FETCH --------------------
const icalUrls = [
  "https://ical-proxy.moonkelly601.workers.dev/?url=https://p49-caldav.icloud.com/published/2/xxxxxx_your_calendar_url_xxxxxx"
];

// 색상 팔레트 (카테고리별 톤 지정)
const categoryColors = {
  "자기계발": "rgba(160,180,255,0.5)",
  "심리상담": "rgba(255,180,150,0.45)",
  "업무": "rgba(150,200,255,0.45)",
  "건강": "rgba(255,200,120,0.45)",
  "휴식": "rgba(180,255,180,0.4)"
};

async function loadICS(urls) {
  for (const url of urls) {
    const res = await fetch(url);
    const text = await res.text();
    parseICS(text);
  }
}

function parseICS(ics) {
  const events = ics.split("BEGIN:VEVENT").slice(1).map(e => "BEGIN:VEVENT" + e);
  events.forEach(ev => {
    if (ev.includes("X-APPLE-TRAVEL-DURATION") || ev.includes("VTODO") || ev.includes("VEVENT;VALUE=DATE")) return;

    const summary = (ev.match(/SUMMARY:(.+)/) || [])[1]?.trim() || "";
    const start = (ev.match(/DTSTART[^:]*:(.+)/) || [])[1];
    const end = (ev.match(/DTEND[^:]*:(.+)/) || [])[1];

    if (!start || !end || summary.includes("미리 알림")) return;

    const s = parseDate(start);
    const e = parseDate(end);

    if (!s || !e || s.getHours() < 6 || s.getHours() > 24) return;

    const dayIndex = (s.getDay() + 6) % 7;
    const startHour = s.getHours() + s.getMinutes()/60;
    const endHour = e.getHours() + e.getMinutes()/60;
    const top = ((startHour - 6) / 18) * 100;
    const height = ((endHour - startHour) / 18) * 100;

    const color = Object.entries(categoryColors).find(([k]) => summary.includes(k))?.[1]
      || "rgba(200,200,255,0.4)";

    const block = document.createElement("div");
    block.className = "event";
    block.style.setProperty("--day-index", dayIndex);
    block.style.top = `${top}%`;
    block.style.height = `${height}%`;
    block.style.setProperty("--event-color", color);

    const tooltip = document.createElement("div");
    tooltip.className = "tooltip";
    tooltip.textContent = `${s.getHours().toString().padStart(2,"0")}:${s.getMinutes().toString().padStart(2,"0")} ~ ${e.getHours().toString().padStart(2,"0")}:${e.getMinutes().toString().padStart(2,"0")}  ${summary}`;
    block.appendChild(tooltip);
    timetable.appendChild(block);
  });
}

function parseDate(str) {
  if (!str) return null;
  if (str.includes("T")) {
    const [date, time] = str.split("T");
    const year = date.slice(0,4), month = date.slice(4,6)-1, day = date.slice(6,8);
    const hour = parseInt(time.slice(0,2)), min = parseInt(time.slice(2,4));
    return new Date(year, month, day, hour, min);
  }
  return null;
}

loadICS(icalUrls);
</script>
</body>
</html>
